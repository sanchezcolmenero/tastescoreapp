<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TasteScore">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%232563eb'/%3E%3Ctext x='256' y='340' font-size='300' text-anchor='middle' fill='white'%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E">
    <title>TasteScore</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #1a1a1a;
            --accent: #f59e0b;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --border: #e2e8f0;
            --text: #1a1a1a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(37, 99, 235, 0.15);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .header {
            background: var(--bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--primary);
        }
        
        .header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            color: var(--text);
            transition: color 0.15s;
        }
        
        .menu-btn:hover {
            color: var(--primary);
        }
        
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: var(--bg);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 201;
            overflow-y: auto;
        }
        
        .menu-panel.active {
            right: 0;
        }
        
        .menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
        }
        
        .menu-content {
            padding: 1rem;
        }
        
        .menu-item {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }
        
        .menu-item:hover {
            background: var(--bg-secondary);
        }
        
        .menu-item.active {
            background: var(--primary);
            color: white;
        }
        
        .user-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.2s ease;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .btn {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-weight: 500;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            font-family: 'Inter', sans-serif;
            width: 100%;
            background: var(--bg);
            color: var(--text);
        }
        
        .btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-hover);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            border-color: var(--border);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .input-group {
            margin-bottom: 1.25rem;
        }
        
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.15s;
            background: var(--bg);
            color: var(--text);
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .product-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            transition: all 0.15s;
            display: flex;
            gap: 1rem;
            align-items: center;
            cursor: pointer;
        }
        
        .product-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }
        
        .product-item.selected {
            border-color: var(--primary);
            background: var(--bg);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .product-info {
            flex: 1;
            min-width: 0;
        }
        
        .product-item h4 {
            font-weight: 600;
            margin-bottom: 0.2rem;
            font-size: 0.9375rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-item p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-score {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.25rem;
        }
        
        .rating-container {
            margin: 2rem 0;
        }
        
        .rating-slider-container {
            position: relative;
            padding: 1.5rem 0;
        }
        
        .rating-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .rating-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .rating-value {
            text-align: center;
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
            letter-spacing: -0.02em;
            color: var(--primary);
        }
        
        .rating-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }
        
        .participant {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            margin-right: 0.875rem;
        }
        
        .code-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .code-display .code {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 0.3em;
            margin: 0.5rem 0;
            color: white;
        }
        
        .code-display p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
        }
        
        .search-results {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 0.75rem;
        }
        
        .search-result-item {
            padding: 0.875rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }
        
        .result-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .result-card h3 {
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .rating-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .rating-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .avg-score {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin: 1.5rem 0;
            color: var(--primary);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: var(--success);
        }
        
        .status-finished {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border-color: var(--error);
        }
        
        .archive-item {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .archive-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow-hover);
        }
        
        .archive-item h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .archive-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.75rem;
            transition: opacity 0.15s;
        }
        
        .back-btn:hover {
            opacity: 0.6;
        }
        
        .header-content {
            display: flex;
            align-items: center;
        }
        
        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.4;
        }
        
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .scanner-modal.active {
            display: flex;
        }
        
        .scanner-content {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }
        
        .scanner-video {
            width: 100%;
            border-radius: 8px;
            background: var(--bg-secondary);
            margin: 1rem 0;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .manual-product-form {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .product-grid {
            display: grid;
            gap: 0.75rem;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }
        
        .stats-bar p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .edit-mode-banner {
            background: var(--bg-secondary);
            padding: 0.875rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .tab:hover {
            color: var(--text);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .ranking-item {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        
        .ranking-position {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        
        .ranking-position.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        .ranking-position.silver {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
        }
        
        .ranking-position.bronze {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
        }
        
        .social-login {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.875rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 500;
        }
        
        .social-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        
        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: var(--border);
        }
        
        .divider span {
            background: var(--bg);
            padding: 0 1rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="header-content">
                <button class="back-btn" id="backBtn" style="display: none;">‚Üê</button>
                <div>
                    <h1>TasteScore</h1>
                    <p id="headerSubtitle">Catas de productos en grupo</p>
                </div>
            </div>
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
            <h3 style="font-weight: 600;">Men√∫</h3>
            <button class="menu-close" onclick="toggleMenu()">‚úï</button>
        </div>
        
        <div class="user-section" id="userSection">
            <!-- Se llenar√° din√°micamente -->
        </div>
        
        <div class="menu-content">
            <div class="menu-item" onclick="navigateTo('home')">
                <span>üè†</span>
                <span>Inicio</span>
            </div>
            <div class="menu-item" onclick="navigateTo('ranking')">
                <span>üèÜ</span>
                <span>Ranking Global</span>
            </div>
            <div class="menu-item" onclick="navigateTo('myTastings')">
                <span>üìã</span>
                <span>Mis Catas</span>
            </div>
            <div class="menu-item" id="authMenuItem" onclick="navigateTo('auth')">
                <span>üë§</span>
                <span>Iniciar Sesi√≥n</span>
            </div>
            <div class="menu-item" id="logoutMenuItem" style="display: none;" onclick="logout()">
                <span>üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </div>
        </div>
    </div>

    <!-- Modal Esc√°ner de C√≥digo de Barras -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-content">
            <h2 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Escanear C√≥digo de Barras</h2>
            <div id="reader" style="width: 100%; border-radius: 6px; overflow: hidden;"></div>
            <p style="text-align: center; margin: 1rem 0; color: var(--text-secondary); font-size: 0.875rem;">Enfoca el c√≥digo de barras del producto</p>
            <button class="btn btn-secondary" onclick="closeScanner()">Cancelar</button>
        </div>
    </div>

    <!-- Pantalla Inicio -->
    <div class="screen active" id="homeScreen">
        <div class="container">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Bienvenido</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Crea una nueva cata o √∫nete a una existente para empezar a puntuar productos en grupo.</p>
                <button class="btn btn-primary" onclick="showScreen('createScreen')" style="margin-bottom: 0.75rem;">Crear Nueva Cata</button>
                <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Unirse a Cata</button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 1rem; font-weight: 600;">Mis Catas Archivadas</h3>
                <div id="archivedList"></div>
            </div>
        </div>
    </div>

    <!-- Pantalla Ranking Global -->
    <div class="screen" id="rankingScreen">
        <div class="container">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">üèÜ Ranking Global</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9375rem;">Los productos mejor valorados en todas las catas</p>
                
                <div id="rankingList"></div>
            </div>
        </div>
    </div>

    <!-- Pantalla Autenticaci√≥n -->
    <div class="screen" id="authScreen">
        <div class="auth-container">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600; text-align: center;">Inicia Sesi√≥n</h2>
                
                <div class="social-login">
                    <button class="social-btn" onclick="loginWithGoogle()">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continuar con Google
                    </button>
                </div>
                
                <div class="divider">
                    <span>o</span>
                </div>
                
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="authEmail" placeholder="tu@email.com">
                </div>
                
                <div class="input-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button class="btn btn-primary" onclick="loginWithEmail()">Iniciar Sesi√≥n</button>
                
                <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                    ¬øNo tienes cuenta? <a href="#" onclick="toggleAuthMode(); return false;" style="color: var(--primary); text-decoration: none; font-weight: 500;">Reg√≠strate</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Pantalla Mis Catas (para usuarios registrados) -->
    <div class="screen" id="myTastingsScreen">
        <div class="container">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">üìã Mis Catas</h2>
                <div id="userTastingsList"></div>
            </div>
        </div>
    </div>

    <!-- Pantalla Crear Cata -->
    <div class="screen" id="createScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem;">
                <h2 style="margin-bottom: 1.5rem; font-family: 'Playfair Display', serif;">Crear Nueva Cata</h2>
                
                <div class="input-group">
                    <label>Nombre de la Cata</label>
                    <input type="text" id="tastingName" placeholder="Ej: Cata de Quesos Artesanales">
                </div>
                
                <div class="input-group">
                    <label>Tu Nombre</label>
                    <input type="text" id="hostName" placeholder="Tu nombre">
                </div>
                
                <div class="input-group">
                    <label>Descripci√≥n (opcional)</label>
                    <textarea id="tastingDescription" rows="3" placeholder="Detalles sobre la cata..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="createTasting()">Crear Cata</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Unirse a Cata -->
    <div class="screen" id="joinScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem;">
                <h2 style="margin-bottom: 1.5rem; font-family: 'Playfair Display', serif;">Unirse a Cata</h2>
                
                <div class="input-group">
                    <label>C√≥digo de Cata</label>
                    <input type="text" id="joinCode" placeholder="Ej: ABC123" style="text-transform: uppercase;">
                </div>
                
                <div class="input-group">
                    <label>Tu Nombre</label>
                    <input type="text" id="participantName" placeholder="Tu nombre">
                </div>
                
                <button class="btn btn-primary" onclick="joinTasting()">Unirse</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Sala de Espera -->
    <div class="screen" id="waitingScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem;">
                <h2 id="waitingTastingName" style="margin-bottom: 1rem; font-family: 'Playfair Display', serif;"></h2>
                
                <div class="code-display">
                    <p>C√≥digo de invitaci√≥n</p>
                    <div class="code" id="displayCode"></div>
                    <p>Comparte este c√≥digo con los participantes</p>
                </div>
                
                <h3 style="margin: 1.5rem 0 1rem 0;">Participantes</h3>
                <div id="participantsList"></div>
                
                <button class="btn btn-accent" onclick="startTasting()" id="startBtn">Comenzar Cata</button>
            </div>
        </div>
    </div>

    <!-- Pantalla A√±adir Productos -->
    <div class="screen" id="addProductsScreen">
        <div class="container">
            <div class="card">
                <h2 class="section-title">A√±adir Productos</h2>
                
                <div class="input-group">
                    <label>Buscar Producto</label>
                    <input type="text" id="productSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProducts()">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-icon" onclick="openScanner()">
                        <span>üì∑</span>
                        <span>Escanear</span>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualForm()">
                        <span>‚úçÔ∏è</span>
                        <span>Manual</span>
                    </button>
                </div>
                
                <div class="manual-product-form" id="manualProductForm" style="display: none;">
                    <h4 style="margin-bottom: 1rem; font-size: 0.9375rem; font-weight: 600;">A√±adir Producto Manualmente</h4>
                    <div class="input-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="manualProductName" placeholder="Ej: Queso Manchego">
                    </div>
                    <div class="input-group">
                        <label>Marca</label>
                        <input type="text" id="manualProductBrand" placeholder="Ej: Garc√≠a Baquero">
                    </div>
                    <div class="input-group">
                        <label>URL de Imagen (opcional)</label>
                        <input type="text" id="manualProductImage" placeholder="https://...">
                    </div>
                    <button class="btn btn-primary" onclick="addManualProduct()">A√±adir Producto</button>
                </div>
                
                <div class="search-results" id="searchResults"></div>
                
                <div style="margin: 2rem 0;">
                    <h3 class="section-title">Productos A√±adidos (<span id="productCount">0</span>)</h3>
                    <div class="product-grid" id="addedProducts"></div>
                </div>
                
                <button class="btn btn-primary" onclick="finishAddingProducts()">Comenzar Votaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Selecci√≥n de Producto -->
    <div class="screen" id="productSelectionScreen">
        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="margin: 0;">Selecciona un Producto</h2>
                    <button class="btn btn-secondary btn-small" onclick="showEditMode()">Editar Cata</button>
                </div>
                
                <div class="product-grid" id="productSelectionList"></div>
                
                <div class="stats-bar">
                    <p><strong id="votedProductsCount">0</strong> de <strong id="totalProductsCount">0</strong> productos votados</p>
                </div>
                
                <button class="btn btn-primary" onclick="showResults()" style="margin-top: 1rem;">Ver Resultados</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Editar Cata -->
    <div class="screen" id="editCataScreen">
        <div class="container">
            <div class="edit-mode-banner">
                Modo Edici√≥n - A√±ade m√°s productos o elimina existentes
            </div>
            
            <div class="card">
                <h2 class="section-title">A√±adir M√°s Productos</h2>
                
                <div class="input-group">
                    <label>Buscar Producto</label>
                    <input type="text" id="editProductSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProductsEdit()">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-icon" onclick="openScanner()">
                        <span>üì∑</span>
                        <span>Escanear</span>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualFormEdit()">
                        <span>‚úçÔ∏è</span>
                        <span>Manual</span>
                    </button>
                </div>
                
                <div class="manual-product-form" id="manualProductFormEdit" style="display: none;">
                    <h4 style="margin-bottom: 1rem; font-size: 0.9375rem; font-weight: 600;">A√±adir Producto Manualmente</h4>
                    <div class="input-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="editManualProductName" placeholder="Ej: Queso Manchego">
                    </div>
                    <div class="input-group">
                        <label>Marca</label>
                        <input type="text" id="editManualProductBrand" placeholder="Ej: Garc√≠a Baquero">
                    </div>
                    <div class="input-group">
                        <label>URL de Imagen (opcional)</label>
                        <input type="text" id="editManualProductImage" placeholder="https://...">
                    </div>
                    <button class="btn btn-primary" onclick="addManualProductEdit()">A√±adir Producto</button>
                </div>
                
                <div class="search-results" id="editSearchResults"></div>
            </div>
            
            <div class="card">
                <h2 class="section-title">Productos Actuales (<span id="editProductCount">0</span>)</h2>
                <div class="product-grid" id="editProductsList"></div>
            </div>
            
            <button class="btn btn-primary" onclick="exitEditMode()">Volver a la Cata</button>
        </div>
    </div>

    <!-- Pantalla Votaci√≥n -->
    <div class="screen" id="votingScreen">
        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-weight: 600; font-size: 1rem;">Votando Producto</h3>
                    <span class="status-badge status-active">En votaci√≥n</span>
                </div>
                
                <div class="product-item" style="background: var(--bg-secondary); border-color: var(--primary); margin-bottom: 2rem; cursor: default;">
                    <img id="votingProductImage" class="product-image" src="" alt="Producto" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                    <div class="product-info">
                        <h4 id="votingProductName"></h4>
                        <p id="votingProductBrand"></p>
                    </div>
                </div>
                
                <div class="rating-container">
                    <label style="font-weight: 500; display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Tu Puntuaci√≥n</label>
                    <div class="rating-value" id="ratingValue">5.0</div>
                    <div class="rating-slider-container">
                        <input type="range" id="ratingSlider" class="rating-slider" min="0" max="10" step="0.1" value="5.0" oninput="updateRatingValue()">
                        <div class="rating-labels">
                            <span>0</span>
                            <span>5</span>
                            <span>10</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Comentarios (opcional)</label>
                    <textarea id="voteComment" rows="3" placeholder="Tus impresiones sobre el producto..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="submitVote()">Enviar Voto</button>
                
                <div class="stats-bar">
                    <p><strong id="votedCount" style="color: var(--primary);">0</strong> de <strong id="votedTotal">0</strong> participantes han votado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Esperando Votos -->
    <div class="screen" id="waitingVotesScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem; text-align: center;">
                <h2 style="margin-bottom: 1rem; font-family: 'Playfair Display', serif;">Voto Enviado</h2>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Esperando a que todos los participantes voten...</p>
                
                <div class="loading">
                    <div style="font-size: 3rem;">‚è≥</div>
                    <p style="margin-top: 1rem;"><strong id="waitingVotedCount">0</strong> de <strong id="waitingVotedTotal">0</strong> votos recibidos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Resultados -->
    <div class="screen" id="resultsScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem;">
                <h2 style="margin-bottom: 1.5rem; font-family: 'Playfair Display', serif; text-align: center;">Resultados de la Cata</h2>
                <div id="resultsContainer"></div>
                
                <button class="btn btn-accent" onclick="finishTasting()" style="margin-top: 1rem;">Finalizar Cata</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Archivo -->
    <div class="screen" id="archiveScreen">
        <div class="container">
            <div class="card" style="margin-top: 1rem;">
                <h2 id="archiveTastingName" style="margin-bottom: 1rem; font-family: 'Playfair Display', serif;"></h2>
                <p id="archiveDate" style="color: var(--text-light); margin-bottom: 1.5rem;"></p>
                
                <div id="archiveResults"></div>
            </div>
        </div>
    </div>


    <!-- Banner de instalaci√≥n PWA -->
    <div id="installBanner" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid #e2e8f0; padding:1rem; z-index:9999; box-shadow:0 -4px 12px rgba(0,0,0,0.08); animation:slideUp 0.3s ease;">
        <style>@keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }</style>
        <div style="max-width:640px; margin:0 auto; display:flex; align-items:center; gap:0.75rem;">
            <div style="width:48px; height:48px; border-radius:12px; background:#2563eb; display:flex; align-items:center; justify-content:center; font-size:1.5rem; flex-shrink:0;">üçΩÔ∏è</div>
            <div style="flex:1; min-width:0;">
                <p style="font-weight:600; font-size:0.9375rem; margin:0; color:#1a1a1a;">A√±adir TasteScore a tu m√≥vil</p>
                <p style="font-size:0.8125rem; color:#64748b; margin:0.15rem 0 0 0;">Acceso r√°pido desde tu pantalla de inicio</p>
            </div>
            <button id="installBtn" style="background:#2563eb; color:white; border:none; padding:0.6rem 1.1rem; border-radius:8px; font-weight:600; font-size:0.875rem; cursor:pointer; white-space:nowrap; font-family:'Inter',sans-serif;">A√±adir</button>
            <button id="dismissBanner" style="background:none; border:none; color:#94a3b8; font-size:1.25rem; cursor:pointer; padding:0.25rem; line-height:1;">‚úï</button>
        </div>
    </div>

    <!-- iOS Install Instructions Modal -->
    <div id="iosModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:flex-end; justify-content:center;">
        <div style="background:#fff; border-radius:16px 16px 0 0; padding:1.5rem; max-width:500px; width:100%; max-height:60vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1.125rem; font-weight:600;">A√±adir a pantalla de inicio</h3>
                <button id="closeIosModal" style="background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">‚úï</button>
            </div>
            <div style="text-align:center; padding:1rem 0;">
                <div style="font-size:2.5rem; margin-bottom:0.75rem;">üì§</div>
                <p style="color:#1a1a1a; font-weight:500; margin:0 0 0.5rem;">Pulsa el bot√≥n de compartir</p>
                <p style="color:#64748b; font-size:0.875rem; margin:0 0 1rem;">En la barra inferior de Safari</p>
                <div style="background:#f8fafc; border-radius:8px; padding:1rem; border:1px solid #e2e8f0;">
                    <p style="color:#1a1a1a; font-weight:500; margin:0 0 0.25rem; font-size:0.9375rem;">Selecciona "A√±adir a pantalla de inicio"</p>
                    <p style="color:#64748b; font-size:0.8125rem; margin:0;">y aparecer√° como app nativa en tu iPhone</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Estado global de la aplicaci√≥n
        let currentTasting = null;
        let currentUser = null;
        let selectedProductId = null;
        let userVotes = {};
        let searchTimeout = null;
        let html5QrCode = null;
        let globalRanking = {};
        let isAuthMode = 'login'; // 'login' o 'register'

        // Sistema de autenticaci√≥n simple (localStorage)
        let authenticatedUser = null;

        // Inicializar app
        function initApp() {
            checkAuth();
            loadGlobalRanking();
            loadArchivedTastings();
        }

        // Verificar autenticaci√≥n
        function checkAuth() {
            const user = localStorage.getItem('authenticatedUser');
            if (user) {
                authenticatedUser = JSON.parse(user);
                updateUserInterface();
            }
        }

        // Actualizar interfaz de usuario
        function updateUserInterface() {
            const userSection = document.getElementById('userSection');
            const authMenuItem = document.getElementById('authMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            
            if (authenticatedUser) {
                userSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${authenticatedUser.name[0].toUpperCase()}</div>
                        <div>
                            <strong style="font-size: 0.9375rem;">${authenticatedUser.name}</strong>
                            <p style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.1rem;">${authenticatedUser.email}</p>
                        </div>
                    </div>
                `;
                authMenuItem.style.display = 'none';
                logoutMenuItem.style.display = 'flex';
            } else {
                userSection.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem; padding: 1rem;">
                        Inicia sesi√≥n para guardar tus catas
                    </p>
                `;
                authMenuItem.style.display = 'flex';
                logoutMenuItem.style.display = 'none';
            }
        }

        // Login con Google (simulado)
        function loginWithGoogle() {
            const name = prompt('Nombre (simulaci√≥n de Google login):');
            if (name) {
                authenticatedUser = {
                    id: Date.now().toString(),
                    name: name,
                    email: `${name.toLowerCase().replace(/\s/g, '')}@gmail.com`,
                    provider: 'google'
                };
                localStorage.setItem('authenticatedUser', JSON.stringify(authenticatedUser));
                updateUserInterface();
                toggleMenu();
                showScreen('homeScreen');
            }
        }

        // Login con email
        function loginWithEmail() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            
            if (!email || !password) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            if (isAuthMode === 'register') {
                // Registrar nuevo usuario
                const name = email.split('@')[0];
                authenticatedUser = {
                    id: Date.now().toString(),
                    name: name,
                    email: email,
                    provider: 'email'
                };
                localStorage.setItem('authenticatedUser', JSON.stringify(authenticatedUser));
                alert('Cuenta creada exitosamente');
            } else {
                // Login existente (simulado)
                const name = email.split('@')[0];
                authenticatedUser = {
                    id: Date.now().toString(),
                    name: name,
                    email: email,
                    provider: 'email'
                };
                localStorage.setItem('authenticatedUser', JSON.stringify(authenticatedUser));
            }
            
            updateUserInterface();
            showScreen('homeScreen');
            toggleMenu();
        }

        // Alternar modo auth
        function toggleAuthMode() {
            isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
            const title = document.querySelector('#authScreen h2');
            const btnText = document.querySelector('#authScreen .btn-primary');
            const link = document.querySelector('#authScreen a');
            
            if (isAuthMode === 'register') {
                title.textContent = 'Crear Cuenta';
                btnText.textContent = 'Registrarse';
                link.innerHTML = '¬øYa tienes cuenta? <span style="color: var(--primary); font-weight: 500;">Inicia sesi√≥n</span>';
            } else {
                title.textContent = 'Inicia Sesi√≥n';
                btnText.textContent = 'Iniciar Sesi√≥n';
                link.innerHTML = '¬øNo tienes cuenta? <span style="color: var(--primary); font-weight: 500;">Reg√≠strate</span>';
            }
        }

        // Cerrar sesi√≥n
        function logout() {
            localStorage.removeItem('authenticatedUser');
            authenticatedUser = null;
            updateUserInterface();
            toggleMenu();
            showScreen('homeScreen');
        }

        // Toggle menu
        function toggleMenu() {
            const overlay = document.getElementById('menuOverlay');
            const panel = document.getElementById('menuPanel');
            overlay.classList.toggle('active');
            panel.classList.toggle('active');
        }

        // Navegaci√≥n desde men√∫
        function navigateTo(destination) {
            toggleMenu();
            
            switch(destination) {
                case 'home':
                    showScreen('homeScreen');
                    break;
                case 'ranking':
                    loadGlobalRanking();
                    showScreen('rankingScreen');
                    break;
                case 'myTastings':
                    if (!authenticatedUser) {
                        alert('Debes iniciar sesi√≥n para ver tus catas');
                        showScreen('authScreen');
                    } else {
                        loadUserTastings();
                        showScreen('myTastingsScreen');
                    }
                    break;
                case 'auth':
                    showScreen('authScreen');
                    break;
            }
        }

        // Cargar ranking global
        function loadGlobalRanking() {
            globalRanking = JSON.parse(localStorage.getItem('globalRanking') || '{}');
            displayGlobalRanking();
        }

        // Actualizar ranking global
        function updateGlobalRanking(productName, productBrand, productImage, score) {
            const key = `${productName}|${productBrand}`.toLowerCase();
            
            if (!globalRanking[key]) {
                globalRanking[key] = {
                    name: productName,
                    brand: productBrand,
                    image: productImage,
                    totalScore: 0,
                    voteCount: 0,
                    avgScore: 0
                };
            }
            
            globalRanking[key].totalScore += score;
            globalRanking[key].voteCount += 1;
            globalRanking[key].avgScore = globalRanking[key].totalScore / globalRanking[key].voteCount;
            
            // Actualizar imagen si es mejor
            if (productImage && (!globalRanking[key].image || productImage.length > globalRanking[key].image.length)) {
                globalRanking[key].image = productImage;
            }
            
            localStorage.setItem('globalRanking', JSON.stringify(globalRanking));
        }

        // Mostrar ranking global
        function displayGlobalRanking() {
            const container = document.getElementById('rankingList');
            
            const sortedProducts = Object.values(globalRanking)
                .sort((a, b) => b.avgScore - a.avgScore)
                .slice(0, 50);
            
            if (sortedProducts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üèÜ</div><p>A√∫n no hay productos en el ranking.<br>¬°S√© el primero en votar!</p></div>';
                return;
            }
            
            container.innerHTML = sortedProducts.map((product, index) => {
                let positionClass = '';
                if (index === 0) positionClass = 'gold';
                else if (index === 1) positionClass = 'silver';
                else if (index === 2) positionClass = 'bronze';
                
                return `
                    <div class="ranking-item">
                        <div class="ranking-position ${positionClass}">${index + 1}</div>
                        <img src="${product.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                        <div class="product-info">
                            <h4>${product.name}</h4>
                            <p>${product.brand} ‚Ä¢ ${product.voteCount} ${product.voteCount === 1 ? 'voto' : 'votos'}</p>
                        </div>
                        <div class="product-score">${product.avgScore.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // Cargar catas del usuario
        function loadUserTastings() {
            if (!authenticatedUser) return;
            
            const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
            const userTastings = archived.filter(t => 
                t.host === authenticatedUser.name || 
                t.participants.some(p => p.name === authenticatedUser.name)
            );
            
            const container = document.getElementById('userTastingsList');
            
            if (userTastings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>No has participado en ninguna cata todav√≠a</p></div>';
            } else {
                container.innerHTML = userTastings.map((tasting, index) => `
                    <div class="archive-item" onclick="viewArchiveFromIndex(${archived.indexOf(tasting)})">
                        <h3>${tasting.name}</h3>
                        <div class="archive-meta">
                            <span>üìÖ ${new Date(tasting.archivedAt).toLocaleDateString('es-ES')}</span>
                            <span>üë• ${tasting.participants.length} participantes</span>
                            <span>üçΩÔ∏è ${tasting.products.length} productos</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Normalizar nombre de producto para deduplicaci√≥n
        function normalizeProductName(name) {
            return name.toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/[√°√†√§]/g, 'a')
                .replace(/[√©√®√´]/g, 'e')
                .replace(/[√≠√¨√Ø]/g, 'i')
                .replace(/[√≥√≤√∂]/g, 'o')
                .replace(/[√∫√π√º]/g, 'u')
                .trim();
        }

        // Deduplicar y mejorar productos de b√∫squeda
        function deduplicateProducts(products) {
            const seen = new Map();
            
            products.forEach(product => {
                const key = `${normalizeProductName(product.product_name || '')}|${normalizeProductName(product.brands || '')}`;
                
                if (!seen.has(key)) {
                    seen.set(key, product);
                } else {
                    // Si ya existe, mantener la mejor imagen
                    const existing = seen.get(key);
                    if (product.image_url && (!existing.image_url || product.image_url.includes('400') || product.image_url.includes('full'))) {
                        existing.image_url = product.image_url;
                    }
                }
            });
            
            return Array.from(seen.values());
        }

        // Generar c√≥digo aleatorio
        function generateCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Cambiar pantalla
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            const backBtn = document.getElementById('backBtn');
            if (screenId === 'homeScreen') {
                backBtn.style.display = 'none';
                document.getElementById('headerSubtitle').textContent = 'Catas de productos en grupo';
                loadArchivedTastings();
            } else {
                backBtn.style.display = 'block';
                backBtn.onclick = () => {
                    if (currentTasting && currentTasting.status === 'voting') {
                        showProductSelectionScreen();
                    } else {
                        showScreen('homeScreen');
                    }
                };
            }
        }

        // Crear nueva cata
        function createTasting() {
            const name = document.getElementById('tastingName').value.trim();
            const hostName = document.getElementById('hostName').value.trim();
            const description = document.getElementById('tastingDescription').value.trim();
            
            if (!name || !hostName) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }
            
            currentTasting = {
                id: Date.now().toString(),
                code: generateCode(),
                name: name,
                description: description,
                host: hostName,
                participants: [{ name: hostName, isHost: true }],
                products: [],
                votes: {},
                status: 'waiting',
                createdAt: new Date().toISOString(),
                userId: authenticatedUser ? authenticatedUser.id : null
            };
            
            currentUser = { name: hostName, isHost: true };
            
            saveTasting();
            showWaitingRoom();
        }

        // Unirse a cata
        function joinTasting() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            const name = document.getElementById('participantName').value.trim();
            
            if (!code || !name) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            const tasting = loadTastingByCode(code);
            if (!tasting) {
                alert('C√≥digo de cata no encontrado');
                return;
            }
            
            if (tasting.status === 'finished') {
                alert('Esta cata ya ha finalizado');
                return;
            }
            
            currentTasting = tasting;
            currentUser = { name: name, isHost: false };
            
            if (!currentTasting.participants.find(p => p.name === name)) {
                currentTasting.participants.push(currentUser);
                saveTasting();
            }
            
            if (currentTasting.status === 'waiting') {
                showWaitingRoom();
            } else if (currentTasting.status === 'adding_products') {
                alert('El anfitri√≥n est√° a√±adiendo productos. Espera un momento.');
                showWaitingRoom();
            } else if (currentTasting.status === 'voting') {
                showProductSelectionScreen();
            }
        }

        // Mostrar sala de espera
        function showWaitingRoom() {
            document.getElementById('waitingTastingName').textContent = currentTasting.name;
            document.getElementById('displayCode').textContent = currentTasting.code;
            updateParticipantsList();
            
            const startBtn = document.getElementById('startBtn');
            startBtn.style.display = currentUser.isHost ? 'block' : 'none';
            
            showScreen('waitingScreen');
            document.getElementById('headerSubtitle').textContent = 'Sala de espera';
        }

        // Actualizar lista de participantes
        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            list.innerHTML = currentTasting.participants.map(p => `
                <div class="participant">
                    <div class="participant-avatar">${p.name[0].toUpperCase()}</div>
                    <div>
                        <strong>${p.name}</strong>
                        ${p.isHost ? '<span style="color: var(--primary); margin-left: 0.5rem; font-weight: 500;">‚Ä¢ Anfitri√≥n</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        // Iniciar cata
        function startTasting() {
            if (!currentUser.isHost) return;
            
            currentTasting.status = 'adding_products';
            saveTasting();
            showScreen('addProductsScreen');
            document.getElementById('headerSubtitle').textContent = 'A√±adir productos';
            updateAddedProducts();
        }

        // Abrir esc√°ner de c√≥digo de barras
        function openScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.add('active');
            
            html5QrCode = new Html5Qrcode("reader");
            
            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length) {
                    const cameraId = cameras[cameras.length - 1].id;
                    
                    html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText, decodedResult) => {
                            html5QrCode.stop();
                            closeScanner();
                            searchProductByBarcode(decodedText);
                        },
                        (errorMessage) => {
                            // Errores normales de escaneo, ignorar
                        }
                    ).catch(err => {
                        console.error("Error starting scanner:", err);
                        alert('No se pudo acceder a la c√°mara');
                        closeScanner();
                    });
                } else {
                    alert('No se encontraron c√°maras en el dispositivo');
                    closeScanner();
                }
            }).catch(err => {
                console.error("Error getting cameras:", err);
                alert('No se pudo acceder a la c√°mara');
                closeScanner();
            });
        }

        // Cerrar esc√°ner
        function closeScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.error(err));
                html5QrCode = null;
            }
            document.getElementById('scannerModal').classList.remove('active');
        }

        // Buscar producto por c√≥digo de barras
        async function searchProductByBarcode(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    addProduct({
                        name: product.product_name || 'Producto sin nombre',
                        brand: product.brands || 'Marca desconocida',
                        image: product.image_url || ''
                    });
                } else {
                    alert('Producto no encontrado. Puedes a√±adirlo manualmente.');
                }
            } catch (error) {
                console.error('Error buscando producto:', error);
                alert('Error al buscar el producto. Intenta a√±adirlo manualmente.');
            }
        }

        // Mostrar/ocultar formulario manual
        function toggleManualForm() {
            const form = document.getElementById('manualProductForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function toggleManualFormEdit() {
            const form = document.getElementById('manualProductFormEdit');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // A√±adir producto manual
        function addManualProduct() {
            const name = document.getElementById('manualProductName').value.trim();
            const brand = document.getElementById('manualProductBrand').value.trim();
            const image = document.getElementById('manualProductImage').value.trim();
            
            if (!name || !brand) {
                alert('Por favor, completa al menos el nombre y la marca');
                return;
            }
            
            addProduct({ name, brand, image });
            
            document.getElementById('manualProductName').value = '';
            document.getElementById('manualProductBrand').value = '';
            document.getElementById('manualProductImage').value = '';
            toggleManualForm();
        }

        function addManualProductEdit() {
            const name = document.getElementById('editManualProductName').value.trim();
            const brand = document.getElementById('editManualProductBrand').value.trim();
            const image = document.getElementById('editManualProductImage').value.trim();
            
            if (!name || !brand) {
                alert('Por favor, completa al menos el nombre y la marca');
                return;
            }
            
            addProduct({ name, brand, image });
            
            document.getElementById('editManualProductName').value = '';
            document.getElementById('editManualProductBrand').value = '';
            document.getElementById('editManualProductImage').value = '';
            toggleManualFormEdit();
            updateEditProductsList();
        }

        // Buscar productos en Open Food Facts
        async function searchProducts() {
            const query = document.getElementById('productSearch').value.trim();
            
            if (query.length < 3) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url`);
                    const data = await response.json();
                    
                    const resultsDiv = document.getElementById('searchResults');
                    if (data.products && data.products.length > 0) {
                        const uniqueProducts = deduplicateProducts(data.products);
                        
                        resultsDiv.innerHTML = uniqueProducts.slice(0, 10).map(product => `
                            <div class="search-result-item" onclick='addProduct(${JSON.stringify({
                                name: product.product_name || 'Producto sin nombre',
                                brand: product.brands || 'Marca desconocida',
                                image: product.image_url || ''
                            }).replace(/'/g, "&apos;")})'>
                                <img src="${product.image_url || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                                <div class="product-info">
                                    <strong>${product.product_name || 'Producto sin nombre'}</strong>
                                    <p>${product.brands || 'Marca desconocida'}</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1.5rem;">No se encontraron productos</p>';
                    }
                } catch (error) {
                    console.error('Error buscando productos:', error);
                    document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: var(--error); padding: 1.5rem;">Error al buscar productos</p>';
                }
            }, 300);
        }

        async function searchProductsEdit() {
            const query = document.getElementById('editProductSearch').value.trim();
            
            if (query.length < 3) {
                document.getElementById('editSearchResults').innerHTML = '';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url`);
                    const data = await response.json();
                    
                    const resultsDiv = document.getElementById('editSearchResults');
                    if (data.products && data.products.length > 0) {
                        const uniqueProducts = deduplicateProducts(data.products);
                        
                        resultsDiv.innerHTML = uniqueProducts.slice(0, 10).map(product => `
                            <div class="search-result-item" onclick='addProductFromEdit(${JSON.stringify({
                                name: product.product_name || 'Producto sin nombre',
                                brand: product.brands || 'Marca desconocida',
                                image: product.image_url || ''
                            }).replace(/'/g, "&apos;")})'>
                                <img src="${product.image_url || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                                <div class="product-info">
                                    <strong>${product.product_name || 'Producto sin nombre'}</strong>
                                    <p>${product.brands || 'Marca desconocida'}</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1.5rem;">No se encontraron productos</p>';
                    }
                } catch (error) {
                    console.error('Error buscando productos:', error);
                    document.getElementById('editSearchResults').innerHTML = '<p style="text-align: center; color: var(--error); padding: 1.5rem;">Error al buscar productos</p>';
                }
            }, 300);
        }

        // A√±adir producto
        function addProduct(product) {
            if (!currentTasting.products.find(p => p.name === product.name && p.brand === product.brand)) {
                currentTasting.products.push({
                    id: Date.now().toString(),
                    ...product
                });
                saveTasting();
                updateAddedProducts();
                document.getElementById('productSearch').value = '';
                document.getElementById('searchResults').innerHTML = '';
            }
        }

        function addProductFromEdit(product) {
            if (!currentTasting.products.find(p => p.name === product.name && p.brand === product.brand)) {
                currentTasting.products.push({
                    id: Date.now().toString(),
                    ...product
                });
                saveTasting();
                updateEditProductsList();
                document.getElementById('editProductSearch').value = '';
                document.getElementById('editSearchResults').innerHTML = '';
            }
        }

        // Actualizar productos a√±adidos
        function updateAddedProducts() {
            const container = document.getElementById('addedProducts');
            document.getElementById('productCount').textContent = currentTasting.products.length;
            
            if (currentTasting.products.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì¶</div><p>A√∫n no has a√±adido productos</p></div>';
            } else {
                container.innerHTML = currentTasting.products.map((p, i) => `
                    <div class="product-item">
                        <img src="${p.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                        <div class="product-info">
                            <h4>${p.name}</h4>
                            <p>${p.brand}</p>
                        </div>
                        <button onclick="removeProduct(${i})" class="btn btn-small" style="background: var(--error); color: white; border-color: var(--error);">Eliminar</button>
                    </div>
                `).join('');
            }
        }

        // Eliminar producto
        function removeProduct(index) {
            currentTasting.products.splice(index, 1);
            saveTasting();
            updateAddedProducts();
        }

        function removeProductFromEdit(index) {
            const product = currentTasting.products[index];
            if (currentTasting.votes[product.id] && currentTasting.votes[product.id].length > 0) {
                alert('No puedes eliminar un producto que ya tiene votos');
                return;
            }
            currentTasting.products.splice(index, 1);
            saveTasting();
            updateEditProductsList();
        }

        // Finalizar a√±adir productos
        function finishAddingProducts() {
            if (currentTasting.products.length === 0) {
                alert('Debes a√±adir al menos un producto');
                return;
            }
            
            currentTasting.status = 'voting';
            saveTasting();
            showProductSelectionScreen();
        }

        // Mostrar pantalla de selecci√≥n de productos
        function showProductSelectionScreen() {
            updateProductSelectionList();
            showScreen('productSelectionScreen');
            document.getElementById('headerSubtitle').textContent = 'Selecciona un producto';
        }

        // Actualizar lista de selecci√≥n de productos
        function updateProductSelectionList() {
            const container = document.getElementById('productSelectionList');
            const votedProducts = Object.keys(userVotes).length;
            
            document.getElementById('votedProductsCount').textContent = votedProducts;
            document.getElementById('totalProductsCount').textContent = currentTasting.products.length;
            
            container.innerHTML = currentTasting.products.map(p => {
                const hasVoted = userVotes[p.id];
                return `
                    <div class="product-item ${hasVoted ? 'selected' : ''}" onclick="${hasVoted ? '' : `selectProduct('${p.id}')`}" style="${hasVoted ? 'cursor: default; opacity: 0.6;' : ''}">
                        <img src="${p.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                        <div class="product-info">
                            <h4>${p.name}</h4>
                            <p>${p.brand}</p>
                        </div>
                        ${hasVoted ? '<span style="color: var(--success); font-weight: 600; font-size: 0.875rem;">‚úì Votado</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        // Seleccionar producto para votar
        function selectProduct(productId) {
            selectedProductId = productId;
            showVotingScreen();
        }

        // Actualizar valor del rating
        function updateRatingValue() {
            const value = parseFloat(document.getElementById('ratingSlider').value);
            document.getElementById('ratingValue').textContent = value.toFixed(1);
        }

        // Mostrar pantalla de votaci√≥n
        function showVotingScreen() {
            const product = currentTasting.products.find(p => p.id === selectedProductId);
            if (!product) return;
            
            document.getElementById('votingProductName').textContent = product.name;
            document.getElementById('votingProductBrand').textContent = product.brand;
            document.getElementById('votingProductImage').src = product.image || '';
            
            // Reset rating slider
            document.getElementById('ratingSlider').value = 5.0;
            updateRatingValue();
            document.getElementById('voteComment').value = '';
            updateVoteCount();
            
            showScreen('votingScreen');
            document.getElementById('headerSubtitle').textContent = 'Votar producto';
        }

        // Enviar voto
        function submitVote() {
            const score = parseFloat(document.getElementById('ratingSlider').value);
            const comment = document.getElementById('voteComment').value.trim();
            const product = currentTasting.products.find(p => p.id === selectedProductId);
            
            if (!currentTasting.votes[selectedProductId]) {
                currentTasting.votes[selectedProductId] = [];
            }
            
            // Remover voto anterior del usuario si existe
            currentTasting.votes[selectedProductId] = currentTasting.votes[selectedProductId].filter(v => v.user !== currentUser.name);
            
            currentTasting.votes[selectedProductId].push({
                user: currentUser.name,
                score: score,
                comment: comment
            });
            
            userVotes[selectedProductId] = true;
            
            // Actualizar ranking global
            updateGlobalRanking(product.name, product.brand, product.image, score);
            
            saveTasting();
            showProductSelectionScreen();
        }

        // Actualizar contador de votos
        function updateVoteCount() {
            const votes = currentTasting.votes[selectedProductId] || [];
            document.getElementById('votedCount').textContent = votes.length;
            document.getElementById('votedTotal').textContent = currentTasting.participants.length;
        }

        // Mostrar modo edici√≥n
        function showEditMode() {
            if (!currentUser.isHost) {
                alert('Solo el anfitri√≥n puede editar la cata');
                return;
            }
            updateEditProductsList();
            showScreen('editCataScreen');
            document.getElementById('headerSubtitle').textContent = 'Editar cata';
        }

        // Actualizar lista de productos en modo edici√≥n
        function updateEditProductsList() {
            const container = document.getElementById('editProductsList');
            document.getElementById('editProductCount').textContent = currentTasting.products.length;
            
            container.innerHTML = currentTasting.products.map((p, i) => {
                const hasVotes = currentTasting.votes[p.id] && currentTasting.votes[p.id].length > 0;
                return `
                    <div class="product-item">
                        <img src="${p.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                        <div class="product-info">
                            <h4>${p.name}</h4>
                            <p>${p.brand}</p>
                            ${hasVotes ? `<p style="color: var(--success); font-size: 0.75rem; margin-top: 0.25rem;">‚úì ${currentTasting.votes[p.id].length} votos</p>` : ''}
                        </div>
                        <button onclick="removeProductFromEdit(${i})" class="btn btn-small" style="background: var(--error); color: white; border-color: var(--error);" ${hasVotes ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Eliminar</button>
                    </div>
                `;
            }).join('');
        }

        // Salir del modo edici√≥n
        function exitEditMode() {
            showProductSelectionScreen();
        }

        // Mostrar resultados
        function showResults() {
            currentTasting.status = 'finished';
            saveTasting();
            
            const container = document.getElementById('resultsContainer');
            container.innerHTML = currentTasting.products.map(product => {
                const votes = currentTasting.votes[product.id] || [];
                const avgScore = votes.length > 0 ? votes.reduce((sum, v) => sum + v.score, 0) / votes.length : 0;
                
                return `
                    <div class="result-card">
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <img src="${product.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                            <div>
                                <h3>${product.name}</h3>
                                <p style="color: var(--text-secondary);">${product.brand}</p>
                            </div>
                        </div>
                        <div class="avg-score">${avgScore.toFixed(1)}</div>
                        
                        ${votes.length > 0 ? `
                            <h4 style="margin: 1.5rem 0 1rem 0; font-size: 0.875rem; font-weight: 600;">Puntuaciones Individuales</h4>
                            ${votes.map(v => `
                                <div class="rating-result">
                                    <div>
                                        <strong>${v.user}</strong>
                                        ${v.comment ? `<p style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.25rem;">${v.comment}</p>` : ''}
                                    </div>
                                    <div class="rating-score">${v.score.toFixed(1)}</div>
                                </div>
                            `).join('')}
                        ` : '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No hay votos para este producto</p>'}
                    </div>
                `;
            }).join('');
            
            showScreen('resultsScreen');
            document.getElementById('headerSubtitle').textContent = 'Resultados finales';
        }

        // Finalizar cata
        function finishTasting() {
            archiveTasting();
            currentTasting = null;
            currentUser = null;
            userVotes = {};
            showScreen('homeScreen');
        }

        // Guardar cata
        function saveTasting() {
            const tastings = JSON.parse(localStorage.getItem('tastings') || '{}');
            tastings[currentTasting.code] = currentTasting;
            localStorage.setItem('tastings', JSON.stringify(tastings));
        }

        // Cargar cata por c√≥digo
        function loadTastingByCode(code) {
            const tastings = JSON.parse(localStorage.getItem('tastings') || '{}');
            return tastings[code];
        }

        // Archivar cata
        function archiveTasting() {
            const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
            archived.unshift({
                ...currentTasting,
                archivedAt: new Date().toISOString()
            });
            localStorage.setItem('archivedTastings', JSON.stringify(archived));
        }

        // Cargar catas archivadas
        function loadArchivedTastings() {
            const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
            const container = document.getElementById('archivedList');
            
            if (archived.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìÇ</div><p>No tienes catas archivadas</p></div>';
            } else {
                container.innerHTML = archived.slice(0, 5).map((tasting, index) => `
                    <div class="archive-item" onclick="viewArchive(${index})">
                        <h3>${tasting.name}</h3>
                        <div class="archive-meta">
                            <span>üìÖ ${new Date(tasting.archivedAt).toLocaleDateString('es-ES')}</span>
                            <span>üë• ${tasting.participants.length} participantes</span>
                            <span>üçΩÔ∏è ${tasting.products.length} productos</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Ver archivo
        function viewArchive(index) {
            viewArchiveFromIndex(index);
        }

        function viewArchiveFromIndex(index) {
            const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
            const tasting = archived[index];
            
            document.getElementById('archiveTastingName').textContent = tasting.name;
            document.getElementById('archiveDate').textContent = `Finalizada el ${new Date(tasting.archivedAt).toLocaleDateString('es-ES')}`;
            
            const container = document.getElementById('archiveResults');
            container.innerHTML = tasting.products.map(product => {
                const votes = tasting.votes[product.id] || [];
                const avgScore = votes.length > 0 ? votes.reduce((sum, v) => sum + v.score, 0) / votes.length : 0;
                
                return `
                    <div class="result-card">
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <img src="${product.image || ''}" class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E'">
                            <div>
                                <h3>${product.name}</h3>
                                <p style="color: var(--text-secondary);">${product.brand}</p>
                            </div>
                        </div>
                        <div class="avg-score">${avgScore.toFixed(1)}</div>
                        
                        ${votes.length > 0 ? `
                            <h4 style="margin: 1.5rem 0 1rem 0; font-size: 0.875rem; font-weight: 600;">Puntuaciones Individuales</h4>
                            ${votes.map(v => `
                                <div class="rating-result">
                                    <div>
                                        <strong>${v.user}</strong>
                                        ${v.comment ? `<p style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.25rem;">${v.comment}</p>` : ''}
                                    </div>
                                    <div class="rating-score">${v.score.toFixed(1)}</div>
                                </div>
                            `).join('')}
                        ` : '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No hay votos para este producto</p>'}
                    </div>
                `;
            }).join('');
            
            showScreen('archiveScreen');
            document.getElementById('headerSubtitle').textContent = 'Cata archivada';
        }

        // Inicializar al cargar
        initApp();

        // ===== PWA: Service Worker Registration =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('[PWA] Service Worker registrado:', reg.scope))
                    .catch(err => console.error('[PWA] Error registrando SW:', err));
            });
        }

        // ===== PWA: Install Banner =====
        let deferredPrompt = null;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const dismissBanner = document.getElementById('dismissBanner');
        const iosModal = document.getElementById('iosModal');
        const closeIosModal = document.getElementById('closeIosModal');

        // Detectar si es iOS
        function isIOS() {
            return /iphone|ipad|ipod/i.test(navigator.userAgent);
        }

        // Detectar si ya fue instalada como PWA
        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        }

        // Android / Chrome: capturar evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Mostrar banner solo si no fue descartado antes
            if (!sessionStorage.getItem('pwa-banner-dismissed')) {
                installBanner.style.display = 'block';
            }
        });

        // Bot√≥n "A√±adir" en el banner
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                installBanner.style.display = 'none';
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('[PWA] Resultado instalaci√≥n:', outcome);
                deferredPrompt = null;
            }
        });

        // Descartar banner
        dismissBanner.addEventListener('click', () => {
            installBanner.style.display = 'none';
            sessionStorage.setItem('pwa-banner-dismissed', 'true');
        });

        // iOS: mostrar modal con instrucciones si no est√° en standalone
        closeIosModal.addEventListener('click', () => {
            iosModal.style.display = 'none';
        });

        // En iOS no hay beforeinstallprompt, as√≠ que mostramos el modal manualmente
        window.addEventListener('load', () => {
            if (isIOS() && !isInStandaloneMode() && !sessionStorage.getItem('pwa-banner-dismissed')) {
                // Peque√±o delay para que la app se cargue primero
                setTimeout(() => {
                    iosModal.style.display = 'flex';
                }, 2000);
            }
        });
    </script>
</body>
</html>
