<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TasteScore">
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=2">
    <link rel="manifest" href="manifest.json?v=2">
    <title>TasteScore</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uhrdphpbmulaudexubgd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocmRwaHBibXVsYXVkZXh1YmdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMzU5NjMsImV4cCI6MjA4NTYxMTk2M30.6zzcr37VmDeXwVCP18m9cx-vQjJf7Z6ZstOEWUNONpw';
        const {createClient} = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#2563eb; --primary-dark:#1e40af; --primary-light:#3b82f6;
            --accent:#f59e0b; --bg:#ffffff; --bg-secondary:#f8fafc;
            --bg-tertiary:#e2e8f0; --border:#e2e8f0; --text:#1a1a1a;
            --text-secondary:#64748b; --text-tertiary:#94a3b8;
            --success:#10b981; --error:#ef4444;
            --shadow:rgba(0,0,0,0.05); --shadow-hover:rgba(37,99,235,0.15);
        }
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:#e2e8f0; color:var(--text); line-height:1.6;
            min-height:100vh; -webkit-font-smoothing:antialiased;
            padding-bottom:72px;
        }
        .app-wrapper { max-width:480px; margin:0 auto; background:var(--bg-secondary); min-height:100vh; box-shadow:0 0 0 1px rgba(0,0,0,0.05); }
        @media (max-width: 480px) {
            .app-wrapper { box-shadow:none; }
        }
        .container { padding:1rem; }
        /* HEADER */
        .header { background:rgba(255,255,255,0.95); padding:1rem; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; backdrop-filter:blur(10px); }
        .header-inner { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .header h1 { font-size:1.5rem; font-weight:700; letter-spacing:-0.02em; color:var(--primary); }
        .header p { font-size:0.875rem; color:var(--text-secondary); }
        .header-content { display:flex; align-items:center; }
        .header-profile { width:40px; height:40px; border-radius:50%; overflow:hidden; cursor:pointer; border:2px solid var(--border); transition:all 0.2s; display:flex; align-items:center; justify-content:center; background:white; }
        .header-profile:hover { border-color:var(--primary); transform:scale(1.05); }
        .header-profile img { width:100%; height:100%; object-fit:cover; }
        .header-profile svg { color:var(--text-secondary); }
        .back-btn { background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; padding:0.5rem; margin-right:0.75rem; }
        .back-btn:hover { opacity:0.6; }
        /* BOTTOM NAV */
        #bottomNav { position:fixed; bottom:0; left:0; right:0; height:64px; background:#fff; border-top:1px solid var(--border); display:flex; justify-content:space-around; align-items:center; z-index:500; box-shadow:0 -2px 10px rgba(0,0,0,0.06); }
        .nav-btn { display:flex; flex-direction:column; align-items:center; gap:2px; background:none; border:none; cursor:pointer; color:var(--text-secondary); font-size:0.6875rem; font-weight:500; padding:6px 10px; border-radius:8px; transition:color 0.15s; font-family:'Inter',sans-serif; flex:1; }
        .nav-btn svg { transition:stroke 0.15s; }
        .nav-btn:hover,.nav-btn.active { color:var(--primary); }
        .nav-btn.active svg { stroke:var(--primary); }
        /* SCREENS */
        .screen { display:none; animation:fadeIn 0.2s ease; }
        .screen.active { display:block; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateX(-50%) translateY(20px);} to{opacity:1;transform:translateX(-50%) translateY(0);} }
        @keyframes slideDown { from{opacity:1;transform:translateX(-50%) translateY(0);} to{opacity:0;transform:translateX(-50%) translateY(20px);} }
        .container { max-width:640px; margin:0 auto; padding:1.5rem 1rem; }
        /* CARDS & BUTTONS */
        .card { background:var(--bg); border-radius:12px; padding:1.5rem; margin-bottom:1rem; border:1px solid var(--border); box-shadow:0 1px 3px var(--shadow); }
        .btn { display:inline-block; padding:0.875rem 1.5rem; border-radius:8px; border:1px solid var(--border); font-weight:500; font-size:0.9375rem; cursor:pointer; transition:all 0.15s; text-align:center; font-family:'Inter',sans-serif; width:100%; background:var(--bg); color:var(--text); }
        .btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .btn-primary { background:var(--primary); color:white; border-color:var(--primary); }
        .btn-primary:hover { background:var(--primary-dark); border-color:var(--primary-dark); transform:translateY(-1px); box-shadow:0 4px 12px var(--shadow-hover); }
        .btn-secondary { background:var(--bg-secondary); border-color:var(--border); }
        .btn-small { padding:0.5rem 1rem; font-size:0.875rem; }
        .btn-icon { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; }
        .btn-group { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; }
        /* INPUTS */
        .input-group { margin-bottom:1.25rem; }
        .input-group label { display:block; font-weight:500; margin-bottom:0.5rem; color:var(--text); font-size:0.875rem; }
        .input-group input,.input-group textarea,.input-group select { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:8px; font-size:0.9375rem; font-family:'Inter',sans-serif; transition:all 0.15s; background:var(--bg); color:var(--text); }
        .input-group select { cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2364748b' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 0.75rem center; padding-right:2.5rem; }
        .input-group input:focus,.input-group textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        /* PRODUCTS ‚Äì overflow fix */
        .product-item { background:var(--bg-secondary); padding:1rem; border-radius:8px; margin-bottom:0.75rem; border:1px solid var(--border); transition:all 0.15s; display:flex; gap:0.75rem; align-items:center; cursor:pointer; }
        .drag-handle { width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:grab; color:var(--text-tertiary); flex-shrink:0; font-size:1.1rem; transition:color 0.2s; }
        .drag-handle:hover { color:var(--primary); }
        .drag-handle:active { cursor:grabbing; }
        .product-item.dragging { opacity:0.4; transform:scale(1.05); box-shadow:0 8px 24px rgba(37,99,235,0.3); border-color:var(--primary); background:var(--bg); }
        .product-item.ghost { opacity:0.5; background:var(--bg-tertiary); }
        .product-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .product-item.selected { border-color:var(--primary); background:var(--bg); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        .product-image { width:56px; height:56px; border-radius:6px; object-fit:cover; background:var(--bg-tertiary); border:1px solid var(--border); flex-shrink:0; }
        .product-info { flex:1; min-width:0; overflow:hidden; }
        .product-info h4 { font-weight:600; font-size:0.9rem; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; margin-bottom:0.15rem; }
        .product-info p { font-size:0.78rem; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .product-score { font-weight:700; color:var(--primary); font-size:1.25rem; flex-shrink:0; }
        .product-grid { display:grid; gap:0.75rem; }
        /* RATING */
        .rating-container { margin:2rem 0; }
        .rating-slider-container { position:relative; padding:2rem 0 1.5rem; }
        .rating-slider { 
            width:100%; 
            height:8px; 
            border-radius:4px; 
            background:linear-gradient(to right, #dc2626 0%, #ef4444 12.5%, #f97316 25%, #f97316 50%, #eab308 62.5%, #22c55e 100%); 
            outline:none; 
            -webkit-appearance:none; 
            appearance:none; 
        }
        .rating-slider::-webkit-slider-thumb { 
            -webkit-appearance:none; 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            background:white; 
            cursor:pointer; 
            border:3px solid var(--primary); 
            box-shadow:0 2px 12px rgba(0,0,0,0.2); 
            transition: all 0.2s;
        }
        .rating-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow:0 4px 16px rgba(0,0,0,0.3);
        }
        .rating-slider::-moz-range-thumb { 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            background:white; 
            cursor:pointer; 
            border:3px solid var(--primary); 
            box-shadow:0 2px 12px rgba(0,0,0,0.2); 
        }
        .rating-value-popup {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translate(-50%, 0);
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.25rem 0.6rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 10;
            line-height: 1.2;
        }
        .rating-value-popup::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #e5e7eb;
        }
        .rating-value { 
            text-align:center; 
            font-size:3rem; 
            font-weight:700; 
            margin:1rem 0; 
            transition: all 0.3s ease;
        }
        .rating-labels { display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-tertiary); margin-top:0.5rem; }
        /* PARTICIPANTS */
        .participant { display:flex; align-items:center; padding:0.7rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); gap:0.75rem; }
        .participant-avatar { width:36px; height:36px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.9rem; color:white; flex-shrink:0; }
        .participant-info { flex:1; min-width:0; }
        .participant-actions { display:flex; gap:0.35rem; flex-shrink:0; }
        .participant-actions button { background:none; border:1px solid var(--border); border-radius:6px; padding:0.25rem 0.5rem; font-size:0.7rem; cursor:pointer; font-family:'Inter',sans-serif; color:var(--text-secondary); transition:all 0.15s; white-space:nowrap; }
        .participant-actions button:hover { border-color:var(--primary); color:var(--primary); }
        .participant-actions .btn-kick:hover { border-color:var(--error); color:var(--error); }
        /* CODE DISPLAY */
        .code-display { background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); padding:1.5rem; border-radius:12px; text-align:center; margin:1.25rem 0; box-shadow:0 4px 12px rgba(37,99,235,0.2); }
        .code-display .code { font-size:2.25rem; font-weight:700; letter-spacing:0.3em; margin:0.4rem 0; color:white; }
        .code-display p { color:rgba(255,255,255,0.9); font-size:0.825rem; }
        /* SEARCH */
        .search-results { max-height:350px; overflow-y:auto; margin-top:0.75rem; }
        .search-result-item { padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.15s; border:1px solid var(--border); display:flex; gap:0.75rem; align-items:center; }
        .search-result-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .search-result-item .product-info h4,.search-result-item .product-info strong { font-weight:600; font-size:0.9rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
        /* RESULTS */
        .result-card { 
            background:var(--bg); 
            border-radius:12px; 
            padding:1.5rem; 
            margin-bottom:1rem; 
            border:1px solid var(--border); 
            box-shadow:0 1px 3px var(--shadow); 
            transition: all 0.3s ease;
        }
        .result-card.collapsed {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .result-card.collapsed:hover {
            background: var(--bg-secondary);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .result-card-compact {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .result-card-compact .product-image {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }
        .result-card-compact-info {
            flex: 1;
            min-width: 0;
        }
        .result-card-compact-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 0.15rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .result-card-compact-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .result-card-compact-score {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }
        .result-card-arrow {
            font-size: 1.2rem;
            color: var(--text-tertiary);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .result-card.collapsed .result-card-arrow {
            transform: rotate(0deg);
        }
        .result-card:not(.collapsed) .result-card-arrow {
            transform: rotate(90deg);
        }
        .result-card-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        .result-card:not(.collapsed) .result-card-details {
            display: block;
        }
        .result-card h3 { margin-bottom:0.75rem; font-size:1.05rem; font-weight:600; word-break:break-word; }
        .rating-result { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
        .rating-score { font-size:1.5rem; font-weight:700; color:var(--primary); flex-shrink:0; }
        .avg-score { 
            font-size:3rem; 
            font-weight:700; 
            text-align:center; 
            margin:1.5rem 0; 
            color:white; 
            padding:0.5rem 1rem; 
            border-radius:12px; 
            display:inline-block; 
            min-width:120px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* BADGES */
        .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:6px; font-size:0.75rem; font-weight:500; border:1px solid; }
        .status-active { background:rgba(16,185,129,0.1); color:var(--success); border-color:var(--success); }
        /* ARCHIVE */
        .archive-item { background:var(--bg); padding:1.25rem; border-radius:12px; margin-bottom:0.75rem; border:1px solid var(--border); cursor:pointer; transition:all 0.15s; display:flex; gap:0.75rem; align-items:flex-start; }
        .archive-item:hover { border-color:var(--primary); box-shadow:0 4px 12px var(--shadow-hover); }
        .archive-icon { width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--primary),var(--primary-light)); display:flex; align-items:center; justify-content:center; flex-shrink:0; overflow:hidden; }
        .archive-icon img { width:100%; height:100%; object-fit:cover; }
        .archive-content { flex:1; min-width:0; }
        .archive-content h3 { margin-bottom:0.35rem; font-size:0.95rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .archive-meta { display:flex; gap:0.75rem; font-size:0.775rem; color:var(--text-secondary); flex-wrap:wrap; }
        .archive-delete { background:none; border:none; color:var(--text-tertiary); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; transition:color 0.15s; }
        .archive-delete:hover { color:var(--error); }
        /* MISC */
        .loading { text-align:center; padding:3rem 1rem; color:var(--text-secondary); }
        .empty-state { text-align:center; padding:2.5rem 1rem; color:var(--text-secondary); }
        .empty-state .icon { font-size:2.5rem; margin-bottom:0.75rem; opacity:0.5; }
        .manual-product-form { background:var(--bg-secondary); padding:1.25rem; border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .section-title { font-size:1rem; font-weight:600; margin-bottom:1rem; }
        .stats-bar { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .stats-bar p { font-size:0.875rem; color:var(--text-secondary); }
        .edit-mode-banner { background:var(--bg-secondary); padding:0.875rem; border-radius:8px; margin-bottom:1rem; border:1px solid var(--border); text-align:center; font-size:0.875rem; color:var(--text-secondary); }
        /* TABS */
        .tabs { display:flex; gap:0.5rem; margin-bottom:1.25rem; border-bottom:2px solid var(--border); }
        .tab { padding:0.75rem 1.25rem; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; font-weight:500; font-size:0.9rem; color:var(--text-secondary); transition:all 0.2s; font-family:'Inter',sans-serif; margin-bottom:-2px; }
        .tab:hover { color:var(--primary); }
        .tab.active { color:var(--primary); border-bottom-color:var(--primary); }
        
        /* Restaurant Category Tabs */
        .category-tabs { display:flex; gap:0.5rem; margin:1rem 0; overflow-x:auto; padding-bottom:0.5rem; }
        .category-tabs::-webkit-scrollbar { height:4px; }
        .category-tabs::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
        .category-tab { padding:0.6rem 1.2rem; background:white; border:1.5px solid var(--border); border-radius:8px; cursor:pointer; font-size:0.875rem; font-weight:500; white-space:nowrap; transition:all 0.2s; color:var(--text); }
        .category-tab:hover { border-color:var(--primary); background:var(--bg-secondary); }
        .category-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
        
        /* Restaurant Products Grid */
        .restaurant-products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1rem; margin-top:1rem; }
        .restaurant-product-card { border:1.5px solid var(--border); border-radius:10px; padding:0.75rem; text-align:center; background:white; transition:all 0.2s; }
        .restaurant-product-card img { display:none; }
        .restaurant-product-card h4 { font-size:0.875rem; margin:0 0 0.6rem; color:var(--text); font-weight:600; line-height:1.3; min-height:2.6em; }
        .restaurant-product-card .add-btn { width:100%; padding:0.5rem; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:600; transition:all 0.2s; }
        .restaurant-product-card .add-btn:hover { background:var(--primary-dark); }
        
        /* RANKING */
        .ranking-item { display:flex; gap:0.75rem; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.6rem; border:1px solid var(--border); }
        .ranking-position { width:30px; height:30px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem; flex-shrink:0; }
        .ranking-position.gold { background:linear-gradient(135deg,#fbbf24,#f59e0b); }
        .ranking-position.silver { background:linear-gradient(135deg,#d1d5db,#9ca3af); }
        .ranking-position.bronze { background:linear-gradient(135deg,#f97316,#ea580c); }
        /* AUTH */
        .auth-container { max-width:400px; margin:2rem auto; }
        .social-login { display:flex; flex-direction:column; gap:0.75rem; margin-top:1rem; }
        .social-btn { display:flex; align-items:center; justify-content:center; gap:0.75rem; padding:0.875rem; border-radius:8px; border:1px solid var(--border); background:var(--bg); cursor:pointer; transition:all 0.15s; font-weight:500; font-family:'Inter',sans-serif; font-size:0.9375rem; }
        .social-btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .divider { text-align:center; margin:1.25rem 0; position:relative; }
        .divider::before { content:''; position:absolute; left:0; right:0; top:50%; height:1px; background:var(--border); }
        .divider span { background:var(--bg); padding:0 1rem; position:relative; color:var(--text-secondary); font-size:0.875rem; }
        /* SCANNER */
        .scanner-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
        .scanner-modal.active { display:flex; }
        .scanner-content { background:var(--bg); border-radius:12px; padding:1.5rem; max-width:500px; width:90%; border:1px solid var(--border); }
        /* PROFILE */
        .profile-avatar-big { width:96px; height:96px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; overflow:hidden; }
        .avatar-option:hover { border-color:var(--primary)!important; background:var(--bg-secondary); }
        /* FAV */
        .fav-item { background:var(--bg); padding:0.875rem; border-radius:10px; margin-bottom:0.5rem; border:1px solid var(--border); display:flex; align-items:center; gap:0.75rem; }
        .fav-item img { width:48px; height:48px; border-radius:6px; object-fit:cover; flex-shrink:0; border:1px solid var(--border); }
        .fav-item .fav-info { flex:1; min-width:0; }
        .fav-item .fav-info h4 { font-size:0.85rem; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .fav-item .fav-info p { font-size:0.75rem; color:var(--text-secondary); }
        .fav-remove { background:none; border:none; color:var(--error); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; }
        /* AUTH SPINNER */
        .auth-spinner { display:none; text-align:center; padding:1.5rem; }
        .auth-spinner.show { display:block; }
        .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.6s linear infinite; margin:0 auto; }
        @keyframes spin { to{transform:rotate(360deg)} }
        /* INVITE MINI */
        .invite-mini { background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:1px solid #c7d2fe; border-radius:10px; padding:0.85rem 1rem; margin-bottom:1rem; display:flex; align-items:center; gap:0.75rem; }
        .invite-mini .code-mini { font-weight:700; font-size:1.1rem; letter-spacing:0.15em; color:var(--primary); flex-shrink:0; }
        .invite-mini p { font-size:0.78rem; color:var(--text-secondary); flex:1; min-width:0; }
        /* INPUT ERROR */
        .input-error input, .input-error textarea { border-color:var(--error) !important; background:#fef2f2; }
        .input-error input:focus, .input-error textarea:focus { box-shadow:0 0 0 3px rgba(239,68,68,0.15) !important; }
        .input-error label { color:var(--error) !important; }
        .field-error { font-size:0.75rem; color:var(--error); margin-top:0.3rem; display:none; }
        .field-error.show { display:block; }
        .field-success { font-size:0.75rem; color:var(--success); margin-top:0.3rem; display:none; }
        .field-success.show { display:block; }
        .password-strength { height:4px; border-radius:2px; margin-top:0.5rem; background:var(--border); overflow:hidden; display:none; }
        .password-strength.show { display:block; }
        .password-strength-bar { height:100%; transition:all 0.3s; border-radius:2px; }
        .password-strength-weak { width:33%; background:#ef4444; }
        .password-strength-medium { width:66%; background:#f59e0b; }
        .password-strength-strong { width:100%; background:#10b981; }
        .input-error { border-color:var(--error)!important; background:#fef2f2!important; }
        /* INVITE FAB */
        .invite-fab { position:fixed; bottom:80px; right:1rem; width:52px; height:52px; border-radius:50%; background:var(--primary); color:white; border:none; box-shadow:0 4px 14px rgba(37,99,235,0.4); display:none; align-items:center; justify-content:center; z-index:400; cursor:pointer; font-size:1.6rem; transition:transform 0.15s,box-shadow 0.15s; }
        .invite-fab:hover { transform:scale(1.08); box-shadow:0 6px 20px rgba(37,99,235,0.5); }
        .invite-fab.show { display:flex; }
        /* SHARE MODAL */
        .share-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2000; align-items:flex-end; justify-content:center; }
        .share-overlay.active { display:flex; }
        .share-sheet { background:#fff; border-radius:16px 16px 0 0; padding:1.5rem; width:100%; max-width:500px; }
        .share-sheet h3 { margin:0 0 0.25rem; font-size:1.05rem; font-weight:600; }
        .share-sheet > p { color:var(--text-secondary); font-size:0.8rem; margin:0 0 1.25rem; }
        .share-code-big { background:linear-gradient(135deg,var(--primary),var(--primary-light)); border-radius:10px; padding:1rem; text-align:center; margin-bottom:1rem; }
        .share-code-big .code { font-size:2rem; font-weight:700; letter-spacing:0.3em; color:white; }
        .share-code-big p { color:rgba(255,255,255,0.85); font-size:0.78rem; margin:0.3rem 0 0; }
        .share-actions { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
        .share-actions button { padding:0.7rem; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); cursor:pointer; font-family:'Inter',sans-serif; font-size:0.82rem; font-weight:500; color:var(--text); transition:all 0.15s; display:flex; align-items:center; justify-content:center; gap:0.4rem; }
        .share-actions button:hover { border-color:var(--primary); color:var(--primary); background:#fff; }
        .share-close { display:block; width:100%; margin-top:0.85rem; padding:0.6rem; border:none; background:none; color:var(--text-secondary); font-size:0.82rem; cursor:pointer; font-family:'Inter',sans-serif; }
        /* MODAL OVERLAY */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; display:flex; align-items:center; justify-content:center; padding:1rem; }
        .modal-content { background:#fff; border-radius:16px; padding:1.5rem; max-width:400px; width:100%; box-shadow:0 8px 32px rgba(0,0,0,0.2); animation:modalSlideIn 0.2s ease-out; }
        @keyframes modalSlideIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        /* RECENT TASTINGS - NUEVO DISE√ëO HORIZONTAL */
        .recent-tasting-item-new { 
            background:var(--bg); 
            border:1px solid var(--border); 
            border-radius:10px; 
            padding:0.75rem 1rem; 
            margin-bottom:0.65rem; 
            display:grid; 
            grid-template-columns:1fr auto auto auto; 
            align-items:center; 
            gap:0.75rem; 
            cursor:pointer; 
            transition:all 0.15s; 
        }
        .recent-tasting-item-new:hover { border-color:var(--primary); background:var(--bg-secondary); }
        .recent-tasting-name { 
            font-size:0.9rem; 
            font-weight:600; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            white-space:nowrap; 
        }
        .recent-tasting-date { 
            font-size:0.8rem; 
            color:var(--text-secondary); 
            white-space:nowrap; 
        }
        .status-badge { 
            font-size:0.7rem; 
            padding:0.25rem 0.6rem; 
            border-radius:5px; 
            font-weight:500; 
            white-space:nowrap; 
        }
        .status-badge.status-waiting { background:#f1f5f9; color:#64748b; }
        .status-badge.status-adding_products, .status-badge.status-voting { background:#fef3c7; color:#d97706; }
        .status-badge.status-finished { background:#d1fae5; color:#065f46; }
        .recent-tasting-arrow { 
            font-size:1.4rem; 
            color:var(--text-tertiary); 
            flex-shrink:0; 
        }
    </style>
</head>
<body>
<div class="app-wrapper">

<!-- PANDA MASCOT (normal) -->
<svg id="mascotSVG" style="display:none" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="58" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="142" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <!-- body -->
  <ellipse cx="100" cy="148" rx="52" ry="42" fill="white"/>
  <ellipse cx="100" cy="155" rx="26" ry="20" fill="#dbeafe"/>
  <!-- head -->
  <circle cx="100" cy="75" r="48" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="78" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(-5 78 72)"/>
  <ellipse cx="122" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(5 122 72)"/>
  <ellipse cx="100" cy="76" rx="5" ry="4" fill="#1a1a1a"/>
  <!-- eyes -->
  <circle cx="78" cy="70" r="8" fill="white"/>
  <circle cx="122" cy="70" r="8" fill="white"/>
  <circle cx="80" cy="71" r="5" fill="#1a1a1a"/>
  <circle cx="124" cy="71" r="5" fill="#1a1a1a"/>
  <circle cx="82" cy="69" r="2" fill="white"/>
  <circle cx="126" cy="69" r="2" fill="white"/>
  <!-- nose + mouth -->
  <ellipse cx="100" cy="85" rx="4" ry="3" fill="#1a1a1a"/>
  <path d="M96 89 Q100 94 104 89" stroke="#1a1a1a" stroke-width="1.8" fill="none" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="66" cy="85" rx="5" ry="3" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="134" cy="85" rx="5" ry="3" fill="#f59e0b" opacity="0.35"/>
  <!-- arms + legs -->
  <ellipse cx="48" cy="143" rx="11" ry="20" fill="#1a1a1a" transform="rotate(15 48 143)"/>
  <ellipse cx="152" cy="143" rx="11" ry="20" fill="#1a1a1a" transform="rotate(-15 152 143)"/>
  <ellipse cx="78" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="122" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA MASCOT EATING -->
<svg id="mascotEatingSVG" style="display:none" viewBox="0 0 220 210" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="68" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="152" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <!-- body -->
  <ellipse cx="110" cy="150" rx="52" ry="42" fill="white"/>
  <ellipse cx="110" cy="157" rx="26" ry="20" fill="#dbeafe"/>
  <!-- head -->
  <circle cx="110" cy="75" r="48" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="88" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(-5 88 72)"/>
  <ellipse cx="132" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(5 132 72)"/>
  <ellipse cx="110" cy="76" rx="5" ry="4" fill="#1a1a1a"/>
  <!-- squinting eyes -->
  <path d="M80 68 Q88 62 96 68" stroke="white" stroke-width="3.5" fill="none" stroke-linecap="round"/>
  <path d="M124 68 Q132 62 140 68" stroke="white" stroke-width="3.5" fill="none" stroke-linecap="round"/>
  <!-- nose + mouth -->
  <ellipse cx="110" cy="86" rx="4" ry="3" fill="#1a1a1a"/>
  <path d="M105 90 Q110 97 115 90" stroke="#1a1a1a" stroke-width="2" fill="#ef4444" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="74" cy="86" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <ellipse cx="146" cy="86" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <!-- arms -->
  <ellipse cx="58" cy="145" rx="11" ry="20" fill="#1a1a1a" transform="rotate(20 58 145)"/>
  <ellipse cx="162" cy="145" rx="11" ry="20" fill="#1a1a1a" transform="rotate(-20 162 145)"/>
  <!-- bowl -->
  <ellipse cx="110" cy="126" rx="32" ry="10" fill="#f59e0b"/>
  <path d="M78 126 Q110 154 142 126" fill="#e8920a"/>
  <circle cx="98" cy="121" r="4.5" fill="#10b981"/>
  <circle cx="110" cy="118" r="5.5" fill="#ef4444"/>
  <circle cx="122" cy="122" r="4" fill="#3b82f6"/>
  <!-- legs -->
  <ellipse cx="88" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="132" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA MASCOT WAITING (sitting, for archives) -->
<svg id="mascotWaitingSVG" style="display:none" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="58" cy="34" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="142" cy="34" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="100" cy="150" rx="54" ry="44" fill="white"/>
  <ellipse cx="100" cy="158" rx="28" ry="22" fill="#dbeafe"/>
  <circle cx="100" cy="70" r="46" fill="white"/>
  <ellipse cx="78" cy="68" rx="15" ry="13" fill="#1a1a1a" transform="rotate(-5 78 68)"/>
  <ellipse cx="122" cy="68" rx="15" ry="13" fill="#1a1a1a" transform="rotate(5 122 68)"/>
  <ellipse cx="100" cy="72" rx="5" ry="4" fill="#1a1a1a"/>
  <circle cx="78" cy="66" r="7" fill="white"/>
  <circle cx="122" cy="66" r="7" fill="white"/>
  <circle cx="80" cy="67" r="4.5" fill="#1a1a1a"/>
  <circle cx="124" cy="67" r="4.5" fill="#1a1a1a"/>
  <circle cx="82" cy="65" r="1.8" fill="white"/>
  <circle cx="126" cy="65" r="1.8" fill="white"/>
  <ellipse cx="100" cy="80" rx="3.5" ry="2.5" fill="#1a1a1a"/>
  <path d="M96 84 Q100 89 104 84" stroke="#1a1a1a" stroke-width="1.6" fill="none" stroke-linecap="round"/>
  <ellipse cx="66" cy="80" rx="4.5" ry="2.8" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="134" cy="80" rx="4.5" ry="2.8" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="90" cy="122" rx="10" ry="18" fill="#1a1a1a"/>
  <ellipse cx="110" cy="122" rx="10" ry="18" fill="#1a1a1a"/>
  <ellipse cx="75" cy="185" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="125" cy="185" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA HEAD EATING BAMBOO (for navbar profile) -->
<svg id="pandaHeadSVG" style="display:none" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="28" cy="26" rx="14" ry="18" fill="#1a1a1a"/>
  <ellipse cx="92" cy="26" rx="14" ry="18" fill="#1a1a1a"/>
  <!-- head -->
  <circle cx="60" cy="60" r="42" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="42" cy="56" rx="14" ry="12" fill="#1a1a1a" transform="rotate(-5 42 56)"/>
  <ellipse cx="78" cy="56" rx="14" ry="12" fill="#1a1a1a" transform="rotate(5 78 56)"/>
  <!-- eyes closed (eating) -->
  <path d="M36 54 Q42 50 48 54" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
  <path d="M72 54 Q78 50 84 54" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
  <!-- nose -->
  <ellipse cx="60" cy="66" rx="4" ry="3" fill="#1a1a1a"/>
  <!-- mouth eating -->
  <path d="M56 70 Q60 76 64 70" stroke="#1a1a1a" stroke-width="2" fill="#ef4444" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="32" cy="68" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <ellipse cx="88" cy="68" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <!-- bamboo stick -->
  <rect x="70" y="45" width="4" height="35" rx="2" fill="#4ade80" transform="rotate(25 72 62)"/>
  <rect x="68" y="40" width="8" height="6" rx="2" fill="#22c55e"/>
  <rect x="68" y="48" width="8" height="6" rx="2" fill="#22c55e"/>
</svg>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <div class="header-content">
            <button class="back-btn" id="backBtn" style="display:none;">‚Üê</button>
            <div><h1>TasteScore</h1><p id="headerSubtitle">Catas de productos en grupo</p></div>
        </div>
        <div id="headerProfile" class="header-profile" onclick="headerProfileClick()">
            <svg id="headerLoginIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <img id="headerProfileImg" src="" alt="Perfil" style="display:none;">
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<nav id="bottomNav">
    <button class="nav-btn active" id="nav-home" onclick="navigateTo('home')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Inicio</span>
    </button>
    <button class="nav-btn" id="nav-ranking" onclick="navigateTo('ranking')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        <span>Ranking</span>
    </button>
    <button class="nav-btn" id="nav-favs" onclick="navigateTo('favs')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span>Favoritos</span>
    </button>
    <button class="nav-btn" id="nav-mytastings" onclick="navigateTo('myTastings')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span>Mis Catas</span>
    </button>
</nav>

<!-- INVITE SHARE MODAL -->
<div id="inviteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:15000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;max-width:380px;width:90%;padding:1.75rem;box-shadow:0 8px 32px rgba(0,0,0,0.18);font-family:'Inter',sans-serif;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;font-size:1.05rem;font-weight:600;color:#1a1a1a;">Invitar a la cata</h3>
            <button onclick="document.getElementById('inviteModal').style.display='none'" style="background:none;border:none;font-size:1.4rem;color:#94a3b8;cursor:pointer;line-height:1;">‚úï</button>
        </div>
        <p style="color:#64748b;font-size:0.8rem;margin:0 0 1rem;">Comparte el c√≥digo o el enlace</p>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;text-align:center;margin-bottom:1rem;">
            <p style="font-size:0.72rem;color:#64748b;margin:0 0 0.3rem;text-transform:uppercase;letter-spacing:0.06em;font-weight:500;">C√≥digo</p>
            <p id="inviteModalCode" style="font-size:2rem;font-weight:700;letter-spacing:0.25em;color:#2563eb;margin:0;font-family:'Inter',sans-serif;"></p>
        </div>
        <button onclick="copyInviteCode()" style="width:100%;padding:0.7rem;border:1px solid #e2e8f0;border-radius:8px;background:#fff;color:#1a1a1a;font-size:0.85rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;display:flex;align-items:center;justify-content:center;gap:0.5rem;margin-bottom:0.5rem;" id="copyCodeBtn">üìã Copiar c√≥digo</button>
        <button onclick="shareInvite()" style="width:100%;padding:0.7rem;border:none;border-radius:8px;background:#2563eb;color:white;font-size:0.85rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;display:flex;align-items:center;justify-content:center;gap:0.5rem;">üì§ Compartir</button>
    </div>
</div>

<!-- EMAIL CONFIRMATION MODAL -->
<div id="emailConfirmModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:16000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:16px;max-width:420px;width:90%;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-family:'Inter',sans-serif;text-align:center;">
        <div style="width:72px;height:72px;margin:0 auto 1.25rem;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:50%;display:flex;align-items:center;justify-content:center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        </div>
        <h2 style="margin:0 0 0.75rem;font-size:1.35rem;font-weight:700;color:#1a1a1a;">Confirma tu email</h2>
        <p style="color:#64748b;font-size:0.95rem;line-height:1.6;margin:0 0 1.5rem;">Hemos enviado un email de confirmaci√≥n a <strong id="confirmEmailAddress" style="color:#2563eb;"></strong></p>
        <p style="color:#64748b;font-size:0.875rem;margin:0 0 1.75rem;padding:1rem;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;">Haz clic en el enlace del email para activar tu cuenta. Revisa tambi√©n la carpeta de spam.</p>
        <button onclick="openEmailApp()" style="width:100%;padding:0.9rem;border:none;border-radius:10px;background:#2563eb;color:white;font-size:0.95rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;margin-bottom:0.75rem;transition:all 0.2s;">üìß Abrir mi correo</button>
        <button onclick="closeEmailModal()" style="width:100%;padding:0.9rem;border:1px solid #e2e8f0;border-radius:10px;background:#fff;color:#64748b;font-size:0.9rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;">Cerrar</button>
    </div>
</div>

<!-- SCANNER MODAL -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-content">
        <h2 style="margin-bottom:0.75rem;font-size:1.125rem;font-weight:600;">Escanear C√≥digo de Barras</h2>
        <div id="reader" style="width:100%;border-radius:6px;overflow:hidden;"></div>
        <p id="scannerStatus" style="text-align:center;margin:0.75rem 0;color:var(--text-secondary);font-size:0.875rem;">Enfoca el c√≥digo de barras</p>
        <button class="btn btn-secondary" onclick="closeScanner()">Cancelar</button>
    </div>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:0.75rem;font-size:1.2rem;font-weight:600;text-align:center;">¬°Bienvenido!</h2>
            <p style="color:var(--text-secondary);margin-bottom:1.25rem;text-align:center;font-size:0.9rem;">Crea una cata o √∫nete a una existente.</p>
            <button class="btn btn-primary" onclick="showScreen('createScreen')" style="margin-bottom:0.6rem;">Crear Nueva Cata</button>
            <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Unirse a Cata</button>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:0.75rem;font-weight:600;font-size:0.95rem;display:flex;align-items:center;gap:0.5rem;">
                <span style="font-size:1.25rem;">üìã</span>
                Tus √öltimas Catas
            </h3>
            <div id="recentTastingsList"></div>
        </div>
    </div>
</div>

<!-- RANKING -->
<div class="screen" id="rankingScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üèÜ Ranking Global</h2>
            <p style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.875rem;">Los productos mejor valorados</p>
            <div id="rankingList"></div>
        </div>
    </div>
</div>

<!-- AUTH -->
<div class="screen" id="authScreen">
    <div class="auth-container">
        <div class="card">
            <div style="text-align:center;margin-bottom:0.75rem;"><img id="authMascot" src="" alt="" style="width:72px;height:auto;"></div>
            <h2 id="authTitle" style="margin-bottom:1.25rem;font-size:1.2rem;font-weight:600;text-align:center;">Inicia Sesi√≥n</h2>
            <div class="social-login">
                <button class="social-btn" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continuar con Google
                </button>
            </div>
            <div class="divider"><span>o</span></div>
            <form onsubmit="loginWithEmail(); return false;">
                <div class="input-group" id="nameGroup" style="display:none;">
                    <label>Nombre *</label>
                    <input type="text" id="authName" placeholder="Tu nombre" oninput="clearAuthError('authName')" autocomplete="name">
                    <p class="field-error" id="errAuthName">Este campo es obligatorio</p>
                </div>
                <div class="input-group">
                    <label>Email *</label>
                    <input type="email" id="authEmail" placeholder="tu@email.com" oninput="clearAuthError('authEmail')" autocomplete="email">
                    <p class="field-error" id="errAuthEmail">Introduce un email v√°lido</p>
                </div>
                <div class="input-group">
                    <label>Contrase√±a *</label>
                    <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="checkPasswordStrength()" autocomplete="current-password">
                    <div class="password-strength" id="passwordStrength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    <p class="field-error" id="errAuthPassword">La contrase√±a debe tener al menos 6 caracteres</p>
                    <p class="field-success" id="passwordStrengthText"></p>
                </div>
                <div class="auth-spinner" id="authSpinner"><div class="spinner"></div></div>
                <button type="submit" class="btn btn-primary" id="authBtn">Iniciar Sesi√≥n</button>
            </form>
            <p style="text-align:center;margin-top:0.875rem;color:var(--text-secondary);font-size:0.825rem;">
                ¬øNo tienes cuenta? <a href="#" onclick="toggleAuthMode();return false;" style="color:var(--primary);text-decoration:none;font-weight:500;" id="authToggleLink">Reg√≠strate</a>
            </p>
        </div>
    </div>
</div>

<!-- PROFILE -->
<div class="screen" id="profileScreen">
    <div class="container">
        <div class="card" style="text-align:center;">
            <div class="profile-avatar-big" id="profileAvatarBig" style="cursor:pointer;" onclick="showAvatarSelector()"></div>
            <p style="font-size:0.75rem;color:var(--text-tertiary);margin-bottom:1rem;">Toca para cambiar avatar</p>
            <h2 id="profileName" style="font-size:1.2rem;font-weight:600;margin-bottom:0.2rem;"></h2>
            <p id="profileEmail" style="color:var(--text-secondary);font-size:0.825rem;margin-bottom:1.25rem;"></p>
            <div style="display:grid;gap:0.75rem;max-width:300px;margin:0 auto;">
                <button class="btn btn-secondary" onclick="showEditProfile()">‚úé Editar Perfil</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
                <button class="btn" onclick="deleteAccount()" style="color:var(--error);border-color:var(--error);">üóëÔ∏è Eliminar Cuenta</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE -->
<div class="screen" id="editProfileScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Editar Perfil</h2>
            <form onsubmit="saveProfileChanges(); return false;">
                <div class="input-group">
                    <label>Nombre de usuario</label>
                    <input type="text" id="editProfileName" placeholder="Tu nombre" autocomplete="name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="editProfileEmail" placeholder="tu@email.com" autocomplete="email">
                    <p style="font-size:0.75rem;color:var(--text-tertiary);margin-top:0.3rem;">Si cambias el email, deber√°s confirmar el nuevo</p>
                </div>
                <div class="input-group">
                    <label>Nueva contrase√±a (opcional)</label>
                    <input type="password" id="editProfilePassword" placeholder="Dejar vac√≠o para no cambiar" autocomplete="new-password">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-top:1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="showScreen('profileScreen')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AVATAR SELECTOR MODAL -->
<div id="avatarSelectorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:16000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:#fff;border-radius:16px;max-width:520px;width:90%;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-family:'Inter',sans-serif;margin:2rem auto;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h3 style="margin:0;font-size:1.15rem;font-weight:600;">Elige tu avatar</h3>
            <button onclick="closeAvatarSelector()" style="background:none;border:none;font-size:1.5rem;color:#94a3b8;cursor:pointer;">‚úï</button>
        </div>
        <h4 style="font-size:0.875rem;color:var(--text-secondary);margin:0 0 0.75rem;font-weight:600;">üêº Pandas</h4>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1.5rem;">
            <div class="avatar-option" onclick="selectAvatar('panda_normal')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_normal" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Normal</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_eating')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_eating" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Comiendo</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_waiting')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_waiting" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Esperando</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_head')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_head" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Con Bamb√∫</p>
            </div>
        </div>
        <h4 style="font-size:0.875rem;color:var(--text-secondary);margin:0 0 0.75rem;font-weight:600;">üçï Comidas</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;">
            <div class="avatar-option" onclick="selectAvatar('pizza')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçï</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Pizza</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('burger')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçî</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Burger</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('taco')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üåÆ</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Taco</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('sushi')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç£</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Sushi</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('ramen')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçú</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Ramen</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('hotdog')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üå≠</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Hotdog</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('icecream')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç¶</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Helado</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('donut')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç©</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Donut</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('cookie')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç™</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Cookie</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('coffee')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">‚òï</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Caf√©</p>
            </div>
        </div>
    </div>
</div>

<!-- MY TASTINGS -->
<div class="screen" id="myTastingsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üìã Mis Catas</h2>
            <div id="userTastingsList"></div>
        </div>
    </div>
</div>

<!-- FAVOURITES -->
<div class="screen" id="favsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:0.6rem;font-size:1.2rem;font-weight:600;">‚ù§Ô∏è Favoritos</h2>
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
                <select id="favListSelector" style="flex:1;padding:0.55rem 0.7rem;border:1px solid var(--border);border-radius:8px;font-size:0.85rem;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);outline:none;" onchange="renderFavs()"><option value="__default__">Mi lista principal</option></select>
                <button class="btn btn-small btn-secondary btn-icon" onclick="createNewFavList()" style="width:auto;flex-shrink:0;">+ Lista</button>
            </div>
            <div id="favsList"></div>
        </div>
    </div>
</div>

<!-- CREATE -->
<div class="screen" id="createScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Crear Nueva Cata</h2>
            <div class="input-group" id="fieldTastingName"><label>Nombre de la Cata *</label><input type="text" id="tastingName" placeholder="Ej: Cata de Quesos"><p class="field-error" id="errTastingName">Este campo es obligatorio</p></div>
            <div class="input-group" id="fieldHostName"><label>Tu Nombre *</label><input type="text" id="hostName" placeholder="Tu nombre"><p class="field-error" id="errHostName">Este campo es obligatorio</p></div>
            <div class="input-group"><label>Fecha de la Cata (opcional)</label><input type="date" id="tastingDate" style="color-scheme:light;"></div>
            <div class="input-group"><label>Descripci√≥n (opcional)</label><textarea id="tastingDescription" rows="3" placeholder="Detalles..."></textarea></div>
            <button class="btn btn-primary" onclick="createTasting()">Crear Cata</button>
        </div>
    </div>
</div>

<!-- JOIN -->
<div class="screen" id="joinScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Unirse a Cata</h2>
            <div class="input-group"><label>C√≥digo de Cata</label><input type="text" id="joinCode" placeholder="Ej: ABC123" style="text-transform:uppercase;"></div>
            <div class="input-group"><label>Tu Nombre</label><input type="text" id="participantName" placeholder="Tu nombre"></div>
            <button class="btn btn-primary" onclick="joinTasting()">Unirse</button>
        </div>
    </div>
</div>

<!-- WAITING ROOM -->
<div class="screen" id="waitingScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="waitingTastingName" style="margin-bottom:0.25rem;font-size:1.1rem;font-weight:600;"></h2>
            <p id="waitingTastingDate" style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:0.75rem;display:none;">üìÖ <span id="waitingDateText"></span></p>
            <div class="code-display">
                <p>C√≥digo de invitaci√≥n</p>
                <div class="code" id="displayCode"></div>
                <p>Comparte este c√≥digo</p>
            </div>
            
            <!-- Compartir buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin:1rem 0;">
                <button class="btn btn-secondary btn-small" onclick="shareViaWhatsApp()" style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                    <span style="font-size:1.1rem;">üì±</span>
                    <span>WhatsApp</span>
                </button>
                <button class="btn btn-secondary btn-small" onclick="copyShareLink()" style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                    <span style="font-size:1.1rem;">üîó</span>
                    <span>Copiar enlace</span>
                </button>
            </div>
            
            <h3 style="margin:1.25rem 0 0.75rem;font-size:0.95rem;font-weight:600;">Participantes</h3>
            <div id="participantsList"></div>
            <button class="btn btn-primary" onclick="startTasting()" id="startBtn">Comenzar Cata</button>
            <button class="btn btn-primary" onclick="continueTasting()" id="continueBtn" style="display:none;">Continuar Cata</button>
        </div>
    </div>
</div>

<!-- ADD PRODUCTS -->
<div class="screen" id="addProductsScreen">
    <div class="container">
        <div class="card">
            <h2 class="section-title">A√±adir Productos</h2>
            <!-- TABS -->
            <div class="tabs">
                <button class="tab active" onclick="switchProductTab('supermarket')">üõí Supermercado</button>
                <button class="tab" onclick="switchProductTab('restaurant')">üçî Restaurantes</button>
            </div>
            <!-- SUPERMERCADO TAB -->
            <div id="supermarketTab">
                <div class="input-group"><label>Buscar Producto</label><input type="text" id="productSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProducts()"></div>
                <div class="btn-group">
                    <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualForm()"><span>‚úçÔ∏è</span><span>Manual</span></button>
                </div>
                <div class="manual-product-form" id="manualProductForm" style="display:none;">
                    <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                    <div class="input-group"><label>Nombre</label><input type="text" id="manualProductName" placeholder="Ej: Queso Manchego"></div>
                    <div class="input-group"><label>Marca</label><input type="text" id="manualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                    <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="manualProductImage" placeholder="https://..."></div>
                    <button class="btn btn-primary" onclick="addManualProduct()">A√±adir</button>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
            <!-- RESTAURANTES TAB -->
            <div id="restaurantTab" style="display:none;">
                <!-- Restaurant Selector -->
                <div class="input-group">
                    <label>Selecciona Restaurante</label>
                    <select id="restaurantSelect" onchange="loadRestaurantCategories()">
                        <option value="">-- Elige un restaurante --</option>
                        <option value="McDonald's">McDonald's</option>
                        <option value="Burger King">Burger King</option>
                        <option value="KFC">KFC</option>
                        <option value="Domino's">Domino's Pizza</option>
                        <option value="Telepizza">Telepizza</option>
                        <option value="Papa John's">Papa John's</option>
                        <option value="La Tagliatella">La Tagliatella</option>
                        <option value="Ginos">Ginos</option>
                        <option value="VIPS">VIPS</option>
                        <option value="Foster's Hollywood">Foster's Hollywood</option>
                        <option value="Tony Roma's">Tony Roma's</option>
                        <option value="TGB">TGB</option>
                        <option value="100 Montaditos">100 Montaditos</option>
                        <option value="Rodilla">Rodilla</option>
                        <option value="Starbucks">Starbucks</option>
                    </select>
                </div>
                
                <!-- Category Tabs -->
                <div id="categoryTabs" style="display:none;">
                    <div class="category-tabs" id="categoryTabsContainer"></div>
                </div>
                
                <!-- Search within restaurant -->
                <div class="input-group" id="restaurantSearchBox" style="display:none;">
                    <input type="text" id="restaurantProductSearch" placeholder="Buscar en el restaurante..." oninput="filterRestaurantProducts()">
                </div>
                
                <!-- Products Grid -->
                <div id="restaurantProductsGrid" class="restaurant-products-grid"></div>
                
                <!-- Empty state -->
                <div id="restaurantEmptyState" style="text-align:center;padding:2rem;color:var(--text-secondary);">
                    <div style="font-size:3rem;margin-bottom:0.5rem;">üçî</div>
                    <p>Selecciona un restaurante para ver su men√∫</p>
                </div>
            </div>
            <div style="margin:1.5rem 0;">
                <h3 class="section-title">Productos A√±adidos (<span id="productCount">0</span>)</h3>
                <div class="product-grid" id="addedProducts"></div>
            </div>
            <button class="btn btn-primary" onclick="finishAddingProducts()">Comenzar Votaci√≥n</button>
        </div>
    </div>
</div>

<!-- PRODUCT SELECTION (during voting) -->
<div class="screen" id="productSelectionScreen">
    <div class="container">
        <div class="card" style="position:relative;">
            <button onclick="showEditMode()" id="editBtn" style="display:none;position:absolute;top:1rem;right:1rem;width:36px;height:36px;border-radius:50%;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);font-size:0.9rem;cursor:pointer;transition:all 0.2s;padding:0;display:flex;align-items:center;justify-content:center;z-index:10;" onmouseover="this.style.background='var(--primary)';this.style.color='white';this.style.borderColor='var(--primary)';" onmouseout="this.style.background='var(--bg-secondary)';this.style.color='var(--text-secondary)';this.style.borderColor='var(--border)';" title="Editar cata">‚úé</button>
            <h2 class="section-title" style="margin:0 0 1.25rem;">Selecciona Producto</h2>
            <div class="product-grid" id="productSelectionList"></div>
            <div class="stats-bar"><p><strong id="votedProductsCount">0</strong> de <strong id="totalProductsCount">0</strong> productos votados</p></div>
            <button class="btn btn-primary" onclick="confirmFinishTasting()" style="margin-top:1rem;">Finalizar Cata</button>
        </div>
    </div>
</div>

<!-- MANAGE PARTICIPANTS (modal-like screen) -->
<div class="screen" id="manageParticipantsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;">Gestionar Participantes</h2>
            <div class="invite-mini">
                <span class="code-mini" id="manageMiniCode"></span>
                <p>C√≥digo para invitar</p>
            </div>
            <div id="manageParticipantsList"></div>
        </div>
    </div>
</div>

<!-- EDIT CATA -->
<div class="screen" id="editCataScreen">
    <div class="container">
        <div class="edit-mode-banner">Modo Edici√≥n ‚Äì A√±ade o elimina productos</div>
        <div class="card">
            <h2 class="section-title">A√±adir M√°s Productos</h2>
            
            <!-- Pesta√±as Supermercado/Restaurante -->
            <div class="tabs">
                <button class="tab active" onclick="switchEditProductTab('supermarket')">üõí Supermercado</button>
                <button class="tab" onclick="switchEditProductTab('restaurant')">üçî Restaurantes</button>
            </div>

            <!-- Tab Supermercado -->
            <div id="editSupermarketTab">
                <div class="input-group"><label>Buscar</label><input type="text" id="editProductSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProductsEdit()"></div>
                <div class="btn-group">
                    <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualFormEdit()"><span>‚úçÔ∏è</span><span>Manual</span></button>
                </div>
                <div class="manual-product-form" id="manualProductFormEdit" style="display:none;">
                    <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                    <div class="input-group"><label>Nombre</label><input type="text" id="editManualProductName" placeholder="Ej: Queso Manchego"></div>
                    <div class="input-group"><label>Marca</label><input type="text" id="editManualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                    <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="editManualProductImage" placeholder="https://..."></div>
                    <button class="btn btn-primary" onclick="addManualProductEdit()">A√±adir</button>
                </div>
                <div class="search-results" id="editSearchResults"></div>
            </div>

            <!-- Tab Restaurante -->
            <div id="editRestaurantTab" style="display:none;">
                <div class="input-group">
                    <label>Selecciona Restaurante</label>
                    <select id="editRestaurantSelect" onchange="loadEditRestaurantCategories()">
                        <option value="">-- Elige un restaurante --</option>
                        <option value="McDonald's">McDonald's</option>
                        <option value="Burger King">Burger King</option>
                        <option value="KFC">KFC</option>
                        <option value="Domino's">Domino's Pizza</option>
                        <option value="Telepizza">Telepizza</option>
                    </select>
                </div>
                <div id="editCategoryTabs" class="category-tabs" style="display:none;"></div>
                <div class="input-group" id="editRestaurantSearchBox" style="display:none;">
                    <input type="text" id="editRestaurantProductSearch" placeholder="Buscar en el restaurante..." oninput="filterEditRestaurantProducts()">
                </div>
                <div id="editRestaurantProductsGrid" class="restaurant-products-grid"></div>
                <div id="editRestaurantEmptyState" style="text-align:center;padding:2rem;color:var(--text-secondary);">
                    <p style="font-size:2rem;margin-bottom:0.5rem;">üçî</p>
                    <p>Selecciona un restaurante para ver su men√∫</p>
                </div>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Productos Actuales (<span id="editProductCount">0</span>)</h2>
            <div class="product-grid" id="editProductsList"></div>
        </div>
        <button class="btn btn-primary" onclick="exitEditMode()">Volver a la Cata</button>
    </div>
</div>

<!-- VOTING -->
<div class="screen" id="votingScreen">
    <div class="container">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h3 style="font-weight:600;font-size:0.95rem;">Votando Producto</h3>
                <span class="status-badge status-active">En votaci√≥n</span>
            </div>
            <div class="product-item" style="background:var(--bg-secondary);border-color:var(--primary);margin-bottom:1.5rem;cursor:default;display:flex;align-items:center;">
                <img id="votingProductImage" class="product-image" src="" alt="">
                <div class="product-info" style="flex:1;"><h4 id="votingProductName"></h4><p id="votingProductBrand"></p></div>
                <div id="votingProductScore" style="font-size:1.1rem;font-weight:600;color:white;padding:0.3rem 0.7rem;border-radius:6px;text-shadow:0 1px 2px rgba(0,0,0,0.15);flex-shrink:0;display:none;"></div>
            </div>
            <div class="rating-container">
                <label style="font-weight:500;display:block;margin-bottom:0.5rem;font-size:0.875rem;">Tu Puntuaci√≥n</label>
                <div class="rating-slider-container">
                    <div class="rating-value-popup" id="ratingValuePopup">5.0</div>
                    <input type="range" id="ratingSlider" class="rating-slider" min="0" max="10" step="0.1" value="5.0" oninput="updateRatingValue()">
                    <div class="rating-labels"><span>0</span><span>5</span><span>10</span></div>
                </div>
            </div>
            <div class="input-group"><label>Comentarios (opcional)</label><textarea id="voteComment" rows="2" placeholder="Tus impresiones..."></textarea></div>
            <button class="btn btn-primary" onclick="submitVote()">Enviar Voto</button>
            <div class="stats-bar"><p><strong id="votedCount" style="color:var(--primary);">0</strong> de <strong id="votedTotal">0</strong> han votado</p></div>
        </div>
    </div>
</div>

<!-- WAITING VOTES -->
<div class="screen" id="waitingVotesScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:0.75rem;font-size:1.1rem;font-weight:600;text-align:center;">Voto Enviado ‚úì</h2>
            
            <!-- Mostrar producto votado con puntuaci√≥n -->
            <div id="votedProductCard" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:0.75rem 1rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem;">
                <img id="votedProductImage" class="product-image" src="" alt="" style="width:50px;height:50px;flex-shrink:0;">
                <div style="flex:1;min-width:0;">
                    <h4 id="votedProductName" style="font-size:0.9rem;font-weight:600;margin:0 0 0.15rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></h4>
                    <p id="votedProductBrand" style="font-size:0.75rem;color:var(--text-secondary);margin:0;"></p>
                </div>
                <div id="votedProductScore" style="font-size:1.1rem;font-weight:600;color:white;padding:0.3rem 0.7rem;border-radius:6px;text-shadow:0 1px 2px rgba(0,0,0,0.15);flex-shrink:0;"></div>
                <button onclick="editVote()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:0.9rem;padding:0.25rem;flex-shrink:0;" title="Editar voto">‚úé</button>
            </div>
            
            <p style="color:var(--text-secondary);margin-bottom:1.5rem;text-align:center;">Esperando a que todos voten...</p>
            <div class="loading"><div style="font-size:2.5rem;">‚è≥</div><p style="margin-top:0.75rem;"><strong id="waitingVotedCount">0</strong> de <strong id="waitingVotedTotal">0</strong> votos</p></div>
        </div>
    </div>
</div>

<!-- RESULTS -->
<div class="screen" id="resultsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;text-align:center;">Resultados</h2>
            <div id="resultsContainer"></div>
            <button class="btn btn-primary" onclick="finishTasting()" style="margin-top:1rem;">Finalizar Cata</button>
        </div>
    </div>
</div>

<!-- ARCHIVE DETAIL -->
<div class="screen" id="archiveScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="archiveTastingName" style="margin-bottom:0.35rem;font-size:1.1rem;font-weight:600;"></h2>
            <p id="archiveDate" style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.8rem;"></p>
            <div id="archiveResults"></div>
        </div>
    </div>
</div>

<!-- INVITE FAB (shown during active tasting) -->
<button class="invite-fab" id="inviteFab" onclick="openShareModal()">+</button>

<!-- CONFIRM DELETE MODAL -->
<div class="modal-overlay" id="confirmDeleteModal" style="display:none;">
    <div class="modal-content">
        <div class="modal-icon" style="width:60px;height:60px;margin:0 auto 1rem;border-radius:50%;background:#fef2f2;display:flex;align-items:center;justify-content:center;">
            <span style="font-size:2rem;">üóëÔ∏è</span>
        </div>
        <h3 style="margin:0 0 0.5rem;font-size:1.1rem;font-weight:600;text-align:center;">Eliminar Producto</h3>
        <p id="confirmDeleteText" style="color:var(--text-secondary);margin:0 0 1.5rem;text-align:center;font-size:0.9rem;line-height:1.5;"></p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
            <button class="btn btn-secondary" onclick="closeConfirmDeleteModal()">Cancelar</button>
            <button class="btn" onclick="confirmDeleteProduct()" style="background:var(--error);color:white;border-color:var(--error);">Eliminar</button>
        </div>
    </div>
</div>

<!-- SHARE MODAL -->
<div class="share-overlay" id="shareOverlay">
    <div class="share-sheet">
        <h3>Invitar a la Cata</h3>
        <p>Comparte el c√≥digo o el enlace</p>
        <div class="share-code-big">
            <div class="code" id="shareCodeBig"></div>
            <p>C√≥digo de invitaci√≥n</p>
        </div>
        <div class="share-actions">
            <button onclick="copyCode()">üìã Copiar c√≥digo</button>
            <button onclick="shareNative()">üì§ Compartir</button>
        </div>
        <button class="share-close" onclick="closeShareModal()">Cerrar</button>
    </div>
</div>

<!-- PWA INSTALL BANNER -->
<div id="installBanner" style="display:none;position:fixed;bottom:64px;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;padding:0.875rem;z-index:9999;box-shadow:0 -2px 8px rgba(0,0,0,0.07);">
    <div style="max-width:640px;margin:0 auto;display:flex;align-items:center;gap:0.75rem;">
        <div style="width:40px;height:40px;border-radius:10px;background:#2563eb;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><img id="bannerMascot" src="" alt="" style="width:32px;height:32px;"></div>
        <div style="flex:1;min-width:0;"><p style="font-weight:600;font-size:0.85rem;margin:0;color:#1a1a1a;">A√±adir TasteScore a tu m√≥vil</p><p style="font-size:0.75rem;color:#64748b;margin:0.1rem 0 0;">Acceso r√°pido desde pantalla de inicio</p></div>
        <button id="installBtn" style="background:#2563eb;color:white;border:none;padding:0.5rem 0.9rem;border-radius:8px;font-weight:600;font-size:0.8rem;cursor:pointer;font-family:'Inter',sans-serif;">A√±adir</button>
        <button id="dismissBanner" style="background:none;border:none;color:#94a3b8;font-size:1.1rem;cursor:pointer;">‚úï</button>
    </div>
</div>

<!-- UPDATE AVAILABLE BANNER -->
<div id="updateBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:0.875rem;z-index:10000;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
    <div style="max-width:640px;margin:0 auto;display:flex;align-items:center;gap:0.75rem;">
        <div style="font-size:1.5rem;">üéâ</div>
        <div style="flex:1;min-width:0;">
            <p style="font-weight:600;font-size:0.85rem;margin:0;">Nueva versi√≥n disponible</p>
            <p style="font-size:0.75rem;opacity:0.9;margin:0.1rem 0 0;">Actualiza para obtener las √∫ltimas mejoras</p>
        </div>
        <button id="updateBtn" onclick="updateApp()" style="background:white;color:#059669;border:none;padding:0.5rem 0.9rem;border-radius:8px;font-weight:600;font-size:0.8rem;cursor:pointer;font-family:'Inter',sans-serif;">Actualizar</button>
        <button onclick="dismissUpdateBanner()" style="background:none;border:none;color:white;font-size:1.1rem;cursor:pointer;opacity:0.8;">‚úï</button>
    </div>
</div>
        <button id="dismissBanner" style="background:none;border:none;color:#94a3b8;font-size:1.1rem;cursor:pointer;">‚úï</button>
    </div>
</div>
<div id="iosModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:flex-end;justify-content:center;">
    <div style="background:#fff;border-radius:16px 16px 0 0;padding:1.5rem;max-width:500px;width:100%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h3 style="margin:0;font-size:1.1rem;font-weight:600;">A√±adir a pantalla de inicio</h3><button id="closeIosModal" style="background:none;border:none;font-size:1.5rem;color:#64748b;cursor:pointer;">‚úï</button></div>
        <div style="text-align:center;padding:0.75rem 0;"><div style="font-size:2.25rem;margin-bottom:0.5rem;">üì§</div><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.4rem;">Pulsa el bot√≥n de compartir</p><p style="color:#64748b;font-size:0.825rem;margin:0 0 0.75rem;">En la barra inferior de Safari</p><div style="background:#f8fafc;border-radius:8px;padding:0.85rem;border:1px solid #e2e8f0;"><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.2rem;font-size:0.9rem;">Selecciona "A√±adir a pantalla de inicio"</p></div></div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// ===== MASCOTS =====
let MASCOT_URL='', MASCOT_EATING_URL='', MASCOT_WAITING_URL='', PANDA_HEAD_URL='';
const PANDA_AVATARS = {
    panda_normal: '',
    panda_eating: '',
    panda_waiting: '',
    panda_head: '',
    pizza: 'üçï',
    burger: 'üçî',
    taco: 'üåÆ',
    sushi: 'üç£',
    ramen: 'üçú',
    hotdog: 'üå≠',
    icecream: 'üç¶',
    donut: 'üç©',
    cookie: 'üç™',
    coffee: '‚òï'
};

function initMascots(){
    MASCOT_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotSVG').outerHTML.replace(' style="display:none"',''));
    MASCOT_EATING_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotEatingSVG').outerHTML.replace(' style="display:none"',''));
    MASCOT_WAITING_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotWaitingSVG').outerHTML.replace(' style="display:none"',''));
    PANDA_HEAD_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('pandaHeadSVG').outerHTML.replace(' style="display:none"',''));
    
    PANDA_AVATARS.panda_normal = MASCOT_URL;
    PANDA_AVATARS.panda_eating = MASCOT_EATING_URL;
    PANDA_AVATARS.panda_waiting = MASCOT_WAITING_URL;
    PANDA_AVATARS.panda_head = PANDA_HEAD_URL;
    
    // Set mascot images safely (check if elements exist first)
    const headerPanda = document.getElementById('headerPanda');
    const authMascot = document.getElementById('authMascot');
    const authPromptMascot = document.getElementById('authPromptMascot');
    const installBannerMascot = document.getElementById('bannerMascot');
    
    if (headerPanda) headerPanda.src = PANDA_HEAD_URL;
    if (authMascot) authMascot.src = MASCOT_URL;
    if (authPromptMascot) authPromptMascot.src = MASCOT_URL;
    if (installBannerMascot) installBannerMascot.src = MASCOT_URL;
}

// ===== STATE =====
let currentTasting=null, currentUser=null, selectedProductId=null;
let userVotes={}, searchTimeout=null, html5QrCode=null;
let globalRanking={}, isAuthMode='login', authenticatedUser=null;
let scannerTargetScreen='addProductsScreen';
let sortableInstances={};

// ===== INIT =====
async function initApp(){
    try {
        initMascots();
    } catch(e) {
        console.error('Error in initMascots:', e);
    }
    
    // Supabase auth state listener
    const {data:{session}} = await supabaseClient.auth.getSession();
    if(session && session.user){
        const {data:profile} = await supabaseClient.from('profiles').select('*').eq('id',session.user.id).single();
        if(profile){
            authenticatedUser={id:session.user.id, name:profile.name||session.user.email.split('@')[0], email:session.user.email};
        } else {
            authenticatedUser={id:session.user.id, name:session.user.email.split('@')[0], email:session.user.email};
        }
    }
    supabaseClient.auth.onAuthStateChange(async (_event, session)=>{
        if(session && session.user){
            const {data:profile} = await supabaseClient.from('profiles').select('*').eq('id',session.user.id).single();
            if(profile){
                authenticatedUser={id:session.user.id, name:profile.name||session.user.email.split('@')[0], email:session.user.email};
            } else {
                authenticatedUser={id:session.user.id, name:session.user.email.split('@')[0], email:session.user.email};
            }
        } else {
            authenticatedUser=null;
        }
        updateNavBar();
        loadGlobalRanking();
        loadRecentTastings();
    });
    updateNavBar();
    loadGlobalRanking();
    loadRecentTastings();
    
    // Check for auto-join parameter AFTER everything is loaded
    // Use a longer delay to ensure DOM is fully ready
    setTimeout(() => {
        try {
            checkAutoJoin();
        } catch(e) {
            console.error('Error in checkAutoJoin:', e);
        }
    }, 1000);
}

// ===== NAV BAR =====
async function updateNavBar(){
    const favBtn=document.getElementById('nav-favs'), myBtn=document.getElementById('nav-mytastings');
    const headerProfile=document.getElementById('headerProfile');
    const headerProfileImg=document.getElementById('headerProfileImg');
    const headerLoginIcon=document.getElementById('headerLoginIcon');
    
    if(authenticatedUser){
        favBtn.style.display='flex'; myBtn.style.display='flex';
        headerLoginIcon.style.display='none';
        headerProfileImg.style.display='block';
        
        // Load user avatar
        const {data:profile} = await supabaseClient.from('profiles').select('avatar').eq('id',authenticatedUser.id).single();
        const avatarKey = profile?.avatar || 'panda_normal';
        
        if(PANDA_AVATARS[avatarKey]){
            if(avatarKey.startsWith('panda')){
                headerProfileImg.src = PANDA_AVATARS[avatarKey];
                headerProfileImg.style.display='block';
                // Remove emoji div if it exists
                const emojiDiv = headerProfile.querySelector('div');
                if(emojiDiv) emojiDiv.remove();
            }else{
                // Food emoji avatar
                headerProfileImg.style.display='none';
                headerProfile.innerHTML='<svg id="headerLoginIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><img id="headerProfileImg" src="" alt="Perfil" style="display:none;"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:white;">'+PANDA_AVATARS[avatarKey]+'</div>';
                headerProfile.onclick=function(){navigateTo('profile');};
            }
        }
    } else {
        favBtn.style.display='none'; myBtn.style.display='none';
        headerLoginIcon.style.display='block';
        headerProfileImg.style.display='none';
        // Remove emoji div if it exists
        const emojiDiv = headerProfile.querySelector('div');
        if(emojiDiv) emojiDiv.remove();
    }
}

function headerProfileClick(){
    if(authenticatedUser){
        navigateTo('profile');
    }else{
        navigateTo('auth');
    }
}

// ===== AUTH ‚Äì localStorage-based =====
async function loginWithGoogle(){
    showAuthSpinner(true);
    const {error} = await supabaseClient.auth.signInWithOAuth({
        provider:'google',
        options: {
            redirectTo: 'https://sanchezcolmenero.github.io/tastescoreapp/'
        }
    });
    if(error){showAuthSpinner(false);alert('Error con Google: '+error.message);}
}

async function loginWithEmail(){
    const email=document.getElementById('authEmail').value.trim();
    const password=document.getElementById('authPassword').value.trim();
    
    // Clear previous errors
    document.querySelectorAll('.field-error').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('input').forEach(i=>i.classList.remove('input-error'));
    
    let hasError=false;
    
    if(isAuthMode==='register'){
        const name=document.getElementById('authName').value.trim();
        
        // Validate name
        if(!name){
            document.getElementById('errAuthName').classList.add('show');
            document.getElementById('authName').classList.add('input-error');
            hasError=true;
        }
        
        // Validate email
        if(!email || !email.includes('@') || !email.includes('.')){
            document.getElementById('errAuthEmail').classList.add('show');
            document.getElementById('authEmail').classList.add('input-error');
            hasError=true;
        }
        
        // Validate password
        if(password.length<6){
            document.getElementById('errAuthPassword').classList.add('show');
            document.getElementById('authPassword').classList.add('input-error');
            hasError=true;
        }
        
        if(hasError) return;
        
        showAuthSpinner(true);
        const {data,error} = await supabaseClient.auth.signUp({
            email:email,
            password:password,
            options: {
                emailRedirectTo: 'https://sanchezcolmenero.github.io/tastescoreapp/'
            }
        });
        showAuthSpinner(false);
        if(error){alert('Error: '+error.message);return;}
        if(data.user){
            await supabaseClient.from('profiles').upsert({id:data.user.id,name:name,email:email,avatar:'panda_normal'});
            document.getElementById('confirmEmailAddress').textContent=email;
            document.getElementById('emailConfirmModal').style.display='flex';
        }
    } else {
        // Login validation
        if(!email){
            document.getElementById('errAuthEmail').classList.add('show');
            document.getElementById('authEmail').classList.add('input-error');
            hasError=true;
        }
        if(!password){
            document.getElementById('errAuthPassword').classList.add('show');
            document.getElementById('authPassword').classList.add('input-error');
            hasError=true;
        }
        
        if(hasError) return;
        
        showAuthSpinner(true);
        const {error} = await supabaseClient.auth.signInWithPassword({email:email,password:password});
        showAuthSpinner(false);
        if(error){
            if(error.message.includes('Invalid login')){
                alert('Email o contrase√±a incorrectos');
                document.getElementById('authEmail').classList.add('input-error');
                document.getElementById('authPassword').classList.add('input-error');
            }
            else if(error.message.includes('Email not confirmed')) alert('Confirma tu email antes de iniciar sesi√≥n. Revisa tu bandeja de entrada.');
            else alert('Error: '+error.message);
        } else {
            showScreen('homeScreen');
        }
    }
}

function clearAuthError(fieldId){
    const errId='err'+fieldId.charAt(0).toUpperCase()+fieldId.slice(1);
    document.getElementById(errId).classList.remove('show');
    document.getElementById(fieldId).classList.remove('input-error');
}

function checkPasswordStrength(){
    const pass=document.getElementById('authPassword').value;
    const strength=document.getElementById('passwordStrength');
    const bar=document.getElementById('passwordStrengthBar');
    const text=document.getElementById('passwordStrengthText');
    
    if(!pass || isAuthMode==='login'){
        strength.classList.remove('show');
        text.classList.remove('show');
        return;
    }
    
    strength.classList.add('show');
    let score=0;
    if(pass.length>=8) score++;
    if(pass.length>=12) score++;
    if(/[a-z]/.test(pass) && /[A-Z]/.test(pass)) score++;
    if(/[0-9]/.test(pass)) score++;
    if(/[^A-Za-z0-9]/.test(pass)) score++;
    
    bar.className='password-strength-bar';
    if(score<=2){
        bar.classList.add('password-strength-weak');
        text.textContent='‚ö†Ô∏è Contrase√±a d√©bil';
        text.style.color='#ef4444';
    }else if(score<=4){
        bar.classList.add('password-strength-medium');
        text.textContent='üëç Contrase√±a media';
        text.style.color='#f59e0b';
    }else{
        bar.classList.add('password-strength-strong');
        text.textContent='‚úÖ ¬°Contrase√±a fuerte!';
        text.style.color='#10b981';
    }
    text.classList.add('show');
}

function openEmailApp(){
    const email=document.getElementById('confirmEmailAddress').textContent;
    if(email.includes('@gmail.')) window.open('https://mail.google.com','_blank');
    else if(email.includes('@outlook.') || email.includes('@hotmail.')) window.open('https://outlook.live.com','_blank');
    else if(email.includes('@yahoo.')) window.open('https://mail.yahoo.com','_blank');
    else window.location.href='mailto:';
}

function closeEmailModal(){
    document.getElementById('emailConfirmModal').style.display='none';
    showScreen('authScreen');
}

function showAuthSpinner(show){
    document.getElementById('authSpinner').className='auth-spinner'+(show?' show':'');
    document.getElementById('authBtn').style.display=show?'none':'block';
}

function toggleAuthMode(){
    isAuthMode=isAuthMode==='login'?'register':'login';
    document.getElementById('authTitle').textContent=isAuthMode==='register'?'Crear Cuenta':'Inicia Sesi√≥n';
    document.getElementById('authBtn').textContent=isAuthMode==='register'?'Registrarse':'Iniciar Sesi√≥n';
    document.getElementById('authToggleLink').textContent=isAuthMode==='register'?'Inicia sesi√≥n':'Reg√≠strate';
    document.getElementById('nameGroup').style.display=isAuthMode==='register'?'block':'none';
    document.getElementById('emailSentMsg').style.display='none';
    // Clear errors and password strength
    document.querySelectorAll('.field-error').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('input').forEach(i=>i.classList.remove('input-error'));
    document.getElementById('passwordStrength').classList.remove('show');
    document.getElementById('passwordStrengthText').classList.remove('show');
    checkPasswordStrength();
}

async function logout(){
    await supabaseClient.auth.signOut();
    showScreen('homeScreen');
}

// ===== NAVIGATION =====
function navigateTo(dest){
    switch(dest){
        case 'home': showScreen('homeScreen'); break;
        case 'ranking': loadGlobalRanking(); showScreen('rankingScreen'); break;
        case 'myTastings': if(!authenticatedUser){showScreen('authScreen');break;} loadUserTastings(); showScreen('myTastingsScreen'); break;
        case 'favs': if(!authenticatedUser){showScreen('authScreen');break;} loadFavLists(); renderFavs(); showScreen('favsScreen'); break;
        case 'auth': showScreen('authScreen'); break;
        case 'profile': if(!authenticatedUser){showScreen('authScreen');break;} loadProfileData(); showScreen('profileScreen'); break;
    }
}
function setActiveNav(sid){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const map={homeScreen:'nav-home',rankingScreen:'nav-ranking',favsScreen:'nav-favs',myTastingsScreen:'nav-mytastings',profileScreen:'nav-profile',authScreen:'nav-profile',editProfileScreen:'nav-profile'};
    const el=document.getElementById(map[sid]); if(el) el.classList.add('active');
}
function showScreen(sid){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(sid).classList.add('active');
    setActiveNav(sid);
    const bb=document.getElementById('backBtn');
    if(sid==='homeScreen'){
        bb.style.display='none';
        document.getElementById('headerSubtitle').textContent='Catas de productos en grupo';
        loadRecentTastings();
    }
    else if(['rankingScreen','favsScreen','myTastingsScreen','profileScreen','authScreen'].includes(sid)){
        bb.style.display='none';
        const titles={rankingScreen:'Ranking Global',favsScreen:'Favoritos',myTastingsScreen:'Mis Catas',profileScreen:'Mi Perfil',authScreen:'Cuenta'};
        document.getElementById('headerSubtitle').textContent=titles[sid]||'';
    } else {
        bb.style.display='block';
        bb.onclick=function(){
            if(sid==='manageParticipantsScreen') {
                showProductSelectionScreen();
            }
            else if(sid==='votingScreen') {
                showProductSelectionScreen();
            }
            else if(sid==='waitingVotesScreen') {
                showProductSelectionScreen();
            }
            else if(sid==='resultsScreen') {
                showProductSelectionScreen();
            }
            else if(sid==='editCataScreen') {
                showProductSelectionScreen();
            }
            else if(sid==='archiveScreen') {
                showScreen('myTastingsScreen');
            }
            else if(sid==='editProfileScreen') {
                showScreen('profileScreen');
            }
            else if(sid==='waitingScreen' || sid==='addProductsScreen' || sid==='productSelectionScreen') {
                showScreen('homeScreen');
            }
            else {
                showScreen('homeScreen');
            }
        };
        const subtitles={waitingScreen:'Sala de espera',addProductsScreen:'A√±adir productos',productSelectionScreen:'Cata en curso',editCataScreen:'Editar cata',votingScreen:'Votar producto',resultsScreen:'Resultados',archiveScreen:'Cata archivada',manageParticipantsScreen:'Participantes',editProfileScreen:'Editar perfil',waitingVotesScreen:'Esperando votos'};
        document.getElementById('headerSubtitle').textContent=subtitles[sid]||'';
    }
    if(sid==='profileScreen'&&authenticatedUser){
        document.getElementById('profileName').textContent=authenticatedUser.name;
        document.getElementById('profileEmail').textContent=authenticatedUser.email;
        document.getElementById('profileAvatarBig').innerHTML='<span style="font-size:2.5rem;font-weight:700;color:white;">'+authenticatedUser.name[0].toUpperCase()+'</span>';
    }
    // FAB: show on all active-tasting screens (not finished, not archive-only)
    const fab=document.getElementById('inviteFab');
    const fabScreens=['waitingScreen','addProductsScreen','productSelectionScreen','editCataScreen','votingScreen','resultsScreen','manageParticipantsScreen'];
    if(currentTasting && currentTasting.status!=='finished' && fabScreens.includes(sid)){fab.classList.add('show');}
    else{fab.classList.remove('show');}
}

// ===== INVITE / SHARE =====
function openShareModal(){
    if(!currentTasting)return;
    document.getElementById('inviteModalCode').textContent=currentTasting.code;
    document.getElementById('inviteModal').style.display='flex';
}
function copyInviteCode(){
    navigator.clipboard.writeText(currentTasting.code).then(function(){
        const btn=document.getElementById('copyCodeBtn');
        btn.innerHTML='üìã ¬°Copiado!';
        setTimeout(function(){btn.innerHTML='üìã Copiar c√≥digo';},1400);
    }).catch(function(){
        // fallback
        const t=document.createElement('textarea');t.value=currentTasting.code;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);
        const btn=document.getElementById('copyCodeBtn');btn.innerHTML='üìã ¬°Copiado!';setTimeout(function(){btn.innerHTML='üìã Copiar c√≥digo';},1400);
    });
}
function shareInvite(){
    const text='√önete a la cata "'+currentTasting.name+'" con el c√≥digo: '+currentTasting.code;
    if(navigator.share){navigator.share({title:'TasteScore ‚Äì '+currentTasting.name,text:text}).catch(function(){});}
    else{copyInviteCode();}
}

// ===== RANKING =====
function loadGlobalRanking(){globalRanking=JSON.parse(localStorage.getItem('globalRanking')||'{}');displayGlobalRanking();}
function updateGlobalRanking(name,brand,image,score){
    const key=(name+'|'+brand).toLowerCase();
    if(!globalRanking[key]) globalRanking[key]={name,brand,image,totalScore:0,voteCount:0,avgScore:0};
    globalRanking[key].totalScore+=score; globalRanking[key].voteCount++;
    globalRanking[key].avgScore=globalRanking[key].totalScore/globalRanking[key].voteCount;
    if(image) globalRanking[key].image=image;
    localStorage.setItem('globalRanking',JSON.stringify(globalRanking));
}
function displayGlobalRanking(){
    const c=document.getElementById('rankingList');
    const sorted=Object.values(globalRanking).sort((a,b)=>b.avgScore-a.avgScore).slice(0,50);
    if(!sorted.length){c.innerHTML='<div class="empty-state"><div class="icon">üèÜ</div><p>A√∫n no hay productos.<br>¬°S√© el primero en votar!</p></div>';return;}
    c.innerHTML=sorted.map((p,i)=>{
        const cls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        return `<div class="ranking-item"><div class="ranking-position ${cls}">${i+1}</div><img src="${p.image||''}" class="product-image" onerror="this.style.display='none'"><div class="product-info"><h4>${p.name}</h4><p>${p.brand} ‚Ä¢ ${p.voteCount} voto${p.voteCount===1?'':'s'}</p></div><div class="product-score">${p.avgScore.toFixed(1)}</div>${authenticatedUser?'<button onclick="toggleFav(\''+p.name.replace(/'/g,"\\'")+'\',' + "'"+p.brand.replace(/'/g,"\\'")+"'" + ',\''+((p.image||'')).replace(/'/g,"\\'")+'\')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;padding:0.2rem;flex-shrink:0;">'+(isFav(p.name,p.brand)?'‚ù§Ô∏è':'ü§ç')+'</button>':''}</div>`;
    }).join('');
}

// ===== MY TASTINGS =====
async function loadUserTastings(){
    if(!authenticatedUser) return;
    
    // Reutilizar la misma funci√≥n que la home
    await loadRecentTastings('userTastingsList');
}

// ===== FAVOURITES =====
function getFavData(){return JSON.parse(localStorage.getItem('favourites')||'{"__default__":[]}');}
function saveFavData(d){localStorage.setItem('favourites',JSON.stringify(d));}
function loadFavLists(){const data=getFavData();const sel=document.getElementById('favListSelector');sel.innerHTML='';Object.keys(data).forEach(k=>{sel.innerHTML+='<option value="'+k+'">'+(k==='__default__'?'Mi lista principal':k)+'</option>';});}
function isFav(name,brand){const data=getFavData();return Object.values(data).some(list=>list.some(p=>p.name===name&&p.brand===brand));}
function toggleFav(name,brand,image){
    const data=getFavData();
    for(const key of Object.keys(data)){const idx=data[key].findIndex(p=>p.name===name&&p.brand===brand);if(idx!==-1){data[key].splice(idx,1);saveFavData(data);if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();return;}}
    const sel=document.getElementById('favListSelector');const listKey=sel?sel.value:'__default__';
    if(!data[listKey])data[listKey]=[];data[listKey].push({name,brand,image:image||''});saveFavData(data);
    if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();
    if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();
}
function renderFavs(){
    const data=getFavData();const sel=document.getElementById('favListSelector');const items=data[sel.value]||[];const c=document.getElementById('favsList');
    if(!items.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">ü§ç</div><p>Lista vac√≠a.<br>A√±ade productos desde el Ranking.</p></div>';return;}
    c.innerHTML=items.map((p,i)=>`<div class="fav-item"><img src="${p.image||''}" onerror="this.style.display='none'" style="width:48px;height:48px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"><div class="fav-info"><h4>${p.name}</h4><p>${p.brand}</p></div><button class="fav-remove" onclick="removeFavFromList('${sel.value}',${i})">üóëÔ∏è</button></div>`).join('');
}
function removeFavFromList(k,i){const data=getFavData();data[k].splice(i,1);saveFavData(data);renderFavs();}
function createNewFavList(){const name=prompt('Nombre de la nueva lista:');if(!name||!name.trim())return;const key=name.trim();const data=getFavData();if(data[key]){alert('Ya existe esa lista');return;}data[key]=[];saveFavData(data);loadFavLists();document.getElementById('favListSelector').value=key;renderFavs();}

// ===== DEDUP =====
function normalizeProductName(n){return(n||'').toLowerCase().replace(/\s+/g,' ').replace(/[√°√†√§]/g,'a').replace(/[√©√®√´]/g,'e').replace(/[√≠√¨√Ø]/g,'i').replace(/[√≥√≤√∂]/g,'o').replace(/[√∫√π√º]/g,'u').trim();}
function deduplicateProducts(products){const seen=new Map();products.forEach(p=>{const key=normalizeProductName(p.product_name)+'|'+normalizeProductName(p.brands);if(!seen.has(key))seen.set(key,p);else{const ex=seen.get(key);if(p.image_url&&!ex.image_url)ex.image_url=p.image_url;}});return Array.from(seen.values());}

// ===== TASTING FLOW =====
function generateCode(){return Math.random().toString(36).substring(2,8).toUpperCase();}

// Share functionality
function getShareLink() {
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}?join=${currentTasting.code}`;
}

function shareViaWhatsApp() {
    const link = getShareLink();
    const message = encodeURIComponent(`¬°√önete a mi cata "${currentTasting.name}"! üç∑\n\nC√≥digo: ${currentTasting.code}\n\nO haz clic aqu√≠ para unirte directamente:\n${link}`);
    window.open(`https://wa.me/?text=${message}`, '_blank');
}

function copyShareLink() {
    const link = getShareLink();
    
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(link).then(() => {
            showToast('‚úì Enlace copiado al portapapeles');
        }).catch(() => {
            fallbackCopyToClipboard(link);
        });
    } else {
        fallbackCopyToClipboard(link);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        showToast('‚úì Enlace copiado al portapapeles');
    } catch (err) {
        showToast('‚ùå No se pudo copiar. C√≥digo: ' + currentTasting.code);
    }
    document.body.removeChild(textArea);
}

function showToast(message) {
    // Remove existing toast if any
    const existingToast = document.getElementById('toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.id = 'toast';
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:white;padding:0.75rem 1.25rem;border-radius:8px;font-size:0.875rem;z-index:10000;backdrop-filter:blur(10px);animation:slideUp 0.3s ease;';
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

// Auto-join from URL parameter
async function checkAutoJoin() {
    console.log('checkAutoJoin called');
    console.log('Current URL:', window.location.href);
    console.log('Search params:', window.location.search);
    
    const urlParams = new URLSearchParams(window.location.search);
    const joinCode = urlParams.get('join');
    
    console.log('Join code detected:', joinCode);
    
    if (joinCode) {
        console.log('Auto-join detected with code:', joinCode);
        
        // Clear the URL parameter to clean up the address bar
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('URL cleaned to:', cleanUrl);
        
        // Wait a moment for DOM to be ready
        setTimeout(() => {
            // Pre-fill the join code
            const joinCodeInput = document.getElementById('joinCode');
            if (joinCodeInput) {
                joinCodeInput.value = joinCode.toUpperCase();
                console.log('Join code input filled with:', joinCode.toUpperCase());
            } else {
                console.error('joinCode input not found!');
            }
            
            // If user is authenticated, pre-fill name
            if (authenticatedUser) {
                const participantNameInput = document.getElementById('participantName');
                if (participantNameInput) {
                    participantNameInput.value = authenticatedUser.name;
                    console.log('Participant name pre-filled with:', authenticatedUser.name);
                }
            }
            
            // Show join screen
            console.log('Showing join screen');
            showScreen('joinScreen');
            
            // Show a message
            showToast('üìã Introduce tu nombre para unirte a la cata');
        }, 100);
    } else {
        console.log('No join code in URL');
    }
}

async function createTasting(){
    const name=document.getElementById('tastingName').value.trim();
    let hostName=document.getElementById('hostName').value.trim();
    const desc=document.getElementById('tastingDescription').value.trim();
    const date=document.getElementById('tastingDate').value;
    // Pre-fill from authenticated user if empty
    if(!hostName && authenticatedUser) hostName=authenticatedUser.name;
    // Inline validation
    let hasError=false;
    const errN=document.getElementById('errTastingName'), errH=document.getElementById('errHostName');
    const fieldN=document.getElementById('fieldTastingName'), fieldH=document.getElementById('fieldHostName');
    if(!name){errN.classList.add('show');fieldN.querySelector('input').style.borderColor='var(--error)';hasError=true;}
    else{errN.classList.remove('show');fieldN.querySelector('input').style.borderColor='';}
    if(!hostName){errH.classList.add('show');fieldH.querySelector('input').style.borderColor='var(--error)';hasError=true;}
    else{errH.classList.remove('show');fieldH.querySelector('input').style.borderColor='';}
    if(hasError)return;
    // Update field with auto-filled value
    document.getElementById('hostName').value=hostName;
    
    const code = generateCode();
    currentTasting={id:Date.now().toString(),code,name,description:desc,date:date||null,host:hostName,participants:[{name:hostName,isHost:true}],products:[],votes:{},status:'waiting',createdAt:new Date().toISOString(),userId:authenticatedUser?authenticatedUser.id:null};
    currentUser={name:hostName,isHost:true};
    
    await saveTasting();
    subscribeToTastingUpdates(); // Subscribe to realtime updates
    showWaitingRoom();
}

async function joinTasting(){
    const code=document.getElementById('joinCode').value.trim().toUpperCase();
    let name=document.getElementById('participantName').value.trim();
    // Pre-fill from authenticated user if empty
    if(!name && authenticatedUser) name=authenticatedUser.name;
    if(!code||!name){alert('Completa c√≥digo y nombre');return;}
    const t=await loadTastingByCode(code);
    if(!t){alert('C√≥digo no encontrado');return;}
    if(t.status==='finished'){alert('Esta cata ya finaliz√≥');return;}
    currentTasting=t; currentUser={name,isHost:false};
    if(!currentTasting.participants.find(p=>p.name===name)){currentTasting.participants.push(currentUser);await saveTasting();}
    subscribeToTastingUpdates(); // Subscribe to realtime updates
    if(currentTasting.status==='waiting') showWaitingRoom();
    else if(currentTasting.status==='voting') showProductSelectionScreen();
    else showWaitingRoom();
}

function showWaitingRoom(){
    document.getElementById('waitingTastingName').textContent=currentTasting.name;
    document.getElementById('displayCode').textContent=currentTasting.code;
    if(currentTasting.date){
        document.getElementById('waitingTastingDate').style.display='block';
        document.getElementById('waitingDateText').textContent=new Date(currentTasting.date+'T12:00:00').toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else { document.getElementById('waitingTastingDate').style.display='none'; }
    updateParticipantsList();
    
    // Mostrar bot√≥n apropiado seg√∫n el estado y si es el host
    const startBtn = document.getElementById('startBtn');
    const continueBtn = document.getElementById('continueBtn');
    
    if (currentUser.isHost) {
        if (currentTasting.status === 'waiting') {
            // Cata sin empezar - mostrar "Comenzar Cata"
            startBtn.style.display = 'block';
            continueBtn.style.display = 'none';
        } else if (currentTasting.status === 'adding_products') {
            // Cata en proceso de a√±adir productos - mostrar "Continuar"
            startBtn.style.display = 'none';
            continueBtn.style.display = 'block';
        } else {
            // Otros estados
            startBtn.style.display = 'none';
            continueBtn.style.display = 'none';
        }
    } else {
        // No es el host - ocultar ambos botones
        startBtn.style.display = 'none';
        continueBtn.style.display = 'none';
    }
    
    showScreen('waitingScreen');
}

function continueTasting() {
    if (!currentUser.isHost) return;
    
    // Navegar seg√∫n el estado actual
    if (currentTasting.status === 'adding_products') {
        updateAddedProducts();
        showScreen('addProductsScreen');
    } else if (currentTasting.status === 'voting') {
        updateProductSelectionList();
        showProductSelectionScreen();
    }
}

function updateParticipantsList(){
    document.getElementById('participantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost && !p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë Anfitri√≥n</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï Eliminar</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

async function promoteToHost(idx){
    // remove current host flag
    currentTasting.participants.forEach(p=>p.isHost=false);
    currentTasting.participants[idx].isHost=true;
    currentTasting.host=currentTasting.participants[idx].name;
    // update currentUser
    if(currentUser.name===currentTasting.participants[idx].name) currentUser.isHost=true;
    else currentUser.isHost=false;
    await saveTasting(); updateParticipantsList();
    // refresh manage screen if open
    if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
}

async function kickParticipant(idx){
    const name=currentTasting.participants[idx].name;
    if(confirm('¬øEliminar a '+name+' de la cata?')){
        currentTasting.participants.splice(idx,1);
        await saveTasting(); updateParticipantsList();
        if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
    }
}

async function startTasting(){
    if(!currentUser.isHost)return;
    currentTasting.status='adding_products'; await saveTasting();
    showScreen('addProductsScreen'); updateAddedProducts();
}

// ===== MANAGE PARTICIPANTS (during voting) =====
function showManageParticipants(){
    renderManageParticipants();
    showScreen('manageParticipantsScreen');
}
function renderManageParticipants(){
    document.getElementById('manageMiniCode').textContent=currentTasting.code;
    document.getElementById('manageParticipantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost&&!p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

// ===== SCANNER =====
function openScanner(){
    scannerTargetScreen=document.getElementById('editCataScreen').classList.contains('active')?'editCataScreen':'addProductsScreen';
    const modal=document.getElementById('scannerModal');modal.classList.add('active');
    document.getElementById('scannerStatus').textContent='Iniciando c√°mara...';
    if(html5QrCode){try{html5QrCode.stop();}catch(e){} html5QrCode=null;}
    document.getElementById('reader').innerHTML='';
    html5QrCode=new Html5Qrcode("reader",{verbose:false});
    Html5Qrcode.getCameras().then(function(cameras){
        if(!cameras||!cameras.length){document.getElementById('scannerStatus').textContent='No se encontr√≥ c√°mara';return;}
        let cameraId=cameras.length>1?cameras[cameras.length-1].id:cameras[0].id;
        document.getElementById('scannerStatus').textContent='Enfoca el c√≥digo de barras...';
        html5QrCode.start(cameraId,{fps:10,qrbox:{width:220,height:220}},
            function onDecode(text){
                document.getElementById('scannerStatus').textContent='C√≥digo detectado';
                html5QrCode.stop().then(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);}).catch(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);});
            },
            function onError(){}
        ).catch(function(err){document.getElementById('scannerStatus').textContent='Error al abrir c√°mara.';});
    }).catch(function(){document.getElementById('scannerStatus').textContent='Error al detectar c√°maras.';});
}
function closeScanner(){if(html5QrCode){html5QrCode.stop().catch(function(){});html5QrCode=null;}document.getElementById('reader').innerHTML='';document.getElementById('scannerModal').classList.remove('active');}
async function searchProductByBarcode(barcode){
    try{
        const res=await fetch('https://world.openfoodfacts.org/api/v0/product/'+barcode+'.json');
        const data=await res.json();
        if(data.status===1&&data.product){
            const p=data.product;const product={name:p.product_name||'Producto sin nombre',brand:p.brands||'Marca desconocida',image:p.image_url||''};
            if(scannerTargetScreen==='editCataScreen')addProductFromEdit(product);else addProduct(product);
        } else alert('Producto no encontrado. A√±√°delo manualmente.');
    }catch(e){alert('Error al buscar. Comprueba tu conexi√≥n.');}
}

// ===== PRODUCT SEARCH =====
async function searchProducts(){
    const q=document.getElementById('productSearch').value.trim();
    if(q.length<3){document.getElementById('searchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('searchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProduct('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('searchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}
async function searchProductsEdit(){
    const q=document.getElementById('editProductSearch').value.trim();
    if(q.length<3){document.getElementById('editSearchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('editSearchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProductFromEdit('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('editSearchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}

function toggleManualForm(){const f=document.getElementById('manualProductForm');f.style.display=f.style.display==='none'?'block':'none';}
function toggleManualFormEdit(){const f=document.getElementById('manualProductFormEdit');f.style.display=f.style.display==='none'?'block':'none';}
function addManualProduct(){const n=document.getElementById('manualProductName').value.trim(),b=document.getElementById('manualProductBrand').value.trim(),img=document.getElementById('manualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProduct({name:n,brand:b,image:img});document.getElementById('manualProductName').value='';document.getElementById('manualProductBrand').value='';document.getElementById('manualProductImage').value='';toggleManualForm();}
function addManualProductEdit(){const n=document.getElementById('editManualProductName').value.trim(),b=document.getElementById('editManualProductBrand').value.trim(),img=document.getElementById('editManualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProductFromEdit({name:n,brand:b,image:img});document.getElementById('editManualProductName').value='';document.getElementById('editManualProductBrand').value='';document.getElementById('editManualProductImage').value='';toggleManualFormEdit();}

// ===== TABS =====
function switchProductTab(tab){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(t=>t.classList.remove('active'));
    if(tab==='supermarket'){
        tabs[0].classList.add('active');
        document.getElementById('supermarketTab').style.display='block';
        document.getElementById('restaurantTab').style.display='none';
    } else {
        tabs[1].classList.add('active');
        document.getElementById('supermarketTab').style.display='none';
        document.getElementById('restaurantTab').style.display='block';
    }
}

// Funciones para modo edici√≥n
function switchEditProductTab(tab){
    const tabs=document.querySelectorAll('#editCataScreen .tab');
    tabs.forEach(t=>t.classList.remove('active'));
    if(tab==='supermarket'){
        tabs[0].classList.add('active');
        document.getElementById('editSupermarketTab').style.display='block';
        document.getElementById('editRestaurantTab').style.display='none';
    } else {
        tabs[1].classList.add('active');
        document.getElementById('editSupermarketTab').style.display='none';
        document.getElementById('editRestaurantTab').style.display='block';
    }
}

function loadEditRestaurantCategories() {
    const restaurant = document.getElementById('editRestaurantSelect').value;
    document.getElementById('editRestaurantEmptyState').style.display = 'none';
    
    if (!restaurant) {
        document.getElementById('editCategoryTabs').style.display = 'none';
        document.getElementById('editRestaurantSearchBox').style.display = 'none';
        document.getElementById('editRestaurantProductsGrid').innerHTML = '';
        document.getElementById('editRestaurantEmptyState').style.display = 'block';
        return;
    }
    
    const categories = Object.keys(RESTAURANT_DATA[restaurant]);
    const tabsHtml = categories.map((cat, i) => 
        `<button class="category-tab ${i===0?'active':''}" onclick="switchEditRestaurantCategory('${cat}')">${cat}</button>`
    ).join('');
    
    document.getElementById('editCategoryTabs').innerHTML = tabsHtml;
    document.getElementById('editCategoryTabs').style.display = 'flex';
    document.getElementById('editRestaurantSearchBox').style.display = 'block';
    
    selectedRestaurant = restaurant;
    selectedCategory = categories[0];
    renderEditRestaurantProducts();
}

function switchEditRestaurantCategory(category) {
    selectedCategory = category;
    const tabs = document.querySelectorAll('#editCategoryTabs .category-tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    renderEditRestaurantProducts();
}

function renderEditRestaurantProducts() {
    const products = RESTAURANT_DATA[selectedRestaurant][selectedCategory];
    const searchTerm = document.getElementById('editRestaurantProductSearch').value.toLowerCase();
    
    const filteredProducts = searchTerm 
        ? products.filter(p => p.name.toLowerCase().includes(searchTerm))
        : products;
    
    const html = filteredProducts.map(product => `
        <div class="restaurant-product-card">
            <img src="${product.image}" alt="${product.name}" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'">
            <h4>${product.name}</h4>
            <button class="add-btn" onclick='addProductFromEdit({name:"${product.name}",brand:"${product.brand}"})'>+ A√±adir</button>
        </div>
    `).join('');
    
    document.getElementById('editRestaurantProductsGrid').innerHTML = html || '<p style="text-align:center;color:var(--text-secondary);padding:2rem;">No se encontraron productos</p>';
}

function filterEditRestaurantProducts() {
    renderEditRestaurantProducts();
}


// ===== RESTAURANTES =====
const RESTAURANT_DATA = {
    "McDonald's": {
        "Hamburguesas": [
            {name:"Big Mac",brand:"McDonald's"},
            {name:"Quarter Pounder con Queso",brand:"McDonald's"},
            {name:"Doble Quarter Pounder con Queso",brand:"McDonald's"},
            {name:"Big Tasty",brand:"McDonald's"},
            {name:"Big Tasty Bacon",brand:"McDonald's"},
            {name:"McRoyal Deluxe",brand:"McDonald's"},
            {name:"Grand McExtreme Bacon",brand:"McDonald's"},
            {name:"Grand McExtreme Cheddar & Onion",brand:"McDonald's"},
            {name:"McPollo",brand:"McDonald's"},
            {name:"Doble McPollo",brand:"McDonald's"},
            {name:"McChicken",brand:"McDonald's"},
            {name:"Filet-O-Fish",brand:"McDonald's"},
            {name:"CBO (Pollo, Bacon y Cebolla)",brand:"McDonald's"},
            {name:"Hamburguesa con Queso",brand:"McDonald's"},
            {name:"Hamburguesa",brand:"McDonald's"},
            {name:"McVeggie",brand:"McDonald's"}
        ],
        "McNuggets y Alitas": [
            {name:"McNuggets x4",brand:"McDonald's"},
            {name:"McNuggets x6",brand:"McDonald's"},
            {name:"McNuggets x9",brand:"McDonald's"},
            {name:"McNuggets x20",brand:"McDonald's"},
            {name:"McWings x3",brand:"McDonald's"},
            {name:"McWings x6",brand:"McDonald's"},
            {name:"McWings x9",brand:"McDonald's"}
        ],
        "Patatas y Acompa√±amientos": [
            {name:"Patatas Fritas Peque√±as",brand:"McDonald's"},
            {name:"Patatas Fritas Medianas",brand:"McDonald's"},
            {name:"Patatas Fritas Grandes",brand:"McDonald's"},
            {name:"Patatas Deluxe Peque√±as",brand:"McDonald's"},
            {name:"Patatas Deluxe Medianas",brand:"McDonald's"},
            {name:"Patatas Deluxe Grandes",brand:"McDonald's"},
            {name:"Aros de Cebolla x5",brand:"McDonald's"},
            {name:"Aros de Cebolla x9",brand:"McDonald's"}
        ],
        "Ensaladas": [
            {name:"Ensalada C√©sar con Pollo",brand:"McDonald's"},
            {name:"Ensalada Mixta",brand:"McDonald's"}
        ],
        "Postres": [
            {name:"McFlurry Oreo",brand:"McDonald's"},
            {name:"McFlurry KitKat",brand:"McDonald's"},
            {name:"McFlurry M&M's",brand:"McDonald's"},
            {name:"McFlurry Lacasitos",brand:"McDonald's"},
            {name:"Sundae Caramelo",brand:"McDonald's"},
            {name:"Sundae Chocolate",brand:"McDonald's"},
            {name:"Sundae Fresa",brand:"McDonald's"},
            {name:"Donuts Chocolate",brand:"McDonald's"},
            {name:"Donuts Glaseado",brand:"McDonald's"},
            {name:"Tarta de Manzana",brand:"McDonald's"},
            {name:"Muffin Chocolate",brand:"McDonald's"},
            {name:"McBrownie",brand:"McDonald's"},
            {name:"Cookies",brand:"McDonald's"}
        ],
        "Bebidas Fr√≠as": [
            {name:"Coca-Cola",brand:"McDonald's"},
            {name:"Coca-Cola Zero",brand:"McDonald's"},
            {name:"Fanta Naranja",brand:"McDonald's"},
            {name:"Sprite",brand:"McDonald's"},
            {name:"Aquarius Naranja",brand:"McDonald's"},
            {name:"Agua Mineral",brand:"McDonald's"},
            {name:"Zumo Naranja",brand:"McDonald's"},
            {name:"Batido Chocolate",brand:"McDonald's"},
            {name:"Batido Vainilla",brand:"McDonald's"},
            {name:"Batido Fresa",brand:"McDonald's"},
            {name:"McShake Oreo",brand:"McDonald's"}
        ],
        "Bebidas Calientes": [
            {name:"Caf√© Solo",brand:"McDonald's"},
            {name:"Caf√© con Leche",brand:"McDonald's"},
            {name:"Cappuccino",brand:"McDonald's"},
            {name:"Latte",brand:"McDonald's"},
            {name:"Cortado",brand:"McDonald's"},
            {name:"Chocolate Caliente",brand:"McDonald's"},
            {name:"T√©",brand:"McDonald's"}
        ],
        "Desayunos": [
            {name:"McMuffin Huevo y Bacon",brand:"McDonald's"},
            {name:"McMuffin Salchicha y Huevo",brand:"McDonald's"},
            {name:"Bagel Bacon",brand:"McDonald's"},
            {name:"Croissant Jam√≥n y Queso",brand:"McDonald's"},
            {name:"McToast",brand:"McDonald's"},
            {name:"Tortitas con Sirope",brand:"McDonald's"}
        ]
    },
    "Burger King": {
        "Hamburguesas": [
            {name:"Whopper",brand:"Burger King"},
            {name:"Whopper con Queso",brand:"Burger King"},
            {name:"Doble Whopper",brand:"Burger King"},
            {name:"Triple Whopper",brand:"Burger King"},
            {name:"Whopper Jr",brand:"Burger King"},
            {name:"Bacon King",brand:"Burger King"},
            {name:"Doble Bacon King",brand:"Burger King"},
            {name:"Big King",brand:"Burger King"},
            {name:"Big King XXL",brand:"Burger King"},
            {name:"Steakhouse",brand:"Burger King"},
            {name:"Steakhouse Bacon",brand:"Burger King"},
            {name:"Chicken Royale",brand:"Burger King"},
            {name:"Long Chicken",brand:"Burger King"},
            {name:"Crispy Chicken",brand:"Burger King"},
            {name:"Whopper Vegetal",brand:"Burger King"},
            {name:"Hamburguesa con Queso",brand:"Burger King"},
            {name:"Hamburguesa",brand:"Burger King"}
        ],
        "Nuggets y Alitas": [
            {name:"Nuggets x4",brand:"Burger King"},
            {name:"Nuggets x6",brand:"Burger King"},
            {name:"Nuggets x9",brand:"Burger King"},
            {name:"Nuggets x20",brand:"Burger King"},
            {name:"Alitas x4",brand:"Burger King"},
            {name:"Alitas x6",brand:"Burger King"},
            {name:"Alitas x9",brand:"Burger King"}
        ],
        "Patatas y Acompa√±amientos": [
            {name:"Patatas Peque√±as",brand:"Burger King"},
            {name:"Patatas Medianas",brand:"Burger King"},
            {name:"Patatas Grandes",brand:"Burger King"},
            {name:"Aros de Cebolla x4",brand:"Burger King"},
            {name:"Aros de Cebolla x6",brand:"Burger King"},
            {name:"Aros de Cebolla x9",brand:"Burger King"},
            {name:"Ensalada C√©sar",brand:"Burger King"}
        ],
        "Postres": [
            {name:"Sundae Caramelo",brand:"Burger King"},
            {name:"Sundae Chocolate",brand:"Burger King"},
            {name:"Sundae Fresa",brand:"Burger King"},
            {name:"King Fusion Oreo",brand:"Burger King"},
            {name:"King Fusion KitKat",brand:"Burger King"},
            {name:"King Fusion Maltesers",brand:"Burger King"},
            {name:"Tarta de Queso",brand:"Burger King"},
            {name:"Donuts Chocolate",brand:"Burger King"},
            {name:"Donuts Az√∫car",brand:"Burger King"},
            {name:"Cookies",brand:"Burger King"}
        ],
        "Bebidas": [
            {name:"Coca-Cola",brand:"Burger King"},
            {name:"Coca-Cola Zero",brand:"Burger King"},
            {name:"Fanta Naranja",brand:"Burger King"},
            {name:"Sprite",brand:"Burger King"},
            {name:"Nestea",brand:"Burger King"},
            {name:"Aquarius",brand:"Burger King"},
            {name:"Agua Mineral",brand:"Burger King"},
            {name:"Zumo Naranja",brand:"Burger King"},
            {name:"Batido Chocolate",brand:"Burger King"},
            {name:"Batido Fresa",brand:"Burger King"},
            {name:"Batido Vainilla",brand:"Burger King"},
            {name:"Caf√©",brand:"Burger King"}
        ]
    },
    "KFC": {
        "Cubos y Men√∫s": [
            {name:"Bucket 6 Piezas Pollo",brand:"KFC"},
            {name:"Bucket 9 Piezas Pollo",brand:"KFC"},
            {name:"Bucket 14 Piezas Pollo",brand:"KFC"},
            {name:"Bucket 21 Piezas Pollo",brand:"KFC"},
            {name:"Bucket Familiar Variado",brand:"KFC"},
            {name:"Colonel Box",brand:"KFC"},
            {name:"Twister Box",brand:"KFC"}
        ],
        "Hamburguesas": [
            {name:"Zinger",brand:"KFC"},
            {name:"Doble Zinger",brand:"KFC"},
            {name:"Colonel",brand:"KFC"},
            {name:"Doble Colonel",brand:"KFC"},
            {name:"Tower",brand:"KFC"},
            {name:"Kentucky",brand:"KFC"},
            {name:"Twister (Wrap)",brand:"KFC"}
        ],
        "Tiras y Alitas": [
            {name:"Hot Wings x6",brand:"KFC"},
            {name:"Hot Wings x9",brand:"KFC"},
            {name:"Hot Wings x18",brand:"KFC"},
            {name:"Tiras de Pollo x3",brand:"KFC"},
            {name:"Tiras de Pollo x5",brand:"KFC"},
            {name:"Tiras de Pollo x9",brand:"KFC"},
            {name:"Popcorn Chicken Regular",brand:"KFC"},
            {name:"Popcorn Chicken Grande",brand:"KFC"}
        ],
        "Acompa√±amientos": [
            {name:"Patatas Fritas Regulares",brand:"KFC"},
            {name:"Patatas Fritas Grandes",brand:"KFC"},
            {name:"Patatas Deluxe",brand:"KFC"},
            {name:"Ensalada Coleslaw",brand:"KFC"},
            {name:"Mazorca de Ma√≠z",brand:"KFC"},
            {name:"Pur√© de Patata",brand:"KFC"},
            {name:"Panecillo",brand:"KFC"}
        ],
        "Postres": [
            {name:"Tarta de Queso",brand:"KFC"},
            {name:"Cookies con Pepitas de Chocolate",brand:"KFC"},
            {name:"Helado Soft",brand:"KFC"},
            {name:"Brownie",brand:"KFC"}
        ],
        "Bebidas": [
            {name:"Pepsi",brand:"KFC"},
            {name:"Pepsi Zero",brand:"KFC"},
            {name:"7UP",brand:"KFC"},
            {name:"Kas Naranja",brand:"KFC"},
            {name:"Nestea",brand:"KFC"},
            {name:"Aquarius",brand:"KFC"},
            {name:"Agua Mineral",brand:"KFC"}
        ]
    },
    "Domino's": {
        "Pizzas Cl√°sicas": [
            {name:"Barbacoa",brand:"Domino's"},
            {name:"Carbonara",brand:"Domino's"},
            {name:"Margarita",brand:"Domino's"},
            {name:"4 Quesos",brand:"Domino's"},
            {name:"Pepperoni",brand:"Domino's"},
            {name:"Hawaiana",brand:"Domino's"},
            {name:"Vegetal",brand:"Domino's"},
            {name:"Bolo√±esa",brand:"Domino's"}
        ],
        "Pizzas Especiales": [
            {name:"Extravaganzza",brand:"Domino's"},
            {name:"Deluxe",brand:"Domino's"},
            {name:"Kebab",brand:"Domino's"},
            {name:"Mexicana",brand:"Domino's"},
            {name:"Mediterr√°nea",brand:"Domino's"}
        ],
        "Complementos": [
            {name:"Alitas Picantes x6",brand:"Domino's"},
            {name:"Alitas Picantes x12",brand:"Domino's"},
            {name:"Nuggets de Pollo",brand:"Domino's"},
            {name:"Pan de Ajo",brand:"Domino's"},
            {name:"Palitos de Pan con Queso",brand:"Domino's"},
            {name:"Patatas Gajo",brand:"Domino's"},
            {name:"Ensalada C√©sar",brand:"Domino's"}
        ],
        "Postres": [
            {name:"Brownie de Chocolate",brand:"Domino's"},
            {name:"Cookies con Pepitas",brand:"Domino's"},
            {name:"Lava Cake",brand:"Domino's"},
            {name:"Tarrina Ben & Jerry's",brand:"Domino's"}
        ],
        "Bebidas": [
            {name:"Coca-Cola",brand:"Domino's"},
            {name:"Coca-Cola Zero",brand:"Domino's"},
            {name:"Fanta Naranja",brand:"Domino's"},
            {name:"Sprite",brand:"Domino's"},
            {name:"Nestea",brand:"Domino's"},
            {name:"Agua Mineral",brand:"Domino's"}
        ]
    },
    "Telepizza": {
        "Pizzas Cl√°sicas": [
            {name:"Barbacoa",brand:"Telepizza"},
            {name:"Carbonara",brand:"Telepizza"},
            {name:"4 Estaciones",brand:"Telepizza"},
            {name:"Pepperoni",brand:"Telepizza"},
            {name:"Margarita",brand:"Telepizza"},
            {name:"4 Quesos",brand:"Telepizza"},
            {name:"Hawaiana",brand:"Telepizza"},
            {name:"Vegetal",brand:"Telepizza"}
        ],
        "Pizzas Especiales": [
            {name:"Telepizza Bacon",brand:"Telepizza"},
            {name:"Roquefort",brand:"Telepizza"},
            {name:"Campesina",brand:"Telepizza"},
            {name:"Extravaganzza",brand:"Telepizza"}
        ],
        "Complementos": [
            {name:"Alitas Picantes x6",brand:"Telepizza"},
            {name:"Alitas Picantes x12",brand:"Telepizza"},
            {name:"Fingers de Pollo",brand:"Telepizza"},
            {name:"Pan de Ajo",brand:"Telepizza"},
            {name:"Teque√±os",brand:"Telepizza"},
            {name:"Patatas Gajo",brand:"Telepizza"},
            {name:"Ensalada",brand:"Telepizza"}
        ],
        "Postres": [
            {name:"Brownie",brand:"Telepizza"},
            {name:"Cookies",brand:"Telepizza"},
            {name:"Helado Ben & Jerry's",brand:"Telepizza"}
        ],
        "Bebidas": [
            {name:"Coca-Cola",brand:"Telepizza"},
            {name:"Coca-Cola Zero",brand:"Telepizza"},
            {name:"Fanta",brand:"Telepizza"},
            {name:"Agua Mineral",brand:"Telepizza"}
        ]
    },
    "Papa John's": {
        "Pizzas": [{name:"Pepperoni",brand:"Papa John's"},{name:"BBQ Chicken",brand:"Papa John's"},{name:"Vegetariana",brand:"Papa John's"},{name:"4 Quesos",brand:"Papa John's"},{name:"Hawaiana",brand:"Papa John's"}],
        "Complementos": [{name:"Alitas B√∫falo",brand:"Papa John's"},{name:"Pan de Ajo",brand:"Papa John's"},{name:"Palitos Queso",brand:"Papa John's"}],
        "Salsas": [{name:"Ajo Especial",brand:"Papa John's"},{name:"BBQ",brand:"Papa John's"}],
        "Postres": [{name:"Brownie",brand:"Papa John's"},{name:"Cookies",brand:"Papa John's"}],
        "Bebidas": [{name:"Coca-Cola",brand:"Papa John's"},{name:"Pepsi",brand:"Papa John's"}]
    },
    "La Tagliatella": {
        "Pastas": [{name:"Carbonara",brand:"La Tagliatella"},{name:"Bolo√±esa",brand:"La Tagliatella"},{name:"Pesto",brand:"La Tagliatella"},{name:"Frutti di Mare",brand:"La Tagliatella"}],
        "Pizzas": [{name:"Margarita",brand:"La Tagliatella"},{name:"Prosciutto",brand:"La Tagliatella"},{name:"4 Quesos",brand:"La Tagliatella"}],
        "Entrantes": [{name:"Bruschetta",brand:"La Tagliatella"},{name:"Focaccia",brand:"La Tagliatella"},{name:"Caprese",brand:"La Tagliatella"}],
        "Postres": [{name:"Tiramis√∫",brand:"La Tagliatella"},{name:"Panna Cotta",brand:"La Tagliatella"}],
        "Bebidas": [{name:"Agua",brand:"La Tagliatella"},{name:"Vino",brand:"La Tagliatella"}]
    },
    "Ginos": {
        "Pastas": [{name:"Carbonara",brand:"Ginos"},{name:"Bolo√±esa",brand:"Ginos"},{name:"Pesto",brand:"Ginos"}],
        "Pizzas": [{name:"Margarita",brand:"Ginos"},{name:"Pepperoni",brand:"Ginos"},{name:"Vegetariana",brand:"Ginos"}],
        "Ensaladas": [{name:"C√©sar",brand:"Ginos"},{name:"Caprese",brand:"Ginos"}],
        "Postres": [{name:"Tiramis√∫",brand:"Ginos"},{name:"Brownie",brand:"Ginos"}],
        "Bebidas": [{name:"Coca-Cola",brand:"Ginos"},{name:"Agua",brand:"Ginos"}]
    },
    "VIPS": {
        "Hamburguesas": [{name:"VIPS Burger",brand:"VIPS"},{name:"Bacon Cheese",brand:"VIPS"}],
        "Ensaladas": [{name:"C√©sar",brand:"VIPS"},{name:"Pollo",brand:"VIPS"}],
        "S√°ndwiches": [{name:"Club S√°ndwich",brand:"VIPS"}],
        "Postres": [{name:"Tarta Zanahoria",brand:"VIPS"},{name:"Brownie",brand:"VIPS"}],
        "Bebidas": [{name:"Batido Fresa",brand:"VIPS"},{name:"Coca-Cola",brand:"VIPS"}]
    },
    "Foster's Hollywood": {
        "Hamburguesas": [{name:"Bacon Cheese",brand:"Foster's Hollywood"},{name:"BBQ Burger",brand:"Foster's Hollywood"}],
        "Costillas": [{name:"BBQ Ribs",brand:"Foster's Hollywood"}],
        "Complementos": [{name:"Aros Cebolla",brand:"Foster's Hollywood"},{name:"Nachos",brand:"Foster's Hollywood"}],
        "Postres": [{name:"Brownie",brand:"Foster's Hollywood"}],
        "Bebidas": [{name:"Coca-Cola",brand:"Foster's Hollywood"}]
    },
    "Tony Roma's": {
        "Costillas": [{name:"Baby Back",brand:"Tony Roma's"},{name:"St. Louis",brand:"Tony Roma's"}],
        "Carnes": [{name:"Filete",brand:"Tony Roma's"}],
        "Entrantes": [{name:"Aros Cebolla",brand:"Tony Roma's"}],
        "Postres": [{name:"Brownie",brand:"Tony Roma's"}],
        "Bebidas": [{name:"Coca-Cola",brand:"Tony Roma's"}]
    },
    "TGB": {
        "Hamburguesas": [{name:"The Good Burger",brand:"TGB"},{name:"Bacon Burger",brand:"TGB"},{name:"Veggie",brand:"TGB"}],
        "Complementos": [{name:"Patatas",brand:"TGB"},{name:"Nuggets",brand:"TGB"}],
        "Postres": [{name:"Brownie",brand:"TGB"}],
        "Bebidas": [{name:"Coca-Cola",brand:"TGB"},{name:"Batidos",brand:"TGB"}]
    },
    "100 Montaditos": {
        "Montaditos": [{name:"Lomo",brand:"100 Montaditos"},{name:"Tortilla",brand:"100 Montaditos"},{name:"Jam√≥n",brand:"100 Montaditos"},{name:"Bacon Cheese",brand:"100 Montaditos"}],
        "Complementos": [{name:"Patatas Bravas",brand:"100 Montaditos"},{name:"Nachos",brand:"100 Montaditos"}],
        "Postres": [{name:"Brownie",brand:"100 Montaditos"}],
        "Bebidas": [{name:"Cerveza",brand:"100 Montaditos"},{name:"Coca-Cola",brand:"100 Montaditos"}]
    },
    "Rodilla": {
        "Bocadillos": [{name:"Jam√≥n Serrano",brand:"Rodilla"},{name:"Pavo",brand:"Rodilla"},{name:"Tortilla",brand:"Rodilla"}],
        "Complementos": [{name:"Croissant Mixto",brand:"Rodilla"},{name:"Ensalada",brand:"Rodilla"}],
        "Postres": [{name:"Brownie",brand:"Rodilla"}],
        "Bebidas": [{name:"Caf√©",brand:"Rodilla"},{name:"Zumo",brand:"Rodilla"}]
    },
    "Starbucks": {
        "Caf√©s": [{name:"Latte",brand:"Starbucks"},{name:"Cappuccino",brand:"Starbucks"},{name:"Americano",brand:"Starbucks"},{name:"Caramel Macchiato",brand:"Starbucks"}],
        "Frappuccinos": [{name:"Caramelo",brand:"Starbucks"},{name:"Mocha",brand:"Starbucks"}],
        "Comida": [{name:"Croissant",brand:"Starbucks"},{name:"Muffin",brand:"Starbucks"}],
        "Postres": [{name:"Brownie",brand:"Starbucks"},{name:"Cookies",brand:"Starbucks"}]
    }
};
// Global vars for restaurant navigation
let selectedRestaurant = null;
let selectedCategory = null;
let allCategoriesProducts = [];

// Load categories when restaurant is selected
function loadRestaurantCategories() {
    const restaurant = document.getElementById('restaurantSelect').value;
    document.getElementById('restaurantEmptyState').style.display = 'none';
    
    if (!restaurant) {
        document.getElementById('categoryTabs').style.display = 'none';
        document.getElementById('restaurantSearchBox').style.display = 'none';
        document.getElementById('restaurantProductsGrid').innerHTML = '';
        document.getElementById('restaurantEmptyState').style.display = 'block';
        return;
    }
    
    selectedRestaurant = restaurant;
    const categories = Object.keys(RESTAURANT_DATA[restaurant]);
    
    // Render category tabs
    const tabsContainer = document.getElementById('categoryTabsContainer');
    tabsContainer.innerHTML = categories.map(function(cat, i) {
        return '<button class="category-tab' + (i === 0 ? ' active' : '') + '" onclick="switchRestaurantCategory(\'' + cat + '\')">' + cat + '</button>';
    }).join('');
    
    document.getElementById('categoryTabs').style.display = 'block';
    document.getElementById('restaurantSearchBox').style.display = 'block';
    
    // Load first category
    switchRestaurantCategory(categories[0]);
}

// Switch between categories
function switchRestaurantCategory(category) {
    selectedCategory = category;
    
    // Update active tab
    document.querySelectorAll('.category-tab').forEach(function(tab) {
        tab.classList.remove('active');
        if (tab.textContent === category) tab.classList.add('active');
    });
    
    // Render products
    renderRestaurantProducts();
}

// Render products from selected category
function renderRestaurantProducts() {
    const products = RESTAURANT_DATA[selectedRestaurant][selectedCategory];
    allCategoriesProducts = products;
    const grid = document.getElementById('restaurantProductsGrid');
    
    if (!products || products.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:2rem;">No hay productos en esta categor√≠a</p>';
        return;
    }
    
    grid.innerHTML = products.map(function(p) {
        return '<div class="restaurant-product-card">' +
            '<img src="' + p.image + '" alt="' + p.name + '">' +
            '<h4>' + p.name + '</h4>' +
            '<button class="add-btn" onclick="addRestaurantProduct(\'' + p.name.replace(/'/g, "\\'") + '\',\'' + p.brand.replace(/'/g, "\\'") + '\',\'' + p.image + '\')">A√±adir</button>' +
            '</div>';
    }).join('');
}

// Filter products within restaurant
function filterRestaurantProducts() {
    const query = document.getElementById('restaurantProductSearch').value.toLowerCase();
    
    if (!query) {
        renderRestaurantProducts();
        return;
    }
    
    const filtered = allCategoriesProducts.filter(function(p) {
        return p.name.toLowerCase().includes(query);
    });
    
    const grid = document.getElementById('restaurantProductsGrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:2rem;">No se encontraron productos</p>';
        return;
    }
    
    grid.innerHTML = filtered.map(function(p) {
        return '<div class="restaurant-product-card">' +
            '<img src="' + p.image + '" alt="' + p.name + '">' +
            '<h4>' + p.name + '</h4>' +
            '<button class="add-btn" onclick="addRestaurantProduct(\'' + p.name.replace(/'/g, "\\'") + '\',\'' + p.brand.replace(/'/g, "\\'") + '\',\'' + p.image + '\')">A√±adir</button>' +
            '</div>';
    }).join('');
}

// Add product from restaurant
function addRestaurantProduct(name, brand, image) {
    const product = {
        id: Date.now().toString(),
        name: name,
        brand: brand,
        image: image,
        barcode: null
    };
    
    // Check if already added
    if (currentTasting.products.find(function(p) { return p.name === name && p.brand === brand; })) {
        alert('Este producto ya est√° a√±adido');
        return;
    }
    
    currentTasting.products.push(product);
    saveTasting();
    updateAddedProducts();
}

async function addProduct(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});await saveTasting();updateAddedProducts();document.getElementById('productSearch').value='';document.getElementById('searchResults').innerHTML='';}
async function addProductFromEdit(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});await saveTasting();updateEditProductsList();document.getElementById('editProductSearch').value='';document.getElementById('editSearchResults').innerHTML='';}

function updateAddedProducts(){
    const c=document.getElementById('addedProducts');document.getElementById('productCount').textContent=currentTasting.products.length;
    if(!currentTasting.products.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üì¶</div><p>A√∫n no hay productos</p></div>';return;}
    c.innerHTML=currentTasting.products.map(function(p,i){return '<div class="product-item" data-id="'+p.id+'"><div class="drag-handle">‚ãÆ‚ãÆ</div><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p></div><button onclick="removeProduct('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;">‚úï</button></div>';}).join('');
    // Init Sortable for drag & drop
    if(sortableInstances.addedProducts) sortableInstances.addedProducts.destroy();
    sortableInstances.addedProducts = new Sortable(c, {
        handle: '.drag-handle',
        animation: 200,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
        ghostClass: 'ghost',
        dragClass: 'dragging',
        forceFallback: true,
        fallbackTolerance: 3,
        onEnd: async function(evt) {
            const item = currentTasting.products.splice(evt.oldIndex, 1)[0];
            currentTasting.products.splice(evt.newIndex, 0, item);
            await saveTasting();
        }
    });
}
async function removeProduct(i){currentTasting.products.splice(i,1);await saveTasting();updateAddedProducts();}
async function finishAddingProducts(){if(!currentTasting.products.length){alert('A√±ade al menos un producto');return;}currentTasting.status='voting';await saveTasting();showProductSelectionScreen();}

// ===== VOTING =====
function showProductSelectionScreen(){
    updateProductSelectionList();
    document.getElementById('editBtn').style.display=currentUser.isHost?'inline-flex':'none';
    showScreen('productSelectionScreen');
}
function updateProductSelectionList(){
    const c=document.getElementById('productSelectionList');
    document.getElementById('votedProductsCount').textContent=Object.keys(userVotes).length;
    document.getElementById('totalProductsCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p){
        const voted=userVotes[p.id];
        const userVote = voted ? (currentTasting.votes[p.id] || []).find(v => v.user === currentUser.name) : null;
        const voteScore = userVote ? userVote.score : 0;
        const scoreColor = userVote ? getScoreColor(voteScore) : '';
        
        // Eventos para mantener pulsado (solo para host)
        const longPressEvents = currentUser.isHost && currentTasting.status !== 'finished' ? 
            `onmousedown="startLongPress('${p.id}')" onmouseup="cancelLongPress()" onmouseleave="cancelLongPress()" ontouchstart="startLongPress('${p.id}')" ontouchend="cancelLongPress()"` : '';
        
        return `<div class="product-item ${voted ? 'selected' : ''}" onclick="selectProduct('${p.id}')" ${longPressEvents} style="cursor:pointer;">
            <img src="${p.image || ''}" class="product-image" onerror="this.style.display='none'">
            <div class="product-info"><h4>${p.name}</h4><p>${p.brand}</p></div>
            ${voted ? `<div style="font-size:1.1rem;font-weight:600;color:white;padding:0.3rem 0.7rem;border-radius:6px;text-shadow:0 1px 2px rgba(0,0,0,0.15);flex-shrink:0;background:${scoreColor};">${voteScore.toFixed(1)}</div>` : ''}
        </div>`;
    }).join('');
}

let longPressTimer = null;
let longPressProductId = null;

function startLongPress(productId) {
    longPressProductId = productId;
    longPressTimer = setTimeout(function() {
        // Mostrar modal de confirmaci√≥n
        const product = currentTasting.products.find(p => p.id === productId);
        if (product) {
            document.getElementById('confirmDeleteText').textContent = 
                `¬øEliminar "${product.name}"?\n\nEsto eliminar√° tambi√©n todos los votos de este producto.`;
            document.getElementById('confirmDeleteModal').style.display = 'flex';
        }
        longPressTimer = null;
    }, 800);
}

function cancelLongPress() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
}

function closeConfirmDeleteModal() {
    document.getElementById('confirmDeleteModal').style.display = 'none';
    longPressProductId = null;
}

async function confirmDeleteProduct() {
    if (!longPressProductId) return;
    
    // Eliminar producto
    currentTasting.products = currentTasting.products.filter(p => p.id !== longPressProductId);
    // Eliminar votos del producto
    delete currentTasting.votes[longPressProductId];
    delete userVotes[longPressProductId];
    
    await saveTasting();
    updateProductSelectionList();
    showToast('Producto eliminado');
    closeConfirmDeleteModal();
}

async function deleteProductFromVoting(productId) {
    // Esta funci√≥n ya no se usa, pero la mantenemos por compatibilidad
    currentTasting.products = currentTasting.products.filter(p => p.id !== productId);
    delete currentTasting.votes[productId];
    delete userVotes[productId];
    
    await saveTasting();
    updateProductSelectionList();
    showToast('Producto eliminado');
}

function selectProduct(id){
    // Solo seleccionar si no estamos en un long press
    if (!longPressTimer) {
        selectedProductId=id;
        showVotingScreen();
    }
}
function updateRatingValue(){
    const value = parseFloat(document.getElementById('ratingSlider').value);
    const popupEl = document.getElementById('ratingValuePopup');
    const productScoreEl = document.getElementById('votingProductScore');
    
    // Obtener color
    let bgColor;
    if (value < 2.5) bgColor = '#dc2626';
    else if (value < 5) bgColor = '#f97316';
    else if (value < 7.5) bgColor = '#eab308';
    else bgColor = '#22c55e';
    
    // Actualizar popup
    if (popupEl) {
        popupEl.textContent = value.toFixed(1);
        popupEl.style.background = bgColor;
        popupEl.style.borderColor = bgColor;
        
        // Posicionar el popup seg√∫n el valor del slider
        const percent = (value / 10) * 100;
        popupEl.style.left = `calc(${percent}% - 2px)`;
    }
    
    // Actualizar puntuaci√≥n al lado del producto
    if (productScoreEl) {
        productScoreEl.textContent = value.toFixed(1);
        productScoreEl.style.background = bgColor;
        productScoreEl.style.display = 'block';
    }
}
function showVotingScreen(){
    const p=currentTasting.products.find(function(x){return x.id===selectedProductId;});if(!p)return;
    document.getElementById('votingProductName').textContent=p.name;
    document.getElementById('votingProductBrand').textContent=p.brand;
    document.getElementById('votingProductImage').src=p.image||'';
    
    // Cargar voto existente si ya votaste este producto
    const existingVote = (currentTasting.votes[selectedProductId] || []).find(v => v.user === currentUser.name);
    if (existingVote) {
        document.getElementById('ratingSlider').value = existingVote.score;
        document.getElementById('voteComment').value = existingVote.comment || '';
    } else {
        document.getElementById('ratingSlider').value = 5.0;
        document.getElementById('voteComment').value = '';
    }
    
    updateRatingValue();
    updateVoteCount(); 
    showScreen('votingScreen');
}
async function submitVote(){
    const score=parseFloat(document.getElementById('ratingSlider').value);
    const comment=document.getElementById('voteComment').value.trim();
    const product=currentTasting.products.find(function(p){return p.id===selectedProductId;});
    if(!currentTasting.votes[selectedProductId])currentTasting.votes[selectedProductId]=[];
    currentTasting.votes[selectedProductId]=currentTasting.votes[selectedProductId].filter(function(v){return v.user!==currentUser.name;});
    currentTasting.votes[selectedProductId].push({user:currentUser.name,score:score,comment:comment});
    userVotes[selectedProductId]=true;
    updateGlobalRanking(product.name,product.brand,product.image,score);
    
    // Actualizar tarjeta de producto votado
    document.getElementById('votedProductImage').src = product.image || '';
    document.getElementById('votedProductName').textContent = product.name;
    document.getElementById('votedProductBrand').textContent = product.brand;
    const scoreEl = document.getElementById('votedProductScore');
    scoreEl.textContent = score.toFixed(1);
    scoreEl.style.background = getScoreColor(score);
    
    await saveTasting(); showProductSelectionScreen();
}

function editVote() {
    if (currentTasting.status === 'finished') {
        alert('La cata ya ha finalizado. No se pueden editar votos.');
        return;
    }
    // Volver a la pantalla de votaci√≥n
    showVotingScreen();
}
function updateVoteCount(){const votes=currentTasting.votes[selectedProductId]||[];document.getElementById('votedCount').textContent=votes.length;document.getElementById('votedTotal').textContent=currentTasting.participants.length;}

// ===== EDIT MODE =====
function showEditMode(){if(!currentUser.isHost){alert('Solo el anfitri√≥n puede editar');return;}updateEditProductsList();showScreen('editCataScreen');}
function updateEditProductsList(){
    const c=document.getElementById('editProductsList');document.getElementById('editProductCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p,i){
        const hasVotes=currentTasting.votes[p.id]&&currentTasting.votes[p.id].length>0;
        return '<div class="product-item" data-id="'+p.id+'"><div class="drag-handle">‚ãÆ‚ãÆ</div><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p>'+(hasVotes?'<p style="color:var(--success);font-size:0.72rem;margin-top:0.15rem;">‚úì '+currentTasting.votes[p.id].length+' votos</p>':'')+' </div><button onclick="removeProductFromEdit('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;" '+(hasVotes?'disabled style="opacity:0.4;cursor:not-allowed;"':'')+'>‚úï</button></div>';
    }).join('');
    // Init Sortable for drag & drop
    if(sortableInstances.editProductsList) sortableInstances.editProductsList.destroy();
    sortableInstances.editProductsList = new Sortable(c, {
        handle: '.drag-handle',
        animation: 200,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
        ghostClass: 'ghost',
        dragClass: 'dragging',
        forceFallback: true,
        fallbackTolerance: 3,
        onEnd: async function(evt) {
            const item = currentTasting.products.splice(evt.oldIndex, 1)[0];
            currentTasting.products.splice(evt.newIndex, 0, item);
            await saveTasting();
        }
    });
}
async function removeProductFromEdit(i){const p=currentTasting.products[i];if(currentTasting.votes[p.id]&&currentTasting.votes[p.id].length){alert('No puedes eliminar un producto con votos');return;}currentTasting.products.splice(i,1);await saveTasting();updateEditProductsList();}
function exitEditMode(){showProductSelectionScreen();}

// ===== RESULTS =====
function confirmFinishTasting() {
    const allVoted = currentTasting.participants.every(participant => {
        return currentTasting.products.every(product => {
            const votes = currentTasting.votes[product.id] || [];
            return votes.some(v => v.user === participant.name);
        });
    });
    
    let message = '¬øEst√°s seguro de que quieres finalizar la cata?';
    if (!allVoted) {
        message += '\n\nA√∫n hay participantes que no han votado todos los productos.';
    }
    message += '\n\nUna vez finalizada, no se podr√°n editar los votos.';
    
    if (confirm(message)) {
        showResults();
    }
}

async function showResults(){
    currentTasting.status='finished';await saveTasting();
    const c=document.getElementById('resultsContainer');
    c.innerHTML=currentTasting.products.map(function(product, index){
        const votes=currentTasting.votes[product.id]||[];
        const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        const scoreColor = getScoreColor(avg);
        const scoreBorder = getScoreBorder(avg);
        
        return `
            <div class="result-card collapsed" style="${scoreBorder}" onclick="toggleResultCard(this)" data-product-id="${product.id}">
                <!-- Vista compacta -->
                <div class="result-card-compact">
                    <img src="${product.image || ''}" class="product-image" onerror="this.style.display='none'">
                    <div class="result-card-compact-info">
                        <h4>${product.name}</h4>
                        <p>${product.brand}</p>
                    </div>
                    <div class="result-card-compact-score" style="background: ${scoreColor};">
                        ${avg.toFixed(1)}
                    </div>
                    <div class="result-card-arrow">‚Ä∫</div>
                </div>
                
                <!-- Detalles expandidos -->
                <div class="result-card-details">
                    ${votes.length ? `
                        <h4 style="margin:0 0 0.75rem;font-size:0.875rem;font-weight:600;color:var(--text-secondary);">Puntuaciones de participantes</h4>
                        ${votes.map(function(v){
                            return `<div class="rating-result">
                                <div>
                                    <strong style="font-size:0.875rem;">${v.user}</strong>
                                    ${v.comment ? `<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">${v.comment}</p>` : ''}
                                </div>
                                <div class="rating-score">${v.score.toFixed(1)}</div>
                            </div>`;
                        }).join('')}
                    ` : '<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>'}
                </div>
            </div>
        `;
    }).join('');
    showScreen('resultsScreen');
}

function toggleResultCard(card) {
    card.classList.toggle('collapsed');
}
function finishTasting(){
    archiveTasting();
    unsubscribeFromTastingUpdates(); // Clean up realtime subscription
    currentTasting=null;
    currentUser=null;
    userVotes={};
    showScreen('homeScreen');
}

// ===== PERSISTENCE =====
let realtimeChannel = null;

async function saveTasting(){
    // SIEMPRE guardar en localStorage primero
    const t = JSON.parse(localStorage.getItem('tastings') || '{}');
    t[currentTasting.code] = currentTasting;
    localStorage.setItem('tastings', JSON.stringify(t));
    console.log('Saved to localStorage:', currentTasting.code);
    
    // Intentar guardar en Supabase SOLO si est√° autenticado
    if (authenticatedUser && authenticatedUser.id) {
        try {
            console.log('Saving tasting to Supabase:', currentTasting.code);
            
            const tastingData = {
                code: currentTasting.code,
                name: currentTasting.name,
                description: currentTasting.description || null,
                date: currentTasting.date || null,
                host: currentTasting.host,
                participants: currentTasting.participants,
                products: currentTasting.products,
                votes: currentTasting.votes,
                status: currentTasting.status,
                created_at: currentTasting.createdAt,
                user_id: currentTasting.userId || null
            };
            
            const {data, error} = await supabaseClient
                .from('tastings')
                .upsert(tastingData, {
                    onConflict: 'code'
                });
            
            if(error) {
                console.error('Supabase error:', error.message);
                showToast('‚ö†Ô∏è Error al guardar en la nube. Guardado localmente.');
            } else {
                console.log('Successfully saved to Supabase');
            }
        } catch(e) {
            console.error('Exception in saveTasting:', e.message);
            showToast('‚ö†Ô∏è Error al guardar en la nube. Guardado localmente.');
        }
    }
}

async function loadTastingByCode(code){
    try {
        console.log('Loading tasting:', code);
        
        // Primero intentar localStorage (m√°s r√°pido)
        const localTasting = JSON.parse(localStorage.getItem('tastings')||'{}')[code];
        if(localTasting) {
            console.log('Found in localStorage');
            return localTasting;
        }
        
        // Si no est√° en localStorage, buscar en Supabase
        if (authenticatedUser) {
            console.log('Checking Supabase for:', code);
            const {data, error} = await supabaseClient
                .from('tastings')
                .select('*')
                .eq('code', code)
                .maybeSingle(); // maybeSingle() no da error si no hay resultados
            
            if(error) {
                console.error('Supabase error:', error.message);
                return null;
            }
            
            if(data) {
                console.log('Found in Supabase');
                return {
                    code: data.code,
                    name: data.name,
                    description: data.description,
                    date: data.date,
                    host: data.host,
                    participants: data.participants,
                    products: data.products,
                    votes: data.votes,
                    status: data.status,
                    createdAt: data.created_at,
                    userId: data.user_id
                };
            }
        }
        
        console.log('Tasting not found');
        return null;
    } catch(e) {
        console.error('Exception in loadTastingByCode:', e.message);
        
        // Fallback to localStorage
        return JSON.parse(localStorage.getItem('tastings')||'{}')[code];
    }
}

// Subscribe to realtime updates for current tasting
function subscribeToTastingUpdates() {
    if (!currentTasting) return;
    
    // Unsubscribe from previous channel if exists
    if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
    }
    
    console.log('Subscribing to realtime updates for:', currentTasting.code);
    
    // Subscribe to changes on this specific tasting
    realtimeChannel = supabaseClient
        .channel('tasting-' + currentTasting.code)
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'tastings',
                filter: 'code=eq.' + currentTasting.code
            },
            (payload) => {
                console.log('Received realtime update:', payload);
                handleTastingUpdate(payload.new);
            }
        )
        .subscribe((status) => {
            console.log('Realtime subscription status:', status);
        });
}

// Handle incoming realtime updates
function handleTastingUpdate(newData) {
    if (!currentTasting || !newData) return;
    
    console.log('Handling tasting update');
    
    // Update current tasting with new data
    const oldParticipantsCount = currentTasting.participants.length;
    const oldProductsCount = currentTasting.products.length;
    const oldStatus = currentTasting.status;
    
    currentTasting.participants = newData.participants;
    currentTasting.products = newData.products;
    currentTasting.votes = newData.votes;
    currentTasting.status = newData.status;
    currentTasting.name = newData.name;
    currentTasting.description = newData.description;
    currentTasting.date = newData.date;
    currentTasting.host = newData.host;
    
    // Update UI based on current screen
    const currentScreen = document.querySelector('.screen.active').id;
    
    if (currentScreen === 'waitingScreen') {
        // Update participants list
        updateParticipantsList();
        
        // Show notification if new participant joined
        if (newData.participants.length > oldParticipantsCount) {
            const newParticipant = newData.participants[newData.participants.length - 1];
            showToast('üëã ' + newParticipant.name + ' se ha unido');
        }
        
        // If host started the tasting, move to next screen
        if (newData.status !== oldStatus && newData.status === 'adding_products' && !currentUser.isHost) {
            showToast('üéâ ¬°El anfitri√≥n ha iniciado la cata!');
            setTimeout(() => showScreen('addProductsScreen'), 1500);
        }
    } else if (currentScreen === 'addProductsScreen') {
        // Update products list
        updateAddedProducts();
        
        // If products were added, show notification
        if (newData.products.length > oldProductsCount) {
            showToast('‚ú® Se a√±adi√≥ un nuevo producto');
        }
        
        // If voting started
        if (newData.status !== oldStatus && newData.status === 'voting') {
            showToast('üó≥Ô∏è ¬°Comienza la votaci√≥n!');
            setTimeout(() => showProductSelectionScreen(), 1500);
        }
    } else if (currentScreen === 'productSelectionScreen') {
        // Update product selection list
        updateProductSelectionList();
        
        // Update results if status changed to finished
        if (newData.status !== oldStatus && newData.status === 'finished') {
            showToast('üèÅ ¬°Cata finalizada!');
            setTimeout(() => showResults(), 1500);
        }
    } else if (currentScreen === 'manageParticipantsScreen') {
        // Update manage participants view
        renderManageParticipants();
    }
}

// Unsubscribe when leaving a tasting
function unsubscribeFromTastingUpdates() {
    if (realtimeChannel) {
        console.log('Unsubscribing from realtime updates');
        supabaseClient.removeChannel(realtimeChannel);
        realtimeChannel = null;
    }
}

function archiveTasting(){const a=JSON.parse(localStorage.getItem('archivedTastings')||'[]');a.unshift({...currentTasting,archivedAt:new Date().toISOString()});localStorage.setItem('archivedTastings',JSON.stringify(a));}

// ===== LOAD RECENT TASTINGS =====
async function loadRecentTastings(containerId = 'recentTastingsList') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    console.log('=== loadRecentTastings START ===');
    let recentTastings = [];
    
    try {
        // 1. Cargar catas archivadas (finalizadas) de localStorage
        const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
        console.log('Archived tastings from localStorage:', archived.length);
        archived.forEach(t => {
            recentTastings.push({
                code: t.code || 'N/A',
                name: t.name,
                status: 'finished',
                createdAt: t.archivedAt || t.createdAt,
                participants: t.participants,
                products: t.products,
                votes: t.votes,
                host: t.host,
                description: t.description,
                date: t.date,
                userId: t.userId,
                isArchived: true
            });
        });
        
        // 2. Cargar catas activas de localStorage
        const localTastings = JSON.parse(localStorage.getItem('tastings') || '{}');
        console.log('Active tastings from localStorage:', Object.keys(localTastings).length);
        console.log('Active tastings:', localTastings);
        Object.values(localTastings).forEach(t => {
            if (!recentTastings.find(rt => rt.code === t.code)) {
                console.log('Adding tasting:', t.name, t.status);
                recentTastings.push({
                    code: t.code,
                    name: t.name,
                    status: t.status,
                    createdAt: t.createdAt,
                    participants: t.participants,
                    products: t.products,
                    votes: t.votes,
                    host: t.host,
                    description: t.description,
                    date: t.date,
                    userId: t.userId,
                    isArchived: false
                });
            }
        });
        
        // 3. Cargar desde Supabase si est√° autenticado
        if (authenticatedUser && authenticatedUser.id) {
            try {
                console.log('Loading from Supabase for user:', authenticatedUser.id);
                const { data, error } = await supabaseClient
                    .from('tastings')
                    .select('*')
                    .eq('user_id', authenticatedUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.error('Error loading from Supabase:', error.message);
                } else if (data) {
                    console.log('Loaded from Supabase:', data.length);
                    data.forEach(t => {
                        if (!recentTastings.find(rt => rt.code === t.code)) {
                            recentTastings.push({
                                code: t.code,
                                name: t.name,
                                status: t.status,
                                createdAt: t.created_at,
                                participants: t.participants,
                                products: t.products,
                                votes: t.votes,
                                host: t.host,
                                description: t.description,
                                date: t.date,
                                userId: t.user_id,
                                isArchived: false
                            });
                        }
                    });
                }
            } catch (err) {
                console.error('Exception loading from Supabase:', err.message || err);
            }
        }
    } catch (error) {
        console.error('Error loading tastings:', error);
    }
    
    console.log('Total tastings before sort:', recentTastings.length);
    
    // Ordenar por fecha (m√°s recientes primero)
    recentTastings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // Limitar a las 20 m√°s recientes
    recentTastings = recentTastings.slice(0, 20);
    
    console.log('Final tastings to display:', recentTastings.length);
    console.log('=== loadRecentTastings END ===');
    
    if (!recentTastings.length) {
        container.innerHTML = '<div class="empty-state"><div class="icon">üìù</div><p>No tienes catas</p></div>';
        return;
    }
    
    // Renderizar con dise√±o horizontal
    container.innerHTML = recentTastings.map(t => {
        const statusInfo = getStatusInfo(t.status);
        const createdDate = new Date(t.createdAt).toLocaleDateString('es-ES', { 
            day: 'numeric', 
            month: 'short',
            year: 'numeric'
        });
        
        const onclick = t.isArchived ? `viewArchivedTasting('${t.code}')` : `resumeTasting('${t.code}')`;
        
        return `<div class="recent-tasting-item-new" onclick="${onclick}"><div class="recent-tasting-name">${t.name}</div><div class="recent-tasting-date">üìÖ ${createdDate}</div><div class="status-badge status-${t.status}">${statusInfo.text}</div><div class="recent-tasting-arrow">‚Ä∫</div></div>`;
    }).join('');
}

function getStatusInfo(status) {
    const statusMap = {
        'waiting': { text: 'Sin empezar', color: '#94a3b8' },
        'adding_products': { text: 'En proceso', color: '#f59e0b' },
        'voting': { text: 'En proceso', color: '#f59e0b' },
        'finished': { text: 'Finalizada', color: '#10b981' }
    };
    return statusMap[status] || { text: 'Desconocido', color: '#64748b' };
}

// Obtener color seg√∫n puntuaci√≥n (color s√≥lido, m√°s sutil)
function getScoreColor(score) {
    if (score >= 0 && score < 2.5) {
        return '#dc2626'; // Rojo
    } else if (score >= 2.5 && score < 5) {
        return '#f97316'; // Naranja
    } else if (score >= 5 && score < 7.5) {
        return '#eab308'; // Amarillo
    } else if (score >= 7.5 && score <= 10) {
        return '#22c55e'; // Verde
    }
    return '#64748b'; // Gris por defecto
}

// Obtener estilo de borde seg√∫n puntuaci√≥n
function getScoreBorder(score) {
    const hasPerfectScore = score === 10;
    if (hasPerfectScore) {
        return 'border: 3px solid transparent; background-image: linear-gradient(white, white), linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24); background-origin: border-box; background-clip: padding-box, border-box; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);';
    }
    return '';
}

function viewArchivedTasting(code) {
    const archived = JSON.parse(localStorage.getItem('archivedTastings') || '[]');
    const tasting = archived.find(t => t.code === code);
    if (!tasting) return;
    
    document.getElementById('archiveTastingName').textContent = tasting.name;
    document.getElementById('archiveDate').textContent = 'Finalizada el ' + new Date(tasting.archivedAt || tasting.createdAt).toLocaleDateString('es-ES');
    const c = document.getElementById('archiveResults');
    c.innerHTML = tasting.products.map(function(product) {
        const votes = tasting.votes[product.id] || [];
        const avg = votes.length ? votes.reduce(function(s,v) { return s + v.score; }, 0) / votes.length : 0;
        const scoreColor = getScoreColor(avg);
        const scoreBorder = getScoreBorder(avg);
        
        return '<div class="result-card" style="' + scoreBorder + '"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="' + (product.image || '') + '" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">' + product.name + '</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">' + product.brand + '</p></div></div><div class="avg-score" style="background: ' + scoreColor + ';">' + avg.toFixed(1) + '</div>' + (votes.length ? '<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>' + votes.map(function(v) { return '<div class="rating-result"><div><strong style="font-size:0.875rem;">' + v.user + '</strong>' + (v.comment ? '<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">' + v.comment + '</p>' : '') + '</div><div class="rating-score">' + v.score.toFixed(1) + '</div></div>'; }).join('') : '<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>') + '</div>';
    }).join('');
    showScreen('archiveScreen');
}

async function resumeTasting(code) {
    try {
        const tasting = await loadTastingByCode(code);
        if (!tasting) {
            alert('No se pudo cargar la cata');
            return;
        }
        
        // Configurar la cata actual
        currentTasting = tasting;
        
        // Determinar el usuario actual
        let userName = authenticatedUser ? authenticatedUser.name : null;
        
        // Buscar si el usuario ya est√° en la cata
        const existingParticipant = currentTasting.participants.find(p => {
            if (authenticatedUser) {
                // Si est√° autenticado, buscar por nombre o si es el creador
                return p.name === userName || (currentTasting.userId && authenticatedUser.id === currentTasting.userId);
            } else {
                // Si no est√° autenticado, buscar por el host name
                // (asumimos que si eres el host, es tu cata)
                return p.isHost && p.name === currentTasting.host;
            }
        });
        
        if (existingParticipant) {
            // Usuario ya est√° en la cata
            currentUser = existingParticipant;
            console.log('Found existing participant:', currentUser.name, 'isHost:', currentUser.isHost);
        } else {
            // Usuario nuevo - pedir nombre si no est√° autenticado
            if (!userName) {
                userName = prompt('Introduce tu nombre para continuar:');
                if (!userName) return;
            }
            
            // A√±adir como participante nuevo
            currentUser = { name: userName, isHost: false };
            currentTasting.participants.push(currentUser);
            await saveTasting();
        }
        
        // Resetear votos del usuario
        userVotes = {};
        
        // Suscribirse a actualizaciones en tiempo real
        subscribeToTastingUpdates();
        
        // Navegar a la pantalla apropiada seg√∫n el estado
        switch (currentTasting.status) {
            case 'waiting':
                // Ir a la sala de espera
                showWaitingRoom();
                break;
                
            case 'adding_products':
                if (currentUser.isHost) {
                    // El host puede continuar a√±adiendo productos
                    updateAddedProducts();
                    showScreen('addProductsScreen');
                } else {
                    // Los participantes esperan
                    showWaitingRoom();
                    showToast('‚è≥ El anfitri√≥n est√° a√±adiendo productos...');
                }
                break;
                
            case 'voting':
                // Todos pueden votar
                updateProductSelectionList();
                showProductSelectionScreen();
                break;
                
            default:
                showWaitingRoom();
        }
    } catch (error) {
        console.error('Error resuming tasting:', error);
        alert('Error al cargar la cata');
    }
}

function loadArchivedTastings(){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    const c=document.getElementById('archivedList');
    if(!archived.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üóÇÔ∏è</div><p>No tienes catas finalizadas</p></div>';return;}
    c.innerHTML=archived.map(function(t,i){
        return '<div class="archive-item"><div class="archive-icon" onclick="viewArchive('+i+')"><img src="'+MASCOT_WAITING_URL+'" alt=""></div><div class="archive-content" onclick="viewArchive('+i+')"><h3>'+t.name+'</h3><div class="archive-meta"><span>üìÖ '+new Date(t.archivedAt).toLocaleDateString('es-ES')+'</span><span>üë• '+t.participants.length+' part.</span><span>üçΩÔ∏è '+t.products.length+' prod.</span></div></div><button class="archive-delete" onclick="deleteArchive('+i+',event)" title="Eliminar">üóëÔ∏è</button></div>';
    }).join('');
}
function deleteArchive(i,event){
    event.stopPropagation();
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    if(confirm('¬øEliminar la cata "'+archived[i].name+'"? No se puede recuperar.')){
        archived.splice(i,1);
        localStorage.setItem('archivedTastings',JSON.stringify(archived));
        loadArchivedTastings();
    }
}
function viewArchive(i){viewArchiveFromIndex(i);}
function viewArchiveFromIndex(i){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');const t=archived[i];
    document.getElementById('archiveTastingName').textContent=t.name;
    document.getElementById('archiveDate').textContent='Finalizada el '+new Date(t.archivedAt).toLocaleDateString('es-ES');
    const c=document.getElementById('archiveResults');
    c.innerHTML=t.products.map(function(product){
        const votes=t.votes[product.id]||[];
        const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        const scoreColor = getScoreColor(avg);
        const scoreBorder = getScoreBorder(avg);
        
        return '<div class="result-card" style="' + scoreBorder + '"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="'+(product.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">'+product.name+'</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">'+product.brand+'</p></div></div><div class="avg-score" style="background: ' + scoreColor + ';">'+avg.toFixed(1)+'</div>'+(votes.length?'<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>'+votes.map(function(v){return '<div class="rating-result"><div><strong style="font-size:0.875rem;">'+v.user+'</strong>'+(v.comment?'<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">'+v.comment+'</p>':'')+' </div><div class="rating-score">'+v.score.toFixed(1)+'</div></div>';}).join(''):'<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>')+'</div>';
    }).join('');
    showScreen('archiveScreen');
}

// ===== PROFILE MANAGEMENT =====
async function loadProfileData(){
    if(!authenticatedUser)return;
    document.getElementById('profileName').textContent=authenticatedUser.name;
    document.getElementById('profileEmail').textContent=authenticatedUser.email;
    const {data:profile} = await supabaseClient.from('profiles').select('avatar').eq('id',authenticatedUser.id).single();
    const avatarKey = profile?.avatar || 'panda_normal';
    const avatarImg = PANDA_AVATARS[avatarKey] || PANDA_AVATARS.panda_normal;
    document.getElementById('profileAvatarBig').innerHTML='<img src="'+avatarImg+'" style="width:100%;height:100%;object-fit:cover;">';
    document.getElementById('avatar_panda_normal').src=PANDA_AVATARS.panda_normal;
    document.getElementById('avatar_panda_eating').src=PANDA_AVATARS.panda_eating;
    document.getElementById('avatar_panda_waiting').src=PANDA_AVATARS.panda_waiting;
    document.getElementById('avatar_panda_head').src=PANDA_AVATARS.panda_head;
}

function showEditProfile(){
    document.getElementById('editProfileName').value=authenticatedUser.name;
    document.getElementById('editProfileEmail').value=authenticatedUser.email;
    document.getElementById('editProfilePassword').value='';
    showScreen('editProfileScreen');
}

async function saveProfileChanges(){
    const newName=document.getElementById('editProfileName').value.trim();
    const newEmail=document.getElementById('editProfileEmail').value.trim();
    const newPassword=document.getElementById('editProfilePassword').value.trim();
    if(!newName||!newEmail){alert('Nombre y email son obligatorios');return;}
    
    try{
        await supabaseClient.from('profiles').update({name:newName,email:newEmail}).eq('id',authenticatedUser.id);
        authenticatedUser.name=newName;
        
        if(newEmail!==authenticatedUser.email){
            const {error:emailError} = await supabaseClient.auth.updateUser({email:newEmail});
            if(emailError) alert('Error al cambiar email: '+emailError.message);
            else alert('Se ha enviado un email de confirmaci√≥n a la nueva direcci√≥n');
        }
        
        if(newPassword){
            if(newPassword.length<6){alert('La contrase√±a debe tener al menos 6 caracteres');return;}
            const {error:pwError} = await supabaseClient.auth.updateUser({password:newPassword});
            if(pwError){alert('Error al cambiar contrase√±a: '+pwError.message);return;}
        }
        
        alert('‚úì Perfil actualizado');
        showScreen('profileScreen');
        loadProfileData();
    }catch(e){
        alert('Error al guardar cambios: '+e.message);
    }
}

function showAvatarSelector(){
    document.getElementById('avatarSelectorModal').style.display='flex';
}

function closeAvatarSelector(){
    document.getElementById('avatarSelectorModal').style.display='none';
}

async function selectAvatar(avatarKey){
    await supabaseClient.from('profiles').update({avatar:avatarKey}).eq('id',authenticatedUser.id);
    closeAvatarSelector();
    loadProfileData();
}

async function deleteAccount(){
    if(!confirm('¬øEst√°s seguro de que quieres eliminar tu cuenta?\\n\\nEsta acci√≥n NO se puede deshacer.'))return;
    if(!confirm('√öltima confirmaci√≥n: ¬øEliminar cuenta permanentemente?'))return;
    
    try{
        await supabaseClient.from('profiles').delete().eq('id',authenticatedUser.id);
        await supabaseClient.rpc('delete_user');
        await logout();
        alert('Tu cuenta ha sido eliminada');
    }catch(e){
        alert('Cuenta eliminada de la app. Para eliminarla completamente, contacta con soporte.');
        await logout();
    }
}

// ===== INIT =====
initApp();

// ===== PWA =====
// Service Worker registration with update detection
if('serviceWorker' in navigator){
    window.addEventListener('load',function(){
        navigator.serviceWorker.register('sw.js')
            .then(function(registration){
                console.log('SW registered');
                
                // Check for updates every 30 seconds
                setInterval(function(){
                    registration.update();
                }, 30000);
                
                // Listen for new service worker
                registration.addEventListener('updatefound', function(){
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', function(){
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New version available
                            showUpdateBanner();
                        }
                    });
                });
            })
            .catch(function(err){
                console.log('SW registration failed:', err);
            });
        
        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', function(event){
            if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                showUpdateBanner();
            }
        });
    });
}

function showUpdateBanner() {
    const banner = document.getElementById('updateBanner');
    if (banner) {
        banner.style.display = 'block';
    }
}

function dismissUpdateBanner() {
    const banner = document.getElementById('updateBanner');
    if (banner) {
        banner.remove();
    }
}

function updateApp() {
    // Eliminar completamente el banner del DOM
    const banner = document.getElementById('updateBanner');
    if (banner) {
        banner.remove();
    }
    
    // Mostrar mensaje antes de recargar
    const body = document.body;
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;';
    overlay.innerHTML = '<div style="text-align:center;"><div style="font-size:3rem;margin-bottom:1rem;">‚è≥</div><div style="font-size:1.2rem;font-weight:600;">Actualizando...</div></div>';
    body.appendChild(overlay);
    
    // Delay para mostrar el mensaje
    setTimeout(function() {
        // Clear cache and reload
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations()
                .then(function(registrations) {
                    const unregisterPromises = registrations.map(function(reg) {
                        return reg.unregister();
                    });
                    return Promise.all(unregisterPromises);
                })
                .then(function() {
                    return caches.keys();
                })
                .then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            return caches.delete(cacheName);
                        })
                    );
                })
                .then(function() {
                    // Force reload bypassing cache
                    window.location.replace(window.location.href);
                })
                .catch(function(err) {
                    console.error('Update error:', err);
                    window.location.replace(window.location.href);
                });
        } else {
            window.location.replace(window.location.href);
        }
    }, 300);
}

let deferredPrompt=null;
const installBanner=document.getElementById('installBanner');
window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredPrompt=e;if(!sessionStorage.getItem('pwa-banner-dismissed'))installBanner.style.display='block';});
document.getElementById('installBtn').addEventListener('click',async function(){if(deferredPrompt){installBanner.style.display='none';deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}});
document.getElementById('dismissBanner').addEventListener('click',function(){installBanner.style.display='none';sessionStorage.setItem('pwa-banner-dismissed','true');});
document.getElementById('closeIosModal').addEventListener('click',function(){document.getElementById('iosModal').style.display='none';});
window.addEventListener('load',function(){if(/iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.matchMedia('(display-mode: standalone)').matches&&!sessionStorage.getItem('pwa-banner-dismissed'))setTimeout(function(){document.getElementById('iosModal').style.display='flex';},2000);});

// ===== BLOQUEADOR DE share-modal.js Y ERRORES DE EXTENSIONES =====
(function() {
    console.log('üõ°Ô∏è Bloqueador de scripts y errores de extensiones activado');
    
    // 1. Interceptar todas las peticiones de scripts
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
        const element = originalCreateElement.call(document, tagName);
        if (tagName.toLowerCase() === 'script') {
            const originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
                if (name === 'src' && value && value.includes('share-modal')) {
                    console.warn('üö´ Bloqueado intento de cargar share-modal.js');
                    return;
                }
                return originalSetAttribute.call(this, name, value);
            };
        }
        return element;
    };
    
    // 2. Sobrescribir el objeto global que share-modal.js podr√≠a usar
    window.addEventListener('error', function(e) {
        const errorMsg = e.message || '';
        const filename = e.filename || '';
        
        // Silenciar errores de extensiones
        if (filename.includes('share-modal') ||
            filename.includes('chrome-extension') ||
            errorMsg.includes('runtime.lastError') ||
            errorMsg.includes('message channel closed') ||
            errorMsg.includes('extension port')) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return true;
        }
    }, true);
    
    // 3. Capturar errores de promesas rechazadas (extensiones)
    window.addEventListener('unhandledrejection', function(e) {
        const reason = e.reason ? e.reason.toString() : '';
        
        // Silenciar rechazos de promesas de extensiones
        if (reason.includes('runtime.lastError') ||
            reason.includes('message channel closed') ||
            reason.includes('extension port') ||
            reason.includes('asynchronous response')) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
    });
    
    // 4. Remover cualquier script de share-modal que ya exista
    document.addEventListener('DOMContentLoaded', function() {
        const scripts = document.querySelectorAll('script');
        scripts.forEach(function(script) {
            if (script.src && script.src.includes('share-modal')) {
                console.warn('üö´ Removiendo script share-modal.js del DOM');
                script.remove();
            }
        });
    });
    
    // 5. Monitorear mutaciones del DOM
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.tagName === 'SCRIPT' && node.src && node.src.includes('share-modal')) {
                    console.warn('üö´ Script share-modal.js detectado y removido por MutationObserver');
                    node.remove();
                }
            });
        });
    });
    
    observer.observe(document.documentElement, {
        childList: true,
        subtree: true
    });
    
    // 6. Silenciar errores de console.error
    const originalConsoleError = console.error;
    console.error = function(...args) {
        const errorMsg = args.join(' ');
        
        // Filtrar errores conocidos de extensiones
        if (errorMsg.includes('runtime.lastError') || 
            errorMsg.includes('back/forward cache') ||
            errorMsg.includes('extension port') ||
            errorMsg.includes('message channel closed') ||
            errorMsg.includes('asynchronous response')) {
            return;
        }
        
        originalConsoleError.apply(console, args);
    };
    
    // 7. Filtrar warnings tambi√©n
    const originalConsoleWarn = console.warn;
    console.warn = function(...args) {
        const warnMsg = args.join(' ');
        
        if (warnMsg.includes('runtime.lastError') || 
            warnMsg.includes('extension')) {
            return;
        }
        
        originalConsoleWarn.apply(console, args);
    };
    
    console.log('‚úÖ Protecci√≥n completa contra errores de extensiones instalada');
})();
</script>
</div>
</body>
</html>
