<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TasteScore">
    <link rel="manifest" href="manifest.json">
    <title>TasteScore</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
    <script>
        // ===== FIREBASE CONFIG ‚Äì replace with your own from https://console.firebase.google.com =====
        const firebaseConfig = {
            apiKey:            "AIzaSyBERE_PLACEHOLDER_REPLACE_ME",
            authDomain:        "tastescore-PLACEHOLDER.firebaseapp.com",
            projectId:         "tastescore-PLACEHOLDER",
            storageBucket:     "tastescore-PLACEHOLDER.appspot.com",
            messagingSenderId:"000000000000",
            appId:             "1:000000000000:web:aaaaaaaaaaaaaaaaaaaaaaaa"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db   = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#2563eb; --primary-dark:#1e40af; --primary-light:#3b82f6;
            --accent:#f59e0b; --bg:#ffffff; --bg-secondary:#f8fafc;
            --bg-tertiary:#e2e8f0; --border:#e2e8f0; --text:#1a1a1a;
            --text-secondary:#64748b; --text-tertiary:#94a3b8;
            --success:#10b981; --error:#ef4444;
            --shadow:rgba(0,0,0,0.05); --shadow-hover:rgba(37,99,235,0.15);
        }
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-secondary); color:var(--text); line-height:1.6;
            min-height:100vh; -webkit-font-smoothing:antialiased;
            padding-bottom:72px;
        }
        /* HEADER */
        .header { background:rgba(255,255,255,0.95); padding:1rem; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; backdrop-filter:blur(10px); }
        .header-inner { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .header h1 { font-size:1.5rem; font-weight:700; letter-spacing:-0.02em; color:var(--primary); }
        .header p { font-size:0.875rem; color:var(--text-secondary); }
        .header-content { display:flex; align-items:center; }
        .back-btn { background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; padding:0.5rem; margin-right:0.75rem; }
        .back-btn:hover { opacity:0.6; }
        /* BOTTOM NAV */
        #bottomNav { position:fixed; bottom:0; left:0; right:0; height:64px; background:#fff; border-top:1px solid var(--border); display:flex; justify-content:space-around; align-items:center; z-index:500; box-shadow:0 -2px 10px rgba(0,0,0,0.06); }
        .nav-btn { display:flex; flex-direction:column; align-items:center; gap:2px; background:none; border:none; cursor:pointer; color:var(--text-secondary); font-size:0.6875rem; font-weight:500; padding:6px 10px; border-radius:8px; transition:color 0.15s; font-family:'Inter',sans-serif; flex:1; }
        .nav-btn svg { transition:stroke 0.15s; }
        .nav-btn:hover,.nav-btn.active { color:var(--primary); }
        .nav-btn.active svg { stroke:var(--primary); }
        /* SCREENS */
        .screen { display:none; animation:fadeIn 0.2s ease; }
        .screen.active { display:block; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .container { max-width:640px; margin:0 auto; padding:1.5rem 1rem; }
        /* CARDS & BUTTONS */
        .card { background:var(--bg); border-radius:12px; padding:1.5rem; margin-bottom:1rem; border:1px solid var(--border); box-shadow:0 1px 3px var(--shadow); }
        .btn { display:inline-block; padding:0.875rem 1.5rem; border-radius:8px; border:1px solid var(--border); font-weight:500; font-size:0.9375rem; cursor:pointer; transition:all 0.15s; text-align:center; font-family:'Inter',sans-serif; width:100%; background:var(--bg); color:var(--text); }
        .btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .btn-primary { background:var(--primary); color:white; border-color:var(--primary); }
        .btn-primary:hover { background:var(--primary-dark); border-color:var(--primary-dark); transform:translateY(-1px); box-shadow:0 4px 12px var(--shadow-hover); }
        .btn-secondary { background:var(--bg-secondary); border-color:var(--border); }
        .btn-small { padding:0.5rem 1rem; font-size:0.875rem; }
        .btn-icon { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; }
        .btn-group { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; }
        /* INPUTS */
        .input-group { margin-bottom:1.25rem; }
        .input-group label { display:block; font-weight:500; margin-bottom:0.5rem; color:var(--text); font-size:0.875rem; }
        .input-group input,.input-group textarea { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:8px; font-size:0.9375rem; font-family:'Inter',sans-serif; transition:all 0.15s; background:var(--bg); color:var(--text); }
        .input-group input:focus,.input-group textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        /* PRODUCTS ‚Äì overflow fix */
        .product-item { background:var(--bg-secondary); padding:1rem; border-radius:8px; margin-bottom:0.75rem; border:1px solid var(--border); transition:all 0.15s; display:flex; gap:0.75rem; align-items:center; cursor:pointer; }
        .product-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .product-item.selected { border-color:var(--primary); background:var(--bg); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        .product-image { width:56px; height:56px; border-radius:6px; object-fit:cover; background:var(--bg-tertiary); border:1px solid var(--border); flex-shrink:0; }
        .product-info { flex:1; min-width:0; overflow:hidden; }
        .product-info h4 { font-weight:600; font-size:0.9rem; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; margin-bottom:0.15rem; }
        .product-info p { font-size:0.78rem; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .product-score { font-weight:700; color:var(--primary); font-size:1.25rem; flex-shrink:0; }
        .product-grid { display:grid; gap:0.75rem; }
        /* RATING */
        .rating-container { margin:2rem 0; }
        .rating-slider-container { position:relative; padding:1.5rem 0; }
        .rating-slider { width:100%; height:6px; border-radius:3px; background:var(--border); outline:none; -webkit-appearance:none; appearance:none; }
        .rating-slider::-webkit-slider-thumb { -webkit-appearance:none; width:28px; height:28px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; box-shadow:0 2px 8px rgba(37,99,235,0.3); }
        .rating-slider::-moz-range-thumb { width:28px; height:28px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; box-shadow:0 2px 8px rgba(37,99,235,0.3); }
        .rating-value { text-align:center; font-size:3rem; font-weight:700; margin:1rem 0; color:var(--primary); }
        .rating-labels { display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-tertiary); margin-top:0.5rem; }
        /* PARTICIPANTS */
        .participant { display:flex; align-items:center; padding:0.7rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); gap:0.75rem; }
        .participant-avatar { width:36px; height:36px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.9rem; color:white; flex-shrink:0; }
        .participant-info { flex:1; min-width:0; }
        .participant-actions { display:flex; gap:0.35rem; flex-shrink:0; }
        .participant-actions button { background:none; border:1px solid var(--border); border-radius:6px; padding:0.25rem 0.5rem; font-size:0.7rem; cursor:pointer; font-family:'Inter',sans-serif; color:var(--text-secondary); transition:all 0.15s; white-space:nowrap; }
        .participant-actions button:hover { border-color:var(--primary); color:var(--primary); }
        .participant-actions .btn-kick:hover { border-color:var(--error); color:var(--error); }
        /* CODE DISPLAY */
        .code-display { background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); padding:1.5rem; border-radius:12px; text-align:center; margin:1.25rem 0; box-shadow:0 4px 12px rgba(37,99,235,0.2); }
        .code-display .code { font-size:2.25rem; font-weight:700; letter-spacing:0.3em; margin:0.4rem 0; color:white; }
        .code-display p { color:rgba(255,255,255,0.9); font-size:0.825rem; }
        /* SEARCH */
        .search-results { max-height:350px; overflow-y:auto; margin-top:0.75rem; }
        .search-result-item { padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.15s; border:1px solid var(--border); display:flex; gap:0.75rem; align-items:center; }
        .search-result-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .search-result-item .product-info h4,.search-result-item .product-info strong { font-weight:600; font-size:0.9rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
        /* RESULTS */
        .result-card { background:var(--bg); border-radius:12px; padding:1.5rem; margin-bottom:1rem; border:1px solid var(--border); box-shadow:0 1px 3px var(--shadow); }
        .result-card h3 { margin-bottom:0.75rem; font-size:1.05rem; font-weight:600; word-break:break-word; }
        .rating-result { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
        .rating-score { font-size:1.5rem; font-weight:700; color:var(--primary); flex-shrink:0; }
        .avg-score { font-size:3rem; font-weight:700; text-align:center; margin:1.5rem 0; color:var(--primary); }
        /* BADGES */
        .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:6px; font-size:0.75rem; font-weight:500; border:1px solid; }
        .status-active { background:rgba(16,185,129,0.1); color:var(--success); border-color:var(--success); }
        /* ARCHIVE */
        .archive-item { background:var(--bg); padding:1.25rem; border-radius:12px; margin-bottom:0.75rem; border:1px solid var(--border); cursor:pointer; transition:all 0.15s; display:flex; gap:0.75rem; align-items:flex-start; }
        .archive-item:hover { border-color:var(--primary); box-shadow:0 4px 12px var(--shadow-hover); }
        .archive-icon { width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--primary),var(--primary-light)); display:flex; align-items:center; justify-content:center; flex-shrink:0; font-size:1.25rem; }
        .archive-content { flex:1; min-width:0; }
        .archive-content h3 { margin-bottom:0.35rem; font-size:0.95rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .archive-meta { display:flex; gap:0.75rem; font-size:0.775rem; color:var(--text-secondary); flex-wrap:wrap; }
        .archive-delete { background:none; border:none; color:var(--text-tertiary); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; transition:color 0.15s; }
        .archive-delete:hover { color:var(--error); }
        /* MISC */
        .loading { text-align:center; padding:3rem 1rem; color:var(--text-secondary); }
        .empty-state { text-align:center; padding:2.5rem 1rem; color:var(--text-secondary); }
        .empty-state .icon { font-size:2.5rem; margin-bottom:0.75rem; opacity:0.5; }
        .manual-product-form { background:var(--bg-secondary); padding:1.25rem; border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .section-title { font-size:1rem; font-weight:600; margin-bottom:1rem; }
        .stats-bar { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .stats-bar p { font-size:0.875rem; color:var(--text-secondary); }
        .edit-mode-banner { background:var(--bg-secondary); padding:0.875rem; border-radius:8px; margin-bottom:1rem; border:1px solid var(--border); text-align:center; font-size:0.875rem; color:var(--text-secondary); }
        /* RANKING */
        .ranking-item { display:flex; gap:0.75rem; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.6rem; border:1px solid var(--border); }
        .ranking-position { width:30px; height:30px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem; flex-shrink:0; }
        .ranking-position.gold { background:linear-gradient(135deg,#fbbf24,#f59e0b); }
        .ranking-position.silver { background:linear-gradient(135deg,#d1d5db,#9ca3af); }
        .ranking-position.bronze { background:linear-gradient(135deg,#f97316,#ea580c); }
        /* AUTH */
        .auth-container { max-width:400px; margin:2rem auto; }
        .social-login { display:flex; flex-direction:column; gap:0.75rem; margin-top:1rem; }
        .social-btn { display:flex; align-items:center; justify-content:center; gap:0.75rem; padding:0.875rem; border-radius:8px; border:1px solid var(--border); background:var(--bg); cursor:pointer; transition:all 0.15s; font-weight:500; font-family:'Inter',sans-serif; font-size:0.9375rem; }
        .social-btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .divider { text-align:center; margin:1.25rem 0; position:relative; }
        .divider::before { content:''; position:absolute; left:0; right:0; top:50%; height:1px; background:var(--border); }
        .divider span { background:var(--bg); padding:0 1rem; position:relative; color:var(--text-secondary); font-size:0.875rem; }
        /* SCANNER */
        .scanner-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
        .scanner-modal.active { display:flex; }
        .scanner-content { background:var(--bg); border-radius:12px; padding:1.5rem; max-width:500px; width:90%; border:1px solid var(--border); }
        /* PROFILE */
        .profile-avatar-big { width:96px; height:96px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; overflow:hidden; }
        /* FAV */
        .fav-item { background:var(--bg); padding:0.875rem; border-radius:10px; margin-bottom:0.5rem; border:1px solid var(--border); display:flex; align-items:center; gap:0.75rem; }
        .fav-item img { width:48px; height:48px; border-radius:6px; object-fit:cover; flex-shrink:0; border:1px solid var(--border); }
        .fav-item .fav-info { flex:1; min-width:0; }
        .fav-item .fav-info h4 { font-size:0.85rem; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .fav-item .fav-info p { font-size:0.75rem; color:var(--text-secondary); }
        .fav-remove { background:none; border:none; color:var(--error); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; }
        /* AUTH SPINNER */
        .auth-spinner { display:none; text-align:center; padding:1.5rem; }
        .auth-spinner.show { display:block; }
        .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.6s linear infinite; margin:0 auto; }
        @keyframes spin { to{transform:rotate(360deg)} }
        /* INVITE MINI */
        .invite-mini { background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:1px solid #c7d2fe; border-radius:10px; padding:0.85rem 1rem; margin-bottom:1rem; display:flex; align-items:center; gap:0.75rem; }
        .invite-mini .code-mini { font-weight:700; font-size:1.1rem; letter-spacing:0.15em; color:var(--primary); flex-shrink:0; }
        .invite-mini p { font-size:0.78rem; color:var(--text-secondary); flex:1; min-width:0; }
    </style>
</head>
<body>

<!-- PANDA MASCOT (normal ‚Äì standing, cute) -->
<svg id="mascotSVG" style="display:none" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
  <!-- body white -->
  <ellipse cx="100" cy="160" rx="58" ry="48" fill="white" stroke="#e2e8f0" stroke-width="1.5"/>
  <!-- belly blue accent -->
  <ellipse cx="100" cy="168" rx="30" ry="24" fill="#dbeafe"/>
  <!-- head white -->
  <circle cx="100" cy="82" r="52" fill="white" stroke="#e2e8f0" stroke-width="1.5"/>
  <!-- ears (black rounded) -->
  <ellipse cx="58" cy="40" rx="18" ry="22" fill="#1a1a1a"/>
  <ellipse cx="142" cy="40" rx="18" ry="22" fill="#1a1a1a"/>
  <!-- ear inner -->
  <ellipse cx="58" cy="42" rx="9" ry="12" fill="#374151"/>
  <ellipse cx="142" cy="42" rx="9" ry="12" fill="#374151"/>
  <!-- eye patches (black) -->
  <ellipse cx="78" cy="78" rx="18" ry="16" fill="#1a1a1a" transform="rotate(-5 78 78)"/>
  <ellipse cx="122" cy="78" rx="18" ry="16" fill="#1a1a1a" transform="rotate(5 122 78)"/>
  <!-- bridge between patches -->
  <ellipse cx="100" cy="82" rx="6" ry="5" fill="#1a1a1a"/>
  <!-- eyes (big, shiny ‚Äì Duolingo style) -->
  <circle cx="78" cy="76" r="9" fill="white"/>
  <circle cx="122" cy="76" r="9" fill="white"/>
  <circle cx="80" cy="77" r="5.5" fill="#1a1a1a"/>
  <circle cx="124" cy="77" r="5.5" fill="#1a1a1a"/>
  <!-- eye shine -->
  <circle cx="82" cy="74" r="2.2" fill="white"/>
  <circle cx="126" cy="74" r="2.2" fill="white"/>
  <!-- nose -->
  <ellipse cx="100" cy="92" rx="5" ry="3.5" fill="#1a1a1a"/>
  <!-- mouth -->
  <path d="M95 96 Q100 102 105 96" stroke="#1a1a1a" stroke-width="2" fill="none" stroke-linecap="round"/>
  <!-- cheek blush -->
  <ellipse cx="64" cy="92" rx="6" ry="3.5" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="136" cy="92" rx="6" ry="3.5" fill="#f59e0b" opacity="0.35"/>
  <!-- arms (black) -->
  <ellipse cx="46" cy="155" rx="13" ry="24" fill="#1a1a1a" transform="rotate(18 46 155)"/>
  <ellipse cx="154" cy="155" rx="13" ry="24" fill="#1a1a1a" transform="rotate(-18 154 155)"/>
  <!-- paws (white tips) -->
  <ellipse cx="40" cy="174" rx="8" ry="5" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <ellipse cx="160" cy="174" rx="8" ry="5" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <!-- legs (black) -->
  <ellipse cx="78" cy="200" rx="16" ry="11" fill="#1a1a1a"/>
  <ellipse cx="122" cy="200" rx="16" ry="11" fill="#1a1a1a"/>
  <!-- feet (white tips) -->
  <ellipse cx="78" cy="206" rx="14" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <ellipse cx="122" cy="206" rx="14" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
</svg>

<!-- PANDA MASCOT EATING (happy squinting, holding bowl) -->
<svg id="mascotEatingSVG" style="display:none" viewBox="0 0 240 230" xmlns="http://www.w3.org/2000/svg">
  <!-- body white -->
  <ellipse cx="120" cy="165" rx="58" ry="48" fill="white" stroke="#e2e8f0" stroke-width="1.5"/>
  <!-- belly blue -->
  <ellipse cx="120" cy="174" rx="30" ry="24" fill="#dbeafe"/>
  <!-- head white -->
  <circle cx="120" cy="84" r="52" fill="white" stroke="#e2e8f0" stroke-width="1.5"/>
  <!-- ears -->
  <ellipse cx="78" cy="42" rx="18" ry="22" fill="#1a1a1a"/>
  <ellipse cx="162" cy="42" rx="18" ry="22" fill="#1a1a1a"/>
  <ellipse cx="78" cy="44" rx="9" ry="12" fill="#374151"/>
  <ellipse cx="162" cy="44" rx="9" ry="12" fill="#374151"/>
  <!-- eye patches -->
  <ellipse cx="98" cy="80" rx="18" ry="16" fill="#1a1a1a" transform="rotate(-5 98 80)"/>
  <ellipse cx="142" cy="80" rx="18" ry="16" fill="#1a1a1a" transform="rotate(5 142 80)"/>
  <ellipse cx="120" cy="84" rx="6" ry="5" fill="#1a1a1a"/>
  <!-- happy squinting eyes (arc style) -->
  <path d="M88 76 Q98 68 108 76" stroke="white" stroke-width="4" fill="none" stroke-linecap="round"/>
  <path d="M132 76 Q142 68 152 76" stroke="white" stroke-width="4" fill="none" stroke-linecap="round"/>
  <!-- small shine dots -->
  <circle cx="92" cy="73" r="2" fill="white" opacity="0.7"/>
  <circle cx="136" cy="73" r="2" fill="white" opacity="0.7"/>
  <!-- nose -->
  <ellipse cx="120" cy="94" rx="5" ry="3.5" fill="#1a1a1a"/>
  <!-- open happy mouth -->
  <path d="M113 98 Q120 107 127 98" stroke="#1a1a1a" stroke-width="2.5" fill="#ef4444" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="84" cy="94" rx="6" ry="3.5" fill="#f59e0b" opacity="0.4"/>
  <ellipse cx="156" cy="94" rx="6" ry="3.5" fill="#f59e0b" opacity="0.4"/>
  <!-- arms holding bowl -->
  <ellipse cx="66" cy="158" rx="13" ry="24" fill="#1a1a1a" transform="rotate(22 66 158)"/>
  <ellipse cx="174" cy="158" rx="13" ry="24" fill="#1a1a1a" transform="rotate(-22 174 158)"/>
  <!-- paws -->
  <ellipse cx="58" cy="177" rx="9" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <ellipse cx="182" cy="177" rx="9" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <!-- BOWL -->
  <ellipse cx="120" cy="138" rx="34" ry="11" fill="#f59e0b"/>
  <path d="M86 138 Q120 168 154 138" fill="#e8920a"/>
  <!-- food bits -->
  <circle cx="106" cy="133" r="5" fill="#10b981"/>
  <circle cx="120" cy="130" r="6" fill="#ef4444"/>
  <circle cx="134" cy="134" r="4.5" fill="#3b82f6"/>
  <circle cx="113" cy="128" r="3.5" fill="#f59e0b"/>
  <circle cx="128" cy="127" r="3" fill="#10b981"/>
  <!-- legs -->
  <ellipse cx="98" cy="205" rx="16" ry="11" fill="#1a1a1a"/>
  <ellipse cx="142" cy="205" rx="16" ry="11" fill="#1a1a1a"/>
  <ellipse cx="98" cy="211" rx="14" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <ellipse cx="142" cy="211" rx="14" ry="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
</svg>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <div class="header-content">
            <button class="back-btn" id="backBtn" style="display:none;">‚Üê</button>
            <div><h1>TasteScore</h1><p id="headerSubtitle">Catas de productos en grupo</p></div>
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<nav id="bottomNav">
    <button class="nav-btn active" id="nav-home" onclick="navigateTo('home')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Inicio</span>
    </button>
    <button class="nav-btn" id="nav-ranking" onclick="navigateTo('ranking')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        <span>Ranking</span>
    </button>
    <button class="nav-btn" id="nav-favs" onclick="navigateTo('favs')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span>Favoritos</span>
    </button>
    <button class="nav-btn" id="nav-mytastings" onclick="navigateTo('myTastings')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span>Mis Catas</span>
    </button>
    <button class="nav-btn" id="nav-profile" onclick="navigateTo('auth')">
        <div id="navAvatar" style="width:24px;height:24px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;overflow:hidden;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="8" r="4"/></svg>
        </div>
        <span id="navProfileLabel">Perfil</span>
    </button>
</nav>

<!-- SCANNER MODAL -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-content">
        <h2 style="margin-bottom:0.75rem;font-size:1.125rem;font-weight:600;">Escanear C√≥digo de Barras</h2>
        <div id="reader" style="width:100%;border-radius:6px;overflow:hidden;"></div>
        <p id="scannerStatus" style="text-align:center;margin:0.75rem 0;color:var(--text-secondary);font-size:0.875rem;">Enfoca el c√≥digo de barras</p>
        <button class="btn btn-secondary" onclick="closeScanner()">Cancelar</button>
    </div>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
    <div class="container">
        <div style="text-align:center;padding:1.25rem 0 0.25rem;">
            <img id="homeMascot" src="" alt="TasteScore" style="width:150px;height:auto;">
        </div>
        <div class="card">
            <h2 style="margin-bottom:0.75rem;font-size:1.2rem;font-weight:600;text-align:center;">¬°Bienvenido!</h2>
            <p style="color:var(--text-secondary);margin-bottom:1.25rem;text-align:center;font-size:0.9rem;">Crea una cata o √∫nete a una existente.</p>
            <button class="btn btn-primary" onclick="showScreen('createScreen')" style="margin-bottom:0.6rem;">Crear Nueva Cata</button>
            <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Unirse a Cata</button>
        </div>
        <div class="card">
            <h3 style="margin-bottom:0.75rem;font-weight:600;font-size:0.95rem;">Catas Archivadas</h3>
            <div id="archivedList"></div>
        </div>
    </div>
</div>

<!-- RANKING -->
<div class="screen" id="rankingScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üèÜ Ranking Global</h2>
            <p style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.875rem;">Los productos mejor valorados</p>
            <div id="rankingList"></div>
        </div>
    </div>
</div>

<!-- AUTH -->
<div class="screen" id="authScreen">
    <div class="auth-container">
        <div class="card">
            <div style="text-align:center;margin-bottom:0.75rem;"><img id="authMascot" src="" alt="" style="width:72px;height:auto;"></div>
            <h2 id="authTitle" style="margin-bottom:1.25rem;font-size:1.2rem;font-weight:600;text-align:center;">Inicia Sesi√≥n</h2>
            <div class="social-login">
                <button class="social-btn" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continuar con Google
                </button>
            </div>
            <div class="divider"><span>o</span></div>
            <div class="input-group" id="nameGroup" style="display:none;"><label>Nombre</label><input type="text" id="authName" placeholder="Tu nombre"></div>
            <div class="input-group"><label>Email</label><input type="email" id="authEmail" placeholder="tu@email.com"></div>
            <div class="input-group"><label>Contrase√±a</label><input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div class="auth-spinner" id="authSpinner"><div class="spinner"></div></div>
            <button class="btn btn-primary" id="authBtn" onclick="loginWithEmail()">Iniciar Sesi√≥n</button>
            <p style="text-align:center;margin-top:0.875rem;color:var(--text-secondary);font-size:0.825rem;">
                ¬øNo tienes cuenta? <a href="#" onclick="toggleAuthMode();return false;" style="color:var(--primary);text-decoration:none;font-weight:500;" id="authToggleLink">Reg√≠strate</a>
            </p>
        </div>
    </div>
</div>

<!-- PROFILE -->
<div class="screen" id="profileScreen">
    <div class="container">
        <div class="card" style="text-align:center;">
            <div class="profile-avatar-big" id="profileAvatarBig"></div>
            <h2 id="profileName" style="font-size:1.2rem;font-weight:600;margin-bottom:0.2rem;"></h2>
            <p id="profileEmail" style="color:var(--text-secondary);font-size:0.825rem;margin-bottom:1.25rem;"></p>
            <button class="btn btn-secondary" onclick="logout()" style="max-width:180px;margin:0 auto;display:block;">Cerrar Sesi√≥n</button>
        </div>
    </div>
</div>

<!-- MY TASTINGS -->
<div class="screen" id="myTastingsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üìã Mis Catas</h2>
            <div id="userTastingsList"></div>
        </div>
    </div>
</div>

<!-- FAVOURITES -->
<div class="screen" id="favsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:0.6rem;font-size:1.2rem;font-weight:600;">‚ù§Ô∏è Favoritos</h2>
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
                <select id="favListSelector" style="flex:1;padding:0.55rem 0.7rem;border:1px solid var(--border);border-radius:8px;font-size:0.85rem;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);outline:none;" onchange="renderFavs()"><option value="__default__">Mi lista principal</option></select>
                <button class="btn btn-small btn-secondary btn-icon" onclick="createNewFavList()" style="width:auto;flex-shrink:0;">+ Lista</button>
            </div>
            <div id="favsList"></div>
        </div>
    </div>
</div>

<!-- CREATE -->
<div class="screen" id="createScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Crear Nueva Cata</h2>
            <div class="input-group"><label>Nombre de la Cata</label><input type="text" id="tastingName" placeholder="Ej: Cata de Quesos"></div>
            <div class="input-group"><label>Tu Nombre</label><input type="text" id="hostName" placeholder="Tu nombre"></div>
            <div class="input-group"><label>Descripci√≥n (opcional)</label><textarea id="tastingDescription" rows="3" placeholder="Detalles..."></textarea></div>
            <button class="btn btn-primary" onclick="createTasting()">Crear Cata</button>
        </div>
    </div>
</div>

<!-- JOIN -->
<div class="screen" id="joinScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Unirse a Cata</h2>
            <div class="input-group"><label>C√≥digo de Cata</label><input type="text" id="joinCode" placeholder="Ej: ABC123" style="text-transform:uppercase;"></div>
            <div class="input-group"><label>Tu Nombre</label><input type="text" id="participantName" placeholder="Tu nombre"></div>
            <button class="btn btn-primary" onclick="joinTasting()">Unirse</button>
        </div>
    </div>
</div>

<!-- WAITING ROOM -->
<div class="screen" id="waitingScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="waitingTastingName" style="margin-bottom:0.75rem;font-size:1.1rem;font-weight:600;"></h2>
            <div class="code-display">
                <p>C√≥digo de invitaci√≥n</p>
                <div class="code" id="displayCode"></div>
                <p>Comparte este c√≥digo</p>
            </div>
            <h3 style="margin:1.25rem 0 0.75rem;font-size:0.95rem;font-weight:600;">Participantes</h3>
            <div id="participantsList"></div>
            <button class="btn btn-primary" onclick="startTasting()" id="startBtn">Comenzar Cata</button>
        </div>
    </div>
</div>

<!-- ADD PRODUCTS -->
<div class="screen" id="addProductsScreen">
    <div class="container">
        <div class="card">
            <h2 class="section-title">A√±adir Productos</h2>
            <div class="input-group"><label>Buscar Producto</label><input type="text" id="productSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProducts()"></div>
            <div class="btn-group">
                <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                <button class="btn btn-secondary btn-icon" onclick="toggleManualForm()"><span>‚úçÔ∏è</span><span>Manual</span></button>
            </div>
            <div class="manual-product-form" id="manualProductForm" style="display:none;">
                <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                <div class="input-group"><label>Nombre</label><input type="text" id="manualProductName" placeholder="Ej: Queso Manchego"></div>
                <div class="input-group"><label>Marca</label><input type="text" id="manualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="manualProductImage" placeholder="https://..."></div>
                <button class="btn btn-primary" onclick="addManualProduct()">A√±adir</button>
            </div>
            <div class="search-results" id="searchResults"></div>
            <div style="margin:1.5rem 0;">
                <h3 class="section-title">Productos A√±adidos (<span id="productCount">0</span>)</h3>
                <div class="product-grid" id="addedProducts"></div>
            </div>
            <button class="btn btn-primary" onclick="finishAddingProducts()">Comenzar Votaci√≥n</button>
        </div>
    </div>
</div>

<!-- PRODUCT SELECTION (during voting) -->
<div class="screen" id="productSelectionScreen">
    <div class="container">
        <div class="card">
            <!-- invite mini bar (visible to host) -->
            <div class="invite-mini" id="inviteMini" style="display:none;">
                <span class="code-mini" id="inviteMiniCode"></span>
                <p>Comparte el c√≥digo para invitar m√°s personas</p>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h2 class="section-title" style="margin:0;">Selecciona Producto</h2>
                <div style="display:flex;gap:0.4rem;">
                    <button class="btn btn-secondary btn-small" onclick="showManageParticipants()" id="managePartBtn" style="display:none;">üë•</button>
                    <button class="btn btn-secondary btn-small" onclick="showEditMode()">‚úèÔ∏è</button>
                </div>
            </div>
            <div class="product-grid" id="productSelectionList"></div>
            <div class="stats-bar"><p><strong id="votedProductsCount">0</strong> de <strong id="totalProductsCount">0</strong> productos votados</p></div>
            <button class="btn btn-primary" onclick="showResults()" style="margin-top:1rem;">Ver Resultados</button>
        </div>
    </div>
</div>

<!-- MANAGE PARTICIPANTS (modal-like screen) -->
<div class="screen" id="manageParticipantsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;">Gestionar Participantes</h2>
            <div class="invite-mini">
                <span class="code-mini" id="manageMiniCode"></span>
                <p>C√≥digo para invitar</p>
            </div>
            <div id="manageParticipantsList"></div>
        </div>
    </div>
</div>

<!-- EDIT CATA -->
<div class="screen" id="editCataScreen">
    <div class="container">
        <div class="edit-mode-banner">Modo Edici√≥n ‚Äì A√±ade o elimina productos</div>
        <div class="card">
            <h2 class="section-title">A√±adir M√°s Productos</h2>
            <div class="input-group"><label>Buscar</label><input type="text" id="editProductSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProductsEdit()"></div>
            <div class="btn-group">
                <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                <button class="btn btn-secondary btn-icon" onclick="toggleManualFormEdit()"><span>‚úçÔ∏è</span><span>Manual</span></button>
            </div>
            <div class="manual-product-form" id="manualProductFormEdit" style="display:none;">
                <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                <div class="input-group"><label>Nombre</label><input type="text" id="editManualProductName" placeholder="Ej: Queso Manchego"></div>
                <div class="input-group"><label>Marca</label><input type="text" id="editManualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="editManualProductImage" placeholder="https://..."></div>
                <button class="btn btn-primary" onclick="addManualProductEdit()">A√±adir</button>
            </div>
            <div class="search-results" id="editSearchResults"></div>
        </div>
        <div class="card">
            <h2 class="section-title">Productos Actuales (<span id="editProductCount">0</span>)</h2>
            <div class="product-grid" id="editProductsList"></div>
        </div>
        <button class="btn btn-primary" onclick="exitEditMode()">Volver a la Cata</button>
    </div>
</div>

<!-- VOTING -->
<div class="screen" id="votingScreen">
    <div class="container">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h3 style="font-weight:600;font-size:0.95rem;">Votando Producto</h3>
                <span class="status-badge status-active">En votaci√≥n</span>
            </div>
            <div class="product-item" style="background:var(--bg-secondary);border-color:var(--primary);margin-bottom:1.5rem;cursor:default;">
                <img id="votingProductImage" class="product-image" src="" alt="">
                <div class="product-info"><h4 id="votingProductName"></h4><p id="votingProductBrand"></p></div>
            </div>
            <div class="rating-container">
                <label style="font-weight:500;display:block;margin-bottom:0.5rem;font-size:0.875rem;">Tu Puntuaci√≥n</label>
                <div class="rating-value" id="ratingValue">5.0</div>
                <div class="rating-slider-container">
                    <input type="range" id="ratingSlider" class="rating-slider" min="0" max="10" step="0.1" value="5.0" oninput="updateRatingValue()">
                    <div class="rating-labels"><span>0</span><span>5</span><span>10</span></div>
                </div>
            </div>
            <div class="input-group"><label>Comentarios (opcional)</label><textarea id="voteComment" rows="2" placeholder="Tus impresiones..."></textarea></div>
            <button class="btn btn-primary" onclick="submitVote()">Enviar Voto</button>
            <div class="stats-bar"><p><strong id="votedCount" style="color:var(--primary);">0</strong> de <strong id="votedTotal">0</strong> han votado</p></div>
        </div>
    </div>
</div>

<!-- WAITING VOTES -->
<div class="screen" id="waitingVotesScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;text-align:center;">
            <h2 style="margin-bottom:0.75rem;font-size:1.1rem;font-weight:600;">Voto Enviado ‚úì</h2>
            <p style="color:var(--text-secondary);margin-bottom:1.5rem;">Esperando a que todos voten...</p>
            <div class="loading"><div style="font-size:2.5rem;">‚è≥</div><p style="margin-top:0.75rem;"><strong id="waitingVotedCount">0</strong> de <strong id="waitingVotedTotal">0</strong> votos</p></div>
        </div>
    </div>
</div>

<!-- RESULTS -->
<div class="screen" id="resultsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;text-align:center;">Resultados</h2>
            <div id="resultsContainer"></div>
            <button class="btn btn-primary" onclick="finishTasting()" style="margin-top:1rem;">Finalizar Cata</button>
        </div>
    </div>
</div>

<!-- ARCHIVE DETAIL -->
<div class="screen" id="archiveScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="archiveTastingName" style="margin-bottom:0.35rem;font-size:1.1rem;font-weight:600;"></h2>
            <p id="archiveDate" style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.8rem;"></p>
            <div id="archiveResults"></div>
        </div>
    </div>
</div>

<!-- PWA INSTALL BANNER -->
<div id="installBanner" style="display:none;position:fixed;bottom:64px;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;padding:0.875rem;z-index:9999;box-shadow:0 -2px 8px rgba(0,0,0,0.07);">
    <div style="max-width:640px;margin:0 auto;display:flex;align-items:center;gap:0.75rem;">
        <div style="width:40px;height:40px;border-radius:10px;background:#2563eb;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><img id="bannerMascot" src="" alt="" style="width:32px;height:32px;"></div>
        <div style="flex:1;min-width:0;"><p style="font-weight:600;font-size:0.85rem;margin:0;color:#1a1a1a;">A√±adir TasteScore a tu m√≥vil</p><p style="font-size:0.75rem;color:#64748b;margin:0.1rem 0 0;">Acceso r√°pido desde pantalla de inicio</p></div>
        <button id="installBtn" style="background:#2563eb;color:white;border:none;padding:0.5rem 0.9rem;border-radius:8px;font-weight:600;font-size:0.8rem;cursor:pointer;font-family:'Inter',sans-serif;">A√±adir</button>
        <button id="dismissBanner" style="background:none;border:none;color:#94a3b8;font-size:1.1rem;cursor:pointer;">‚úï</button>
    </div>
</div>
<div id="iosModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:flex-end;justify-content:center;">
    <div style="background:#fff;border-radius:16px 16px 0 0;padding:1.5rem;max-width:500px;width:100%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h3 style="margin:0;font-size:1.1rem;font-weight:600;">A√±adir a pantalla de inicio</h3><button id="closeIosModal" style="background:none;border:none;font-size:1.5rem;color:#64748b;cursor:pointer;">‚úï</button></div>
        <div style="text-align:center;padding:0.75rem 0;"><div style="font-size:2.25rem;margin-bottom:0.5rem;">üì§</div><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.4rem;">Pulsa el bot√≥n de compartir</p><p style="color:#64748b;font-size:0.825rem;margin:0 0 0.75rem;">En la barra inferior de Safari</p><div style="background:#f8fafc;border-radius:8px;padding:0.85rem;border:1px solid #e2e8f0;"><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.2rem;font-size:0.9rem;">Selecciona "A√±adir a pantalla de inicio"</p></div></div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
// ===== MASCOTS =====
let MASCOT_URL='', MASCOT_EATING_URL='';
function initMascots(){
    MASCOT_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotSVG').outerHTML.replace(' style="display:none"',''));
    MASCOT_EATING_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotEatingSVG').outerHTML.replace(' style="display:none"',''));
    document.getElementById('homeMascot').src=MASCOT_EATING_URL;
    document.getElementById('authMascot').src=MASCOT_URL;
    document.getElementById('bannerMascot').src=MASCOT_URL;
}

// ===== STATE =====
let currentTasting=null, currentUser=null, selectedProductId=null;
let userVotes={}, searchTimeout=null, html5QrCode=null;
let globalRanking={}, isAuthMode='login', authenticatedUser=null;
let scannerTargetScreen='addProductsScreen';

// ===== INIT =====
function initApp(){
    initMascots();
    // Firebase auth state listener
    auth.onAuthStateChanged(function(user){
        if(user){
            authenticatedUser={ id:user.uid, name:user.displayName||user.email.split('@')[0], email:user.email, provider: user.providerData[0]?user.providerData[0].providerId:'password' };
        } else {
            authenticatedUser=null;
        }
        updateNavBar();
        loadGlobalRanking();
        loadArchivedTastings();
    });
}

// ===== NAV BAR =====
function updateNavBar(){
    const favBtn=document.getElementById('nav-favs'), myBtn=document.getElementById('nav-mytastings');
    const profileBtn=document.getElementById('nav-profile'), profileLabel=document.getElementById('navProfileLabel'), navAvatar=document.getElementById('navAvatar');
    if(authenticatedUser){
        favBtn.style.display='flex'; myBtn.style.display='flex';
        profileLabel.textContent=authenticatedUser.name.split(' ')[0];
        navAvatar.innerHTML='<span style="font-size:0.7rem;font-weight:700;color:white;">'+authenticatedUser.name[0].toUpperCase()+'</span>';
        profileBtn.onclick=function(){navigateTo('profile');};
    } else {
        favBtn.style.display='none'; myBtn.style.display='none';
        profileLabel.textContent='Perfil';
        navAvatar.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="8" r="4"/></svg>';
        profileBtn.onclick=function(){navigateTo('auth');};
    }
}

// ===== AUTH ‚Äì FIREBASE =====
function loginWithGoogle(){
    showAuthSpinner(true);
    auth.signInWithPopup(googleProvider).then(function(result){
        showAuthSpinner(false);
        showScreen('homeScreen');
    }).catch(function(error){
        showAuthSpinner(false);
        alert('Error con Google: '+error.message);
    });
}

function loginWithEmail(){
    const email=document.getElementById('authEmail').value.trim();
    const password=document.getElementById('authPassword').value.trim();
    if(!email||!password){alert('Completa email y contrase√±a');return;}
    showAuthSpinner(true);
    if(isAuthMode==='register'){
        const name=document.getElementById('authName').value.trim();
        if(!name){showAuthSpinner(false);alert('Completa el nombre');return;}
        if(password.length<6){showAuthSpinner(false);alert('La contrase√±a debe tener al menos 6 caracteres');return;}
        auth.createUserWithEmailAndPassword(email,password).then(function(userCredential){
            // Save display name
            userCredential.user.updateProfile({displayName:name}).then(function(){
                showAuthSpinner(false);
                showScreen('homeScreen');
            });
        }).catch(function(error){
            showAuthSpinner(false);
            if(error.code==='auth/email-already-in-use') alert('Este email ya tiene cuenta. Inicia sesi√≥n.');
            else if(error.code==='auth/invalid-email') alert('Email no v√°lido.');
            else alert('Error: '+error.message);
        });
    } else {
        auth.signInWithEmailAndPassword(email,password).then(function(){
            showAuthSpinner(false);
            showScreen('homeScreen');
        }).catch(function(error){
            showAuthSpinner(false);
            if(error.code==='auth/user-not-found') alert('No existe cuenta con ese email.');
            else if(error.code==='auth/wrong-password') alert('Contrase√±a incorrecta.');
            else alert('Error: '+error.message);
        });
    }
}

function showAuthSpinner(show){
    document.getElementById('authSpinner').className='auth-spinner'+(show?' show':'');
    document.getElementById('authBtn').style.display=show?'none':'block';
}

function toggleAuthMode(){
    isAuthMode=isAuthMode==='login'?'register':'login';
    document.getElementById('authTitle').textContent=isAuthMode==='register'?'Crear Cuenta':'Inicia Sesi√≥n';
    document.getElementById('authBtn').textContent=isAuthMode==='register'?'Registrarse':'Iniciar Sesi√≥n';
    document.getElementById('authToggleLink').textContent=isAuthMode==='register'?'Inicia sesi√≥n':'Reg√≠strate';
    document.getElementById('nameGroup').style.display=isAuthMode==='register'?'block':'none';
}

function logout(){
    auth.signOut().then(function(){ showScreen('homeScreen'); }).catch(function(){});
}

// ===== NAVIGATION =====
function navigateTo(dest){
    switch(dest){
        case 'home': showScreen('homeScreen'); break;
        case 'ranking': loadGlobalRanking(); showScreen('rankingScreen'); break;
        case 'myTastings': if(!authenticatedUser){showScreen('authScreen');break;} loadUserTastings(); showScreen('myTastingsScreen'); break;
        case 'favs': if(!authenticatedUser){showScreen('authScreen');break;} loadFavLists(); renderFavs(); showScreen('favsScreen'); break;
        case 'auth': showScreen('authScreen'); break;
        case 'profile': showScreen('profileScreen'); break;
    }
}
function setActiveNav(sid){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const map={homeScreen:'nav-home',rankingScreen:'nav-ranking',favsScreen:'nav-favs',myTastingsScreen:'nav-mytastings',profileScreen:'nav-profile',authScreen:'nav-profile'};
    const el=document.getElementById(map[sid]); if(el) el.classList.add('active');
}
function showScreen(sid){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(sid).classList.add('active');
    setActiveNav(sid);
    const bb=document.getElementById('backBtn');
    if(sid==='homeScreen'){bb.style.display='none';document.getElementById('headerSubtitle').textContent='Catas de productos en grupo';loadArchivedTastings();}
    else if(['rankingScreen','favsScreen','myTastingsScreen','profileScreen','authScreen'].includes(sid)){
        bb.style.display='none';
        const titles={rankingScreen:'Ranking Global',favsScreen:'Favoritos',myTastingsScreen:'Mis Catas',profileScreen:'Mi Perfil',authScreen:'Cuenta'};
        document.getElementById('headerSubtitle').textContent=titles[sid]||'';
    } else {
        bb.style.display='block';
        bb.onclick=function(){
            if(sid==='manageParticipantsScreen') showProductSelectionScreen();
            else if(currentTasting&&currentTasting.status==='voting') showProductSelectionScreen();
            else showScreen('homeScreen');
        };
        const subtitles={waitingScreen:'Sala de espera',addProductsScreen:'A√±adir productos',productSelectionScreen:'Cata en curso',editCataScreen:'Editar cata',votingScreen:'Votar producto',resultsScreen:'Resultados',archiveScreen:'Cata archivada',manageParticipantsScreen:'Participantes'};
        document.getElementById('headerSubtitle').textContent=subtitles[sid]||'';
    }
    if(sid==='profileScreen'&&authenticatedUser){
        document.getElementById('profileName').textContent=authenticatedUser.name;
        document.getElementById('profileEmail').textContent=authenticatedUser.email;
        document.getElementById('profileAvatarBig').innerHTML='<span style="font-size:2.5rem;font-weight:700;color:white;">'+authenticatedUser.name[0].toUpperCase()+'</span>';
    }
}

// ===== RANKING =====
function loadGlobalRanking(){globalRanking=JSON.parse(localStorage.getItem('globalRanking')||'{}');displayGlobalRanking();}
function updateGlobalRanking(name,brand,image,score){
    const key=(name+'|'+brand).toLowerCase();
    if(!globalRanking[key]) globalRanking[key]={name,brand,image,totalScore:0,voteCount:0,avgScore:0};
    globalRanking[key].totalScore+=score; globalRanking[key].voteCount++;
    globalRanking[key].avgScore=globalRanking[key].totalScore/globalRanking[key].voteCount;
    if(image) globalRanking[key].image=image;
    localStorage.setItem('globalRanking',JSON.stringify(globalRanking));
}
function displayGlobalRanking(){
    const c=document.getElementById('rankingList');
    const sorted=Object.values(globalRanking).sort((a,b)=>b.avgScore-a.avgScore).slice(0,50);
    if(!sorted.length){c.innerHTML='<div class="empty-state"><div class="icon">üèÜ</div><p>A√∫n no hay productos.<br>¬°S√© el primero en votar!</p></div>';return;}
    c.innerHTML=sorted.map((p,i)=>{
        const cls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        return `<div class="ranking-item"><div class="ranking-position ${cls}">${i+1}</div><img src="${p.image||''}" class="product-image" onerror="this.style.display='none'"><div class="product-info"><h4>${p.name}</h4><p>${p.brand} ‚Ä¢ ${p.voteCount} voto${p.voteCount===1?'':'s'}</p></div><div class="product-score">${p.avgScore.toFixed(1)}</div>${authenticatedUser?'<button onclick="toggleFav(\''+p.name.replace(/'/g,"\\'")+'\',' + "'"+p.brand.replace(/'/g,"\\'")+"'" + ',\''+((p.image||'')).replace(/'/g,"\\'")+'\')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;padding:0.2rem;flex-shrink:0;">'+(isFav(p.name,p.brand)?'‚ù§Ô∏è':'ü§ç')+'</button>':''}</div>`;
    }).join('');
}

// ===== MY TASTINGS =====
function loadUserTastings(){
    if(!authenticatedUser)return;
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    const list=archived.filter(t=>t.host===authenticatedUser.name||(t.participants||[]).some(p=>p.name===authenticatedUser.name));
    const c=document.getElementById('userTastingsList');
    if(!list.length){c.innerHTML='<div class="empty-state"><div class="icon">üìã</div><p>No has participado en ninguna cata</p></div>';return;}
    c.innerHTML=list.map((t)=>{
        const idx=archived.indexOf(t);
        return `<div class="archive-item" onclick="viewArchiveFromIndex(${idx})"><div class="archive-icon">üç∑</div><div class="archive-content"><h3>${t.name}</h3><div class="archive-meta"><span>üìÖ ${new Date(t.archivedAt).toLocaleDateString('es-ES')}</span><span>üë• ${t.participants.length}</span><span>üçΩÔ∏è ${t.products.length} prod.</span></div></div></div>`;
    }).join('');
}

// ===== FAVOURITES =====
function getFavData(){return JSON.parse(localStorage.getItem('favourites')||'{"__default__":[]}');}
function saveFavData(d){localStorage.setItem('favourites',JSON.stringify(d));}
function loadFavLists(){const data=getFavData();const sel=document.getElementById('favListSelector');sel.innerHTML='';Object.keys(data).forEach(k=>{sel.innerHTML+='<option value="'+k+'">'+(k==='__default__'?'Mi lista principal':k)+'</option>';});}
function isFav(name,brand){const data=getFavData();return Object.values(data).some(list=>list.some(p=>p.name===name&&p.brand===brand));}
function toggleFav(name,brand,image){
    const data=getFavData();
    for(const key of Object.keys(data)){const idx=data[key].findIndex(p=>p.name===name&&p.brand===brand);if(idx!==-1){data[key].splice(idx,1);saveFavData(data);if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();return;}}
    const sel=document.getElementById('favListSelector');const listKey=sel?sel.value:'__default__';
    if(!data[listKey])data[listKey]=[];data[listKey].push({name,brand,image:image||''});saveFavData(data);
    if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();
    if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();
}
function renderFavs(){
    const data=getFavData();const sel=document.getElementById('favListSelector');const items=data[sel.value]||[];const c=document.getElementById('favsList');
    if(!items.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">ü§ç</div><p>Lista vac√≠a.<br>A√±ade productos desde el Ranking.</p></div>';return;}
    c.innerHTML=items.map((p,i)=>`<div class="fav-item"><img src="${p.image||''}" onerror="this.style.display='none'" style="width:48px;height:48px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"><div class="fav-info"><h4>${p.name}</h4><p>${p.brand}</p></div><button class="fav-remove" onclick="removeFavFromList('${sel.value}',${i})">üóëÔ∏è</button></div>`).join('');
}
function removeFavFromList(k,i){const data=getFavData();data[k].splice(i,1);saveFavData(data);renderFavs();}
function createNewFavList(){const name=prompt('Nombre de la nueva lista:');if(!name||!name.trim())return;const key=name.trim();const data=getFavData();if(data[key]){alert('Ya existe esa lista');return;}data[key]=[];saveFavData(data);loadFavLists();document.getElementById('favListSelector').value=key;renderFavs();}

// ===== DEDUP =====
function normalizeProductName(n){return(n||'').toLowerCase().replace(/\s+/g,' ').replace(/[√°√†√§]/g,'a').replace(/[√©√®√´]/g,'e').replace(/[√≠√¨√Ø]/g,'i').replace(/[√≥√≤√∂]/g,'o').replace(/[√∫√π√º]/g,'u').trim();}
function deduplicateProducts(products){const seen=new Map();products.forEach(p=>{const key=normalizeProductName(p.product_name)+'|'+normalizeProductName(p.brands);if(!seen.has(key))seen.set(key,p);else{const ex=seen.get(key);if(p.image_url&&!ex.image_url)ex.image_url=p.image_url;}});return Array.from(seen.values());}

// ===== TASTING FLOW =====
function generateCode(){return Math.random().toString(36).substring(2,8).toUpperCase();}

function createTasting(){
    const name=document.getElementById('tastingName').value.trim();
    const hostName=document.getElementById('hostName').value.trim();
    const desc=document.getElementById('tastingDescription').value.trim();
    if(!name||!hostName){alert('Completa nombre de la cata y tu nombre');return;}
    currentTasting={id:Date.now().toString(),code:generateCode(),name,description:desc,host:hostName,participants:[{name:hostName,isHost:true}],products:[],votes:{},status:'waiting',createdAt:new Date().toISOString(),userId:authenticatedUser?authenticatedUser.id:null};
    currentUser={name:hostName,isHost:true};
    saveTasting(); showWaitingRoom();
}

function joinTasting(){
    const code=document.getElementById('joinCode').value.trim().toUpperCase();
    const name=document.getElementById('participantName').value.trim();
    if(!code||!name){alert('Completa c√≥digo y nombre');return;}
    const t=loadTastingByCode(code);
    if(!t){alert('C√≥digo no encontrado');return;}
    if(t.status==='finished'){alert('Esta cata ya finaliz√≥');return;}
    currentTasting=t; currentUser={name,isHost:false};
    if(!currentTasting.participants.find(p=>p.name===name)){currentTasting.participants.push(currentUser);saveTasting();}
    if(currentTasting.status==='waiting') showWaitingRoom();
    else if(currentTasting.status==='voting') showProductSelectionScreen();
    else showWaitingRoom();
}

function showWaitingRoom(){
    document.getElementById('waitingTastingName').textContent=currentTasting.name;
    document.getElementById('displayCode').textContent=currentTasting.code;
    updateParticipantsList();
    document.getElementById('startBtn').style.display=currentUser.isHost?'block':'none';
    showScreen('waitingScreen');
}

function updateParticipantsList(){
    document.getElementById('participantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost && !p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë Anfitri√≥n</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï Eliminar</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

function promoteToHost(idx){
    // remove current host flag
    currentTasting.participants.forEach(p=>p.isHost=false);
    currentTasting.participants[idx].isHost=true;
    currentTasting.host=currentTasting.participants[idx].name;
    // update currentUser
    if(currentUser.name===currentTasting.participants[idx].name) currentUser.isHost=true;
    else currentUser.isHost=false;
    saveTasting(); updateParticipantsList();
    // refresh manage screen if open
    if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
}

function kickParticipant(idx){
    const name=currentTasting.participants[idx].name;
    if(confirm('¬øEliminar a '+name+' de la cata?')){
        currentTasting.participants.splice(idx,1);
        saveTasting(); updateParticipantsList();
        if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
    }
}

function startTasting(){
    if(!currentUser.isHost)return;
    currentTasting.status='adding_products'; saveTasting();
    showScreen('addProductsScreen'); updateAddedProducts();
}

// ===== MANAGE PARTICIPANTS (during voting) =====
function showManageParticipants(){
    renderManageParticipants();
    showScreen('manageParticipantsScreen');
}
function renderManageParticipants(){
    document.getElementById('manageMiniCode').textContent=currentTasting.code;
    document.getElementById('manageParticipantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost&&!p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

// ===== SCANNER =====
function openScanner(){
    scannerTargetScreen=document.getElementById('editCataScreen').classList.contains('active')?'editCataScreen':'addProductsScreen';
    const modal=document.getElementById('scannerModal');modal.classList.add('active');
    document.getElementById('scannerStatus').textContent='Iniciando c√°mara...';
    if(html5QrCode){try{html5QrCode.stop();}catch(e){} html5QrCode=null;}
    document.getElementById('reader').innerHTML='';
    html5QrCode=new Html5Qrcode("reader",{verbose:false});
    Html5Qrcode.getCameras().then(function(cameras){
        if(!cameras||!cameras.length){document.getElementById('scannerStatus').textContent='No se encontr√≥ c√°mara';return;}
        let cameraId=cameras.length>1?cameras[cameras.length-1].id:cameras[0].id;
        document.getElementById('scannerStatus').textContent='Enfoca el c√≥digo de barras...';
        html5QrCode.start(cameraId,{fps:10,qrbox:{width:220,height:220}},
            function onDecode(text){
                document.getElementById('scannerStatus').textContent='C√≥digo detectado';
                html5QrCode.stop().then(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);}).catch(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);});
            },
            function onError(){}
        ).catch(function(err){document.getElementById('scannerStatus').textContent='Error al abrir c√°mara.';});
    }).catch(function(){document.getElementById('scannerStatus').textContent='Error al detectar c√°maras.';});
}
function closeScanner(){if(html5QrCode){html5QrCode.stop().catch(function(){});html5QrCode=null;}document.getElementById('reader').innerHTML='';document.getElementById('scannerModal').classList.remove('active');}
async function searchProductByBarcode(barcode){
    try{
        const res=await fetch('https://world.openfoodfacts.org/api/v0/product/'+barcode+'.json');
        const data=await res.json();
        if(data.status===1&&data.product){
            const p=data.product;const product={name:p.product_name||'Producto sin nombre',brand:p.brands||'Marca desconocida',image:p.image_url||''};
            if(scannerTargetScreen==='editCataScreen')addProductFromEdit(product);else addProduct(product);
        } else alert('Producto no encontrado. A√±√°delo manualmente.');
    }catch(e){alert('Error al buscar. Comprueba tu conexi√≥n.');}
}

// ===== PRODUCT SEARCH =====
async function searchProducts(){
    const q=document.getElementById('productSearch').value.trim();
    if(q.length<3){document.getElementById('searchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('searchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProduct('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('searchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}
async function searchProductsEdit(){
    const q=document.getElementById('editProductSearch').value.trim();
    if(q.length<3){document.getElementById('editSearchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('editSearchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProductFromEdit('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('editSearchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}

function toggleManualForm(){const f=document.getElementById('manualProductForm');f.style.display=f.style.display==='none'?'block':'none';}
function toggleManualFormEdit(){const f=document.getElementById('manualProductFormEdit');f.style.display=f.style.display==='none'?'block':'none';}
function addManualProduct(){const n=document.getElementById('manualProductName').value.trim(),b=document.getElementById('manualProductBrand').value.trim(),img=document.getElementById('manualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProduct({name:n,brand:b,image:img});document.getElementById('manualProductName').value='';document.getElementById('manualProductBrand').value='';document.getElementById('manualProductImage').value='';toggleManualForm();}
function addManualProductEdit(){const n=document.getElementById('editManualProductName').value.trim(),b=document.getElementById('editManualProductBrand').value.trim(),img=document.getElementById('editManualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProductFromEdit({name:n,brand:b,image:img});document.getElementById('editManualProductName').value='';document.getElementById('editManualProductBrand').value='';document.getElementById('editManualProductImage').value='';toggleManualFormEdit();}

function addProduct(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});saveTasting();updateAddedProducts();document.getElementById('productSearch').value='';document.getElementById('searchResults').innerHTML='';}
function addProductFromEdit(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});saveTasting();updateEditProductsList();document.getElementById('editProductSearch').value='';document.getElementById('editSearchResults').innerHTML='';}

function updateAddedProducts(){
    const c=document.getElementById('addedProducts');document.getElementById('productCount').textContent=currentTasting.products.length;
    if(!currentTasting.products.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üì¶</div><p>A√∫n no hay productos</p></div>';return;}
    c.innerHTML=currentTasting.products.map(function(p,i){return '<div class="product-item"><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p></div><button onclick="removeProduct('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;">‚úï</button></div>';}).join('');
}
function removeProduct(i){currentTasting.products.splice(i,1);saveTasting();updateAddedProducts();}
function finishAddingProducts(){if(!currentTasting.products.length){alert('A√±ade al menos un producto');return;}currentTasting.status='voting';saveTasting();showProductSelectionScreen();}

// ===== VOTING =====
function showProductSelectionScreen(){
    updateProductSelectionList();
    // Show invite mini + manage button for host
    const inviteMini=document.getElementById('inviteMini');
    const manageBtn=document.getElementById('managePartBtn');
    if(currentUser.isHost){inviteMini.style.display='flex';document.getElementById('inviteMiniCode').textContent=currentTasting.code;manageBtn.style.display='inline-flex';}
    else{inviteMini.style.display='none';manageBtn.style.display='none';}
    showScreen('productSelectionScreen');
}
function updateProductSelectionList(){
    const c=document.getElementById('productSelectionList');
    document.getElementById('votedProductsCount').textContent=Object.keys(userVotes).length;
    document.getElementById('totalProductsCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p){
        const voted=userVotes[p.id];
        return '<div class="product-item '+(voted?'selected':'')+'" onclick="'+(voted?'':'selectProduct(\''+p.id+'\')')+'" style="'+(voted?'cursor:default;opacity:0.6;':'')+'" ><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p></div>'+(voted?'<span style="color:var(--success);font-weight:600;font-size:0.9rem;flex-shrink:0;">‚úì</span>':'')+' </div>';
    }).join('');
}
function selectProduct(id){selectedProductId=id;showVotingScreen();}
function updateRatingValue(){document.getElementById('ratingValue').textContent=parseFloat(document.getElementById('ratingSlider').value).toFixed(1);}
function showVotingScreen(){
    const p=currentTasting.products.find(function(x){return x.id===selectedProductId;});if(!p)return;
    document.getElementById('votingProductName').textContent=p.name;
    document.getElementById('votingProductBrand').textContent=p.brand;
    document.getElementById('votingProductImage').src=p.image||'';
    document.getElementById('ratingSlider').value=5.0;updateRatingValue();document.getElementById('voteComment').value='';
    updateVoteCount(); showScreen('votingScreen');
}
function submitVote(){
    const score=parseFloat(document.getElementById('ratingSlider').value);
    const comment=document.getElementById('voteComment').value.trim();
    const product=currentTasting.products.find(function(p){return p.id===selectedProductId;});
    if(!currentTasting.votes[selectedProductId])currentTasting.votes[selectedProductId]=[];
    currentTasting.votes[selectedProductId]=currentTasting.votes[selectedProductId].filter(function(v){return v.user!==currentUser.name;});
    currentTasting.votes[selectedProductId].push({user:currentUser.name,score:score,comment:comment});
    userVotes[selectedProductId]=true;
    updateGlobalRanking(product.name,product.brand,product.image,score);
    saveTasting(); showProductSelectionScreen();
}
function updateVoteCount(){const votes=currentTasting.votes[selectedProductId]||[];document.getElementById('votedCount').textContent=votes.length;document.getElementById('votedTotal').textContent=currentTasting.participants.length;}

// ===== EDIT MODE =====
function showEditMode(){if(!currentUser.isHost){alert('Solo el anfitri√≥n puede editar');return;}updateEditProductsList();showScreen('editCataScreen');}
function updateEditProductsList(){
    const c=document.getElementById('editProductsList');document.getElementById('editProductCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p,i){
        const hasVotes=currentTasting.votes[p.id]&&currentTasting.votes[p.id].length>0;
        return '<div class="product-item"><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p>'+(hasVotes?'<p style="color:var(--success);font-size:0.72rem;margin-top:0.15rem;">‚úì '+currentTasting.votes[p.id].length+' votos</p>':'')+' </div><button onclick="removeProductFromEdit('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;" '+(hasVotes?'disabled style="opacity:0.4;cursor:not-allowed;"':'')+'>‚úï</button></div>';
    }).join('');
}
function removeProductFromEdit(i){const p=currentTasting.products[i];if(currentTasting.votes[p.id]&&currentTasting.votes[p.id].length){alert('No puedes eliminar un producto con votos');return;}currentTasting.products.splice(i,1);saveTasting();updateEditProductsList();}
function exitEditMode(){showProductSelectionScreen();}

// ===== RESULTS =====
function showResults(){
    currentTasting.status='finished';saveTasting();
    const c=document.getElementById('resultsContainer');
    c.innerHTML=currentTasting.products.map(function(product){
        const votes=currentTasting.votes[product.id]||[];const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        return '<div class="result-card"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="'+(product.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">'+product.name+'</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">'+product.brand+'</p></div></div><div class="avg-score">'+avg.toFixed(1)+'</div>'+(votes.length?'<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>'+votes.map(function(v){return '<div class="rating-result"><div><strong style="font-size:0.875rem;">'+v.user+'</strong>'+(v.comment?'<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">'+v.comment+'</p>':'')+' </div><div class="rating-score">'+v.score.toFixed(1)+'</div></div>';}).join(''):'<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>')+'</div>';
    }).join('');
    showScreen('resultsScreen');
}
function finishTasting(){archiveTasting();currentTasting=null;currentUser=null;userVotes={};showScreen('homeScreen');}

// ===== PERSISTENCE =====
function saveTasting(){const t=JSON.parse(localStorage.getItem('tastings')||'{}');t[currentTasting.code]=currentTasting;localStorage.setItem('tastings',JSON.stringify(t));}
function loadTastingByCode(code){return JSON.parse(localStorage.getItem('tastings')||'{}')[code];}
function archiveTasting(){const a=JSON.parse(localStorage.getItem('archivedTastings')||'[]');a.unshift({...currentTasting,archivedAt:new Date().toISOString()});localStorage.setItem('archivedTastings',JSON.stringify(a));}

function loadArchivedTastings(){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    const c=document.getElementById('archivedList');
    if(!archived.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üç∑</div><p>No tienes catas archivadas</p></div>';return;}
    c.innerHTML=archived.map(function(t,i){
        return '<div class="archive-item"><div class="archive-icon" onclick="viewArchive('+i+')">üç∑</div><div class="archive-content" onclick="viewArchive('+i+')"><h3>'+t.name+'</h3><div class="archive-meta"><span>üìÖ '+new Date(t.archivedAt).toLocaleDateString('es-ES')+'</span><span>üë• '+t.participants.length+' part.</span><span>üçΩÔ∏è '+t.products.length+' prod.</span></div></div><button class="archive-delete" onclick="deleteArchive('+i+',event)" title="Eliminar">üóëÔ∏è</button></div>';
    }).join('');
}
function deleteArchive(i,event){
    event.stopPropagation();
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    if(confirm('¬øEliminar la cata "'+archived[i].name+'"? No se puede recuperar.')){
        archived.splice(i,1);
        localStorage.setItem('archivedTastings',JSON.stringify(archived));
        loadArchivedTastings();
    }
}
function viewArchive(i){viewArchiveFromIndex(i);}
function viewArchiveFromIndex(i){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');const t=archived[i];
    document.getElementById('archiveTastingName').textContent=t.name;
    document.getElementById('archiveDate').textContent='Finalizada el '+new Date(t.archivedAt).toLocaleDateString('es-ES');
    const c=document.getElementById('archiveResults');
    c.innerHTML=t.products.map(function(product){
        const votes=t.votes[product.id]||[];const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        return '<div class="result-card"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="'+(product.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">'+product.name+'</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">'+product.brand+'</p></div></div><div class="avg-score">'+avg.toFixed(1)+'</div>'+(votes.length?'<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>'+votes.map(function(v){return '<div class="rating-result"><div><strong style="font-size:0.875rem;">'+v.user+'</strong>'+(v.comment?'<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">'+v.comment+'</p>':'')+' </div><div class="rating-score">'+v.score.toFixed(1)+'</div></div>';}).join(''):'<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>')+'</div>';
    }).join('');
    showScreen('archiveScreen');
}

// ===== INIT =====
initApp();

// ===== PWA =====
if('serviceWorker' in navigator){window.addEventListener('load',function(){navigator.serviceWorker.register('sw.js').catch(function(){});});}
let deferredPrompt=null;
const installBanner=document.getElementById('installBanner');
window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredPrompt=e;if(!sessionStorage.getItem('pwa-banner-dismissed'))installBanner.style.display='block';});
document.getElementById('installBtn').addEventListener('click',async function(){if(deferredPrompt){installBanner.style.display='none';deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}});
document.getElementById('dismissBanner').addEventListener('click',function(){installBanner.style.display='none';sessionStorage.setItem('pwa-banner-dismissed','true');});
document.getElementById('closeIosModal').addEventListener('click',function(){document.getElementById('iosModal').style.display='none';});
window.addEventListener('load',function(){if(/iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.matchMedia('(display-mode: standalone)').matches&&!sessionStorage.getItem('pwa-banner-dismissed'))setTimeout(function(){document.getElementById('iosModal').style.display='flex';},2000);});
</script>
</body>
</html>
