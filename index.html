<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TasteScore">
    <link rel="manifest" href="manifest.json">
    <title>TasteScore</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uhrdphpbmulaudexubgd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocmRwaHBibXVsYXVkZXh1YmdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMzU5NjMsImV4cCI6MjA4NTYxMTk2M30.6zzcr37VmDeXwVCP18m9cx-vQjJf7Z6ZstOEWUNONpw';
        const {createClient} = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#2563eb; --primary-dark:#1e40af; --primary-light:#3b82f6;
            --accent:#f59e0b; --bg:#ffffff; --bg-secondary:#f8fafc;
            --bg-tertiary:#e2e8f0; --border:#e2e8f0; --text:#1a1a1a;
            --text-secondary:#64748b; --text-tertiary:#94a3b8;
            --success:#10b981; --error:#ef4444;
            --shadow:rgba(0,0,0,0.05); --shadow-hover:rgba(37,99,235,0.15);
        }
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-secondary); color:var(--text); line-height:1.6;
            min-height:100vh; -webkit-font-smoothing:antialiased;
            padding-bottom:72px; max-width:100vw; overflow-x:hidden;
        }
        /* MOBILE-FIRST CONSTRAINT */
        .header, .container, #bottomNav { max-width:640px; margin-left:auto; margin-right:auto; }
        @media (min-width: 641px) {
            body { background:#e2e8f0; }
            .header { border-left:1px solid var(--border); border-right:1px solid var(--border); }
            #bottomNav { left:50%; transform:translateX(-50%); max-width:640px; border-left:1px solid var(--border); border-right:1px solid var(--border); }
        }
        /* HEADER */
        .header { background:rgba(255,255,255,0.95); padding:1rem; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; backdrop-filter:blur(10px); }
        .header-inner { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .header h1 { font-size:1.5rem; font-weight:700; letter-spacing:-0.02em; color:var(--primary); }
        .header p { font-size:0.875rem; color:var(--text-secondary); }
        .header-content { display:flex; align-items:center; }
        .header-profile { width:40px; height:40px; border-radius:50%; overflow:hidden; cursor:pointer; border:2px solid var(--border); transition:all 0.2s; }
        .header-profile:hover { border-color:var(--primary); transform:scale(1.05); }
        .header-profile img { width:100%; height:100%; object-fit:cover; }
        .back-btn { background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; padding:0.5rem; margin-right:0.75rem; }
        .back-btn:hover { opacity:0.6; }
        /* BOTTOM NAV */
        #bottomNav { position:fixed; bottom:0; left:0; right:0; height:64px; background:#fff; border-top:1px solid var(--border); display:flex; justify-content:space-around; align-items:center; z-index:500; box-shadow:0 -2px 10px rgba(0,0,0,0.06); }
        .nav-btn { display:flex; flex-direction:column; align-items:center; gap:2px; background:none; border:none; cursor:pointer; color:var(--text-secondary); font-size:0.6875rem; font-weight:500; padding:6px 10px; border-radius:8px; transition:color 0.15s; font-family:'Inter',sans-serif; flex:1; }
        .nav-btn svg { transition:stroke 0.15s; }
        .nav-btn:hover,.nav-btn.active { color:var(--primary); }
        .nav-btn.active svg { stroke:var(--primary); }
        /* SCREENS */
        .screen { display:none; animation:fadeIn 0.2s ease; }
        .screen.active { display:block; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .container { max-width:640px; margin:0 auto; padding:1.5rem 1rem; }
        /* CARDS & BUTTONS */
        .card { background:var(--bg); border-radius:12px; padding:1.5rem; margin-bottom:1rem; border:1px solid var(--border); box-shadow:0 1px 3px var(--shadow); }
        .btn { display:inline-block; padding:0.875rem 1.5rem; border-radius:8px; border:1px solid var(--border); font-weight:500; font-size:0.9375rem; cursor:pointer; transition:all 0.15s; text-align:center; font-family:'Inter',sans-serif; width:100%; background:var(--bg); color:var(--text); }
        .btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .btn-primary { background:var(--primary); color:white; border-color:var(--primary); }
        .btn-primary:hover { background:var(--primary-dark); border-color:var(--primary-dark); transform:translateY(-1px); box-shadow:0 4px 12px var(--shadow-hover); }
        .btn-secondary { background:var(--bg-secondary); border-color:var(--border); }
        .btn-small { padding:0.5rem 1rem; font-size:0.875rem; }
        .btn-icon { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; }
        .btn-group { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; }
        /* INPUTS */
        .input-group { margin-bottom:1.25rem; }
        .input-group label { display:block; font-weight:500; margin-bottom:0.5rem; color:var(--text); font-size:0.875rem; }
        .input-group input,.input-group textarea { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:8px; font-size:0.9375rem; font-family:'Inter',sans-serif; transition:all 0.15s; background:var(--bg); color:var(--text); }
        .input-group input:focus,.input-group textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        /* PRODUCTS ‚Äì overflow fix */
        .product-item { background:var(--bg-secondary); padding:1rem; border-radius:8px; margin-bottom:0.75rem; border:1px solid var(--border); transition:all 0.15s; display:flex; gap:0.75rem; align-items:center; cursor:pointer; }
        .drag-handle { width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:grab; color:var(--text-tertiary); flex-shrink:0; font-size:1.1rem; transition:color 0.2s; }
        .drag-handle:hover { color:var(--primary); }
        .drag-handle:active { cursor:grabbing; }
        .product-item.dragging { opacity:0.4; transform:scale(1.05); box-shadow:0 8px 24px rgba(37,99,235,0.3); border-color:var(--primary); background:var(--bg); }
        .product-item.ghost { opacity:0.5; background:var(--bg-tertiary); }
        .product-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .product-item.selected { border-color:var(--primary); background:var(--bg); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
        .product-image { width:56px; height:56px; border-radius:6px; object-fit:cover; background:var(--bg-tertiary); border:1px solid var(--border); flex-shrink:0; }
        .product-info { flex:1; min-width:0; overflow:hidden; }
        .product-info h4 { font-weight:600; font-size:0.9rem; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; margin-bottom:0.15rem; }
        .product-info p { font-size:0.78rem; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .product-score { font-weight:700; color:var(--primary); font-size:1.25rem; flex-shrink:0; }
        .product-grid { display:grid; gap:0.75rem; }
        /* RATING */
        .rating-container { margin:2rem 0; }
        .rating-slider-container { position:relative; padding:1.5rem 0; }
        .rating-slider { width:100%; height:6px; border-radius:3px; background:var(--border); outline:none; -webkit-appearance:none; appearance:none; }
        .rating-slider::-webkit-slider-thumb { -webkit-appearance:none; width:28px; height:28px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; box-shadow:0 2px 8px rgba(37,99,235,0.3); }
        .rating-slider::-moz-range-thumb { width:28px; height:28px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; box-shadow:0 2px 8px rgba(37,99,235,0.3); }
        .rating-value { text-align:center; font-size:3rem; font-weight:700; margin:1rem 0; color:var(--primary); }
        .rating-labels { display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-tertiary); margin-top:0.5rem; }
        /* PARTICIPANTS */
        .participant { display:flex; align-items:center; padding:0.7rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); gap:0.75rem; }
        .participant-avatar { width:36px; height:36px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.9rem; color:white; flex-shrink:0; }
        .participant-info { flex:1; min-width:0; }
        .participant-actions { display:flex; gap:0.35rem; flex-shrink:0; }
        .participant-actions button { background:none; border:1px solid var(--border); border-radius:6px; padding:0.25rem 0.5rem; font-size:0.7rem; cursor:pointer; font-family:'Inter',sans-serif; color:var(--text-secondary); transition:all 0.15s; white-space:nowrap; }
        .participant-actions button:hover { border-color:var(--primary); color:var(--primary); }
        .participant-actions .btn-kick:hover { border-color:var(--error); color:var(--error); }
        /* CODE DISPLAY */
        .code-display { background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); padding:1.5rem; border-radius:12px; text-align:center; margin:1.25rem 0; box-shadow:0 4px 12px rgba(37,99,235,0.2); }
        .code-display .code { font-size:2.25rem; font-weight:700; letter-spacing:0.3em; margin:0.4rem 0; color:white; }
        .code-display p { color:rgba(255,255,255,0.9); font-size:0.825rem; }
        /* SEARCH */
        .search-results { max-height:350px; overflow-y:auto; margin-top:0.75rem; }
        .search-result-item { padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.15s; border:1px solid var(--border); display:flex; gap:0.75rem; align-items:center; }
        .search-result-item:hover { background:var(--bg-tertiary); border-color:var(--primary); }
        .search-result-item .product-info h4,.search-result-item .product-info strong { font-weight:600; font-size:0.9rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
        /* RESULTS */
        .result-card { background:var(--bg); border-radius:12px; padding:1.5rem; margin-bottom:1rem; border:1px solid var(--border); box-shadow:0 1px 3px var(--shadow); }
        .result-card h3 { margin-bottom:0.75rem; font-size:1.05rem; font-weight:600; word-break:break-word; }
        .rating-result { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
        .rating-score { font-size:1.5rem; font-weight:700; color:var(--primary); flex-shrink:0; }
        .avg-score { font-size:3rem; font-weight:700; text-align:center; margin:1.5rem 0; color:var(--primary); }
        /* BADGES */
        .status-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:6px; font-size:0.75rem; font-weight:500; border:1px solid; }
        .status-active { background:rgba(16,185,129,0.1); color:var(--success); border-color:var(--success); }
        /* ARCHIVE */
        .archive-item { background:var(--bg); padding:1.25rem; border-radius:12px; margin-bottom:0.75rem; border:1px solid var(--border); cursor:pointer; transition:all 0.15s; display:flex; gap:0.75rem; align-items:flex-start; }
        .archive-item:hover { border-color:var(--primary); box-shadow:0 4px 12px var(--shadow-hover); }
        .archive-icon { width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--primary),var(--primary-light)); display:flex; align-items:center; justify-content:center; flex-shrink:0; overflow:hidden; }
        .archive-icon img { width:100%; height:100%; object-fit:cover; }
        .archive-content { flex:1; min-width:0; }
        .archive-content h3 { margin-bottom:0.35rem; font-size:0.95rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .archive-meta { display:flex; gap:0.75rem; font-size:0.775rem; color:var(--text-secondary); flex-wrap:wrap; }
        .archive-delete { background:none; border:none; color:var(--text-tertiary); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; transition:color 0.15s; }
        .archive-delete:hover { color:var(--error); }
        /* MISC */
        .loading { text-align:center; padding:3rem 1rem; color:var(--text-secondary); }
        .empty-state { text-align:center; padding:2.5rem 1rem; color:var(--text-secondary); }
        .empty-state .icon { font-size:2.5rem; margin-bottom:0.75rem; opacity:0.5; }
        .manual-product-form { background:var(--bg-secondary); padding:1.25rem; border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .section-title { font-size:1rem; font-weight:600; margin-bottom:1rem; }
        .stats-bar { display:flex; justify-content:space-between; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-top:1rem; border:1px solid var(--border); }
        .stats-bar p { font-size:0.875rem; color:var(--text-secondary); }
        .edit-mode-banner { background:var(--bg-secondary); padding:0.875rem; border-radius:8px; margin-bottom:1rem; border:1px solid var(--border); text-align:center; font-size:0.875rem; color:var(--text-secondary); }
        /* TABS */
        .tabs { display:flex; gap:0.5rem; margin-bottom:1.25rem; border-bottom:2px solid var(--border); }
        .tab { padding:0.75rem 1.25rem; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; font-weight:500; font-size:0.9rem; color:var(--text-secondary); transition:all 0.2s; font-family:'Inter',sans-serif; margin-bottom:-2px; }
        .tab:hover { color:var(--primary); }
        .tab.active { color:var(--primary); border-bottom-color:var(--primary); }
        /* RANKING */
        .ranking-item { display:flex; gap:0.75rem; align-items:center; padding:0.875rem; background:var(--bg-secondary); border-radius:8px; margin-bottom:0.6rem; border:1px solid var(--border); }
        .ranking-position { width:30px; height:30px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem; flex-shrink:0; }
        .ranking-position.gold { background:linear-gradient(135deg,#fbbf24,#f59e0b); }
        .ranking-position.silver { background:linear-gradient(135deg,#d1d5db,#9ca3af); }
        .ranking-position.bronze { background:linear-gradient(135deg,#f97316,#ea580c); }
        /* AUTH */
        .auth-container { max-width:400px; margin:2rem auto; }
        .social-login { display:flex; flex-direction:column; gap:0.75rem; margin-top:1rem; }
        .social-btn { display:flex; align-items:center; justify-content:center; gap:0.75rem; padding:0.875rem; border-radius:8px; border:1px solid var(--border); background:var(--bg); cursor:pointer; transition:all 0.15s; font-weight:500; font-family:'Inter',sans-serif; font-size:0.9375rem; }
        .social-btn:hover { background:var(--bg-secondary); border-color:var(--primary); }
        .divider { text-align:center; margin:1.25rem 0; position:relative; }
        .divider::before { content:''; position:absolute; left:0; right:0; top:50%; height:1px; background:var(--border); }
        .divider span { background:var(--bg); padding:0 1rem; position:relative; color:var(--text-secondary); font-size:0.875rem; }
        /* SCANNER */
        .scanner-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
        .scanner-modal.active { display:flex; }
        .scanner-content { background:var(--bg); border-radius:12px; padding:1.5rem; max-width:500px; width:90%; border:1px solid var(--border); }
        /* PROFILE */
        .profile-avatar-big { width:96px; height:96px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; overflow:hidden; }
        .avatar-option:hover { border-color:var(--primary)!important; background:var(--bg-secondary); }
        /* FAV */
        .fav-item { background:var(--bg); padding:0.875rem; border-radius:10px; margin-bottom:0.5rem; border:1px solid var(--border); display:flex; align-items:center; gap:0.75rem; }
        .fav-item img { width:48px; height:48px; border-radius:6px; object-fit:cover; flex-shrink:0; border:1px solid var(--border); }
        .fav-item .fav-info { flex:1; min-width:0; }
        .fav-item .fav-info h4 { font-size:0.85rem; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .fav-item .fav-info p { font-size:0.75rem; color:var(--text-secondary); }
        .fav-remove { background:none; border:none; color:var(--error); font-size:1.1rem; cursor:pointer; padding:0.2rem; flex-shrink:0; }
        /* AUTH SPINNER */
        .auth-spinner { display:none; text-align:center; padding:1.5rem; }
        .auth-spinner.show { display:block; }
        .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.6s linear infinite; margin:0 auto; }
        @keyframes spin { to{transform:rotate(360deg)} }
        /* INVITE MINI */
        .invite-mini { background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:1px solid #c7d2fe; border-radius:10px; padding:0.85rem 1rem; margin-bottom:1rem; display:flex; align-items:center; gap:0.75rem; }
        .invite-mini .code-mini { font-weight:700; font-size:1.1rem; letter-spacing:0.15em; color:var(--primary); flex-shrink:0; }
        .invite-mini p { font-size:0.78rem; color:var(--text-secondary); flex:1; min-width:0; }
        /* INPUT ERROR */
        .input-error input, .input-error textarea { border-color:var(--error) !important; background:#fef2f2; }
        .input-error input:focus, .input-error textarea:focus { box-shadow:0 0 0 3px rgba(239,68,68,0.15) !important; }
        .input-error label { color:var(--error) !important; }
        .field-error { font-size:0.75rem; color:var(--error); margin-top:0.3rem; display:none; }
        .field-error.show { display:block; }
        .field-success { font-size:0.75rem; color:var(--success); margin-top:0.3rem; display:none; }
        .field-success.show { display:block; }
        .password-strength { height:4px; border-radius:2px; margin-top:0.5rem; background:var(--border); overflow:hidden; display:none; }
        .password-strength.show { display:block; }
        .password-strength-bar { height:100%; transition:all 0.3s; border-radius:2px; }
        .password-strength-weak { width:33%; background:#ef4444; }
        .password-strength-medium { width:66%; background:#f59e0b; }
        .password-strength-strong { width:100%; background:#10b981; }
        .input-error { border-color:var(--error)!important; background:#fef2f2!important; }
        /* INVITE FAB */
        .invite-fab { position:fixed; bottom:80px; right:1rem; width:52px; height:52px; border-radius:50%; background:var(--primary); color:white; border:none; box-shadow:0 4px 14px rgba(37,99,235,0.4); display:none; align-items:center; justify-content:center; z-index:400; cursor:pointer; font-size:1.6rem; transition:transform 0.15s,box-shadow 0.15s; }
        .invite-fab:hover { transform:scale(1.08); box-shadow:0 6px 20px rgba(37,99,235,0.5); }
        .invite-fab.show { display:flex; }
        /* SHARE MODAL */
        .share-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:2000; align-items:flex-end; justify-content:center; }
        .share-overlay.active { display:flex; }
        .share-sheet { background:#fff; border-radius:16px 16px 0 0; padding:1.5rem; width:100%; max-width:500px; }
        .share-sheet h3 { margin:0 0 0.25rem; font-size:1.05rem; font-weight:600; }
        .share-sheet > p { color:var(--text-secondary); font-size:0.8rem; margin:0 0 1.25rem; }
        .share-code-big { background:linear-gradient(135deg,var(--primary),var(--primary-light)); border-radius:10px; padding:1rem; text-align:center; margin-bottom:1rem; }
        .share-code-big .code { font-size:2rem; font-weight:700; letter-spacing:0.3em; color:white; }
        .share-code-big p { color:rgba(255,255,255,0.85); font-size:0.78rem; margin:0.3rem 0 0; }
        .share-actions { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
        .share-actions button { padding:0.7rem; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); cursor:pointer; font-family:'Inter',sans-serif; font-size:0.82rem; font-weight:500; color:var(--text); transition:all 0.15s; display:flex; align-items:center; justify-content:center; gap:0.4rem; }
        .share-actions button:hover { border-color:var(--primary); color:var(--primary); background:#fff; }
        .share-close { display:block; width:100%; margin-top:0.85rem; padding:0.6rem; border:none; background:none; color:var(--text-secondary); font-size:0.82rem; cursor:pointer; font-family:'Inter',sans-serif; }
    </style>
</head>
<body>

<!-- PANDA MASCOT (normal) -->
<svg id="mascotSVG" style="display:none" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="58" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="142" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <!-- body -->
  <ellipse cx="100" cy="148" rx="52" ry="42" fill="white"/>
  <ellipse cx="100" cy="155" rx="26" ry="20" fill="#dbeafe"/>
  <!-- head -->
  <circle cx="100" cy="75" r="48" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="78" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(-5 78 72)"/>
  <ellipse cx="122" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(5 122 72)"/>
  <ellipse cx="100" cy="76" rx="5" ry="4" fill="#1a1a1a"/>
  <!-- eyes -->
  <circle cx="78" cy="70" r="8" fill="white"/>
  <circle cx="122" cy="70" r="8" fill="white"/>
  <circle cx="80" cy="71" r="5" fill="#1a1a1a"/>
  <circle cx="124" cy="71" r="5" fill="#1a1a1a"/>
  <circle cx="82" cy="69" r="2" fill="white"/>
  <circle cx="126" cy="69" r="2" fill="white"/>
  <!-- nose + mouth -->
  <ellipse cx="100" cy="85" rx="4" ry="3" fill="#1a1a1a"/>
  <path d="M96 89 Q100 94 104 89" stroke="#1a1a1a" stroke-width="1.8" fill="none" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="66" cy="85" rx="5" ry="3" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="134" cy="85" rx="5" ry="3" fill="#f59e0b" opacity="0.35"/>
  <!-- arms + legs -->
  <ellipse cx="48" cy="143" rx="11" ry="20" fill="#1a1a1a" transform="rotate(15 48 143)"/>
  <ellipse cx="152" cy="143" rx="11" ry="20" fill="#1a1a1a" transform="rotate(-15 152 143)"/>
  <ellipse cx="78" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="122" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA MASCOT EATING -->
<svg id="mascotEatingSVG" style="display:none" viewBox="0 0 220 210" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="68" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="152" cy="36" rx="16" ry="20" fill="#1a1a1a"/>
  <!-- body -->
  <ellipse cx="110" cy="150" rx="52" ry="42" fill="white"/>
  <ellipse cx="110" cy="157" rx="26" ry="20" fill="#dbeafe"/>
  <!-- head -->
  <circle cx="110" cy="75" r="48" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="88" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(-5 88 72)"/>
  <ellipse cx="132" cy="72" rx="16" ry="14" fill="#1a1a1a" transform="rotate(5 132 72)"/>
  <ellipse cx="110" cy="76" rx="5" ry="4" fill="#1a1a1a"/>
  <!-- squinting eyes -->
  <path d="M80 68 Q88 62 96 68" stroke="white" stroke-width="3.5" fill="none" stroke-linecap="round"/>
  <path d="M124 68 Q132 62 140 68" stroke="white" stroke-width="3.5" fill="none" stroke-linecap="round"/>
  <!-- nose + mouth -->
  <ellipse cx="110" cy="86" rx="4" ry="3" fill="#1a1a1a"/>
  <path d="M105 90 Q110 97 115 90" stroke="#1a1a1a" stroke-width="2" fill="#ef4444" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="74" cy="86" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <ellipse cx="146" cy="86" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <!-- arms -->
  <ellipse cx="58" cy="145" rx="11" ry="20" fill="#1a1a1a" transform="rotate(20 58 145)"/>
  <ellipse cx="162" cy="145" rx="11" ry="20" fill="#1a1a1a" transform="rotate(-20 162 145)"/>
  <!-- bowl -->
  <ellipse cx="110" cy="126" rx="32" ry="10" fill="#f59e0b"/>
  <path d="M78 126 Q110 154 142 126" fill="#e8920a"/>
  <circle cx="98" cy="121" r="4.5" fill="#10b981"/>
  <circle cx="110" cy="118" r="5.5" fill="#ef4444"/>
  <circle cx="122" cy="122" r="4" fill="#3b82f6"/>
  <!-- legs -->
  <ellipse cx="88" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="132" cy="183" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA MASCOT WAITING (sitting, for archives) -->
<svg id="mascotWaitingSVG" style="display:none" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="58" cy="34" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="142" cy="34" rx="16" ry="20" fill="#1a1a1a"/>
  <ellipse cx="100" cy="150" rx="54" ry="44" fill="white"/>
  <ellipse cx="100" cy="158" rx="28" ry="22" fill="#dbeafe"/>
  <circle cx="100" cy="70" r="46" fill="white"/>
  <ellipse cx="78" cy="68" rx="15" ry="13" fill="#1a1a1a" transform="rotate(-5 78 68)"/>
  <ellipse cx="122" cy="68" rx="15" ry="13" fill="#1a1a1a" transform="rotate(5 122 68)"/>
  <ellipse cx="100" cy="72" rx="5" ry="4" fill="#1a1a1a"/>
  <circle cx="78" cy="66" r="7" fill="white"/>
  <circle cx="122" cy="66" r="7" fill="white"/>
  <circle cx="80" cy="67" r="4.5" fill="#1a1a1a"/>
  <circle cx="124" cy="67" r="4.5" fill="#1a1a1a"/>
  <circle cx="82" cy="65" r="1.8" fill="white"/>
  <circle cx="126" cy="65" r="1.8" fill="white"/>
  <ellipse cx="100" cy="80" rx="3.5" ry="2.5" fill="#1a1a1a"/>
  <path d="M96 84 Q100 89 104 84" stroke="#1a1a1a" stroke-width="1.6" fill="none" stroke-linecap="round"/>
  <ellipse cx="66" cy="80" rx="4.5" ry="2.8" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="134" cy="80" rx="4.5" ry="2.8" fill="#f59e0b" opacity="0.35"/>
  <ellipse cx="90" cy="122" rx="10" ry="18" fill="#1a1a1a"/>
  <ellipse cx="110" cy="122" rx="10" ry="18" fill="#1a1a1a"/>
  <ellipse cx="75" cy="185" rx="14" ry="9" fill="#1a1a1a"/>
  <ellipse cx="125" cy="185" rx="14" ry="9" fill="#1a1a1a"/>
</svg>

<!-- PANDA HEAD EATING BAMBOO (for navbar profile) -->
<svg id="pandaHeadSVG" style="display:none" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <!-- ears -->
  <ellipse cx="28" cy="26" rx="14" ry="18" fill="#1a1a1a"/>
  <ellipse cx="92" cy="26" rx="14" ry="18" fill="#1a1a1a"/>
  <!-- head -->
  <circle cx="60" cy="60" r="42" fill="white"/>
  <!-- eye patches -->
  <ellipse cx="42" cy="56" rx="14" ry="12" fill="#1a1a1a" transform="rotate(-5 42 56)"/>
  <ellipse cx="78" cy="56" rx="14" ry="12" fill="#1a1a1a" transform="rotate(5 78 56)"/>
  <!-- eyes closed (eating) -->
  <path d="M36 54 Q42 50 48 54" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
  <path d="M72 54 Q78 50 84 54" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
  <!-- nose -->
  <ellipse cx="60" cy="66" rx="4" ry="3" fill="#1a1a1a"/>
  <!-- mouth eating -->
  <path d="M56 70 Q60 76 64 70" stroke="#1a1a1a" stroke-width="2" fill="#ef4444" stroke-linecap="round"/>
  <!-- cheeks -->
  <ellipse cx="32" cy="68" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <ellipse cx="88" cy="68" rx="5" ry="3" fill="#f59e0b" opacity="0.4"/>
  <!-- bamboo stick -->
  <rect x="70" y="45" width="4" height="35" rx="2" fill="#4ade80" transform="rotate(25 72 62)"/>
  <rect x="68" y="40" width="8" height="6" rx="2" fill="#22c55e"/>
  <rect x="68" y="48" width="8" height="6" rx="2" fill="#22c55e"/>
</svg>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <div class="header-content">
            <button class="back-btn" id="backBtn" style="display:none;">‚Üê</button>
            <div><h1>TasteScore</h1><p id="headerSubtitle">Catas de productos en grupo</p></div>
        </div>
        <div id="headerProfile" class="header-profile" onclick="navigateTo('profile')" style="display:none;">
            <img id="headerProfileImg" src="" alt="Perfil">
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<nav id="bottomNav">
    <button class="nav-btn active" id="nav-home" onclick="navigateTo('home')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Inicio</span>
    </button>
    <button class="nav-btn" id="nav-ranking" onclick="navigateTo('ranking')">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        <span>Ranking</span>
    </button>
    <button class="nav-btn" id="nav-favs" onclick="navigateTo('favs')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span>Favoritos</span>
    </button>
    <button class="nav-btn" id="nav-mytastings" onclick="navigateTo('myTastings')" style="display:none;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span>Mis Catas</span>
    </button>
</nav>

<!-- INVITE SHARE MODAL -->
<div id="inviteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:15000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;max-width:380px;width:90%;padding:1.75rem;box-shadow:0 8px 32px rgba(0,0,0,0.18);font-family:'Inter',sans-serif;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;font-size:1.05rem;font-weight:600;color:#1a1a1a;">Invitar a la cata</h3>
            <button onclick="document.getElementById('inviteModal').style.display='none'" style="background:none;border:none;font-size:1.4rem;color:#94a3b8;cursor:pointer;line-height:1;">‚úï</button>
        </div>
        <p style="color:#64748b;font-size:0.8rem;margin:0 0 1rem;">Comparte el c√≥digo o el enlace</p>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;text-align:center;margin-bottom:1rem;">
            <p style="font-size:0.72rem;color:#64748b;margin:0 0 0.3rem;text-transform:uppercase;letter-spacing:0.06em;font-weight:500;">C√≥digo</p>
            <p id="inviteModalCode" style="font-size:2rem;font-weight:700;letter-spacing:0.25em;color:#2563eb;margin:0;font-family:'Inter',sans-serif;"></p>
        </div>
        <button onclick="copyInviteCode()" style="width:100%;padding:0.7rem;border:1px solid #e2e8f0;border-radius:8px;background:#fff;color:#1a1a1a;font-size:0.85rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;display:flex;align-items:center;justify-content:center;gap:0.5rem;margin-bottom:0.5rem;" id="copyCodeBtn">üìã Copiar c√≥digo</button>
        <button onclick="shareInvite()" style="width:100%;padding:0.7rem;border:none;border-radius:8px;background:#2563eb;color:white;font-size:0.85rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;display:flex;align-items:center;justify-content:center;gap:0.5rem;">üì§ Compartir</button>
    </div>
</div>

<!-- EMAIL CONFIRMATION MODAL -->
<div id="emailConfirmModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:16000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:16px;max-width:420px;width:90%;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-family:'Inter',sans-serif;text-align:center;">
        <div style="width:72px;height:72px;margin:0 auto 1.25rem;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:50%;display:flex;align-items:center;justify-content:center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        </div>
        <h2 style="margin:0 0 0.75rem;font-size:1.35rem;font-weight:700;color:#1a1a1a;">Confirma tu email</h2>
        <p style="color:#64748b;font-size:0.95rem;line-height:1.6;margin:0 0 1.5rem;">Hemos enviado un email de confirmaci√≥n a <strong id="confirmEmailAddress" style="color:#2563eb;"></strong></p>
        <p style="color:#64748b;font-size:0.875rem;margin:0 0 1.75rem;padding:1rem;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;">Haz clic en el enlace del email para activar tu cuenta. Revisa tambi√©n la carpeta de spam.</p>
        <button onclick="openEmailApp()" style="width:100%;padding:0.9rem;border:none;border-radius:10px;background:#2563eb;color:white;font-size:0.95rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;margin-bottom:0.75rem;transition:all 0.2s;">üìß Abrir mi correo</button>
        <button onclick="closeEmailModal()" style="width:100%;padding:0.9rem;border:1px solid #e2e8f0;border-radius:10px;background:#fff;color:#64748b;font-size:0.9rem;font-weight:500;cursor:pointer;font-family:'Inter',sans-serif;">Cerrar</button>
    </div>
</div>

<!-- SCANNER MODAL -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-content">
        <h2 style="margin-bottom:0.75rem;font-size:1.125rem;font-weight:600;">Escanear C√≥digo de Barras</h2>
        <div id="reader" style="width:100%;border-radius:6px;overflow:hidden;"></div>
        <p id="scannerStatus" style="text-align:center;margin:0.75rem 0;color:var(--text-secondary);font-size:0.875rem;">Enfoca el c√≥digo de barras</p>
        <button class="btn btn-secondary" onclick="closeScanner()">Cancelar</button>
    </div>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
    <div class="container">
        <!-- Auth prompt for non-logged users -->
        <div class="card" id="homeAuthPrompt" style="display:none;">
            <div style="text-align:center;margin-bottom:1rem;">
                <img id="bannerMascot" src="" alt="" style="width:80px;height:auto;margin-bottom:0.75rem;">
                <h2 style="font-size:1.15rem;font-weight:600;margin-bottom:0.5rem;">¬°Bienvenido a TasteScore!</h2>
                <p style="color:var(--text-secondary);font-size:0.875rem;">Inicia sesi√≥n para guardar tus catas y acceder a todas las funciones</p>
            </div>
            <button class="btn btn-primary" onclick="navigateTo('auth')" style="margin-bottom:0.6rem;">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="isAuthMode='register'; toggleAuthMode(); navigateTo('auth');">Crear Cuenta</button>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom:0.75rem;font-size:1.2rem;font-weight:600;text-align:center;">¬°Bienvenido!</h2>
            <p style="color:var(--text-secondary);margin-bottom:1.25rem;text-align:center;font-size:0.9rem;">Crea una cata o √∫nete a una existente.</p>
            <button class="btn btn-primary" onclick="showScreen('createScreen')" style="margin-bottom:0.6rem;">Crear Nueva Cata</button>
            <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Unirse a Cata</button>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:0.75rem;font-weight:600;font-size:0.95rem;">Catas Archivadas</h3>
            <div id="archivedList"></div>
        </div>
    </div>
</div>

<!-- RANKING -->
<div class="screen" id="rankingScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üèÜ Ranking Global</h2>
            <p style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.875rem;">Los productos mejor valorados</p>
            <div id="rankingList"></div>
        </div>
    </div>
</div>

<!-- AUTH -->
<div class="screen" id="authScreen">
    <div class="auth-container">
        <div class="card">
            <div style="text-align:center;margin-bottom:0.75rem;"><img id="authMascot" src="" alt="" style="width:72px;height:auto;"></div>
            <h2 id="authTitle" style="margin-bottom:1.25rem;font-size:1.2rem;font-weight:600;text-align:center;">Inicia Sesi√≥n</h2>
            <div class="social-login">
                <button class="social-btn" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continuar con Google
                </button>
            </div>
            <div class="divider"><span>o</span></div>
            <div class="input-group" id="nameGroup" style="display:none;">
                <label>Nombre *</label>
                <input type="text" id="authName" placeholder="Tu nombre" oninput="clearAuthError('authName')">
                <p class="field-error" id="errAuthName">Este campo es obligatorio</p>
            </div>
            <div class="input-group">
                <label>Email *</label>
                <input type="email" id="authEmail" placeholder="tu@email.com" oninput="clearAuthError('authEmail')">
                <p class="field-error" id="errAuthEmail">Introduce un email v√°lido</p>
            </div>
            <div class="input-group">
                <label>Contrase√±a *</label>
                <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="checkPasswordStrength()">
                <div class="password-strength" id="passwordStrength">
                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                </div>
                <p class="field-error" id="errAuthPassword">La contrase√±a debe tener al menos 6 caracteres</p>
                <p class="field-success" id="passwordStrengthText"></p>
            </div>
            <div class="auth-spinner" id="authSpinner"><div class="spinner"></div></div>
            <button class="btn btn-primary" id="authBtn" onclick="loginWithEmail()">Iniciar Sesi√≥n</button>
            <p style="text-align:center;margin-top:0.875rem;color:var(--text-secondary);font-size:0.825rem;">
                ¬øNo tienes cuenta? <a href="#" onclick="toggleAuthMode();return false;" style="color:var(--primary);text-decoration:none;font-weight:500;" id="authToggleLink">Reg√≠strate</a>
            </p>
        </div>
    </div>
</div>

<!-- PROFILE -->
<div class="screen" id="profileScreen">
    <div class="container">
        <div class="card" style="text-align:center;">
            <div class="profile-avatar-big" id="profileAvatarBig" style="cursor:pointer;" onclick="showAvatarSelector()"></div>
            <p style="font-size:0.75rem;color:var(--text-tertiary);margin-bottom:1rem;">Toca para cambiar avatar</p>
            <h2 id="profileName" style="font-size:1.2rem;font-weight:600;margin-bottom:0.2rem;"></h2>
            <p id="profileEmail" style="color:var(--text-secondary);font-size:0.825rem;margin-bottom:1.25rem;"></p>
            <div style="display:grid;gap:0.75rem;max-width:300px;margin:0 auto;">
                <button class="btn btn-secondary" onclick="showEditProfile()">‚úèÔ∏è Editar Perfil</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
                <button class="btn" onclick="deleteAccount()" style="color:var(--error);border-color:var(--error);">üóëÔ∏è Eliminar Cuenta</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE -->
<div class="screen" id="editProfileScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Editar Perfil</h2>
            <div class="input-group">
                <label>Nombre de usuario</label>
                <input type="text" id="editProfileName" placeholder="Tu nombre">
            </div>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="editProfileEmail" placeholder="tu@email.com">
                <p style="font-size:0.75rem;color:var(--text-tertiary);margin-top:0.3rem;">Si cambias el email, deber√°s confirmar el nuevo</p>
            </div>
            <div class="input-group">
                <label>Nueva contrase√±a (opcional)</label>
                <input type="password" id="editProfilePassword" placeholder="Dejar vac√≠o para no cambiar">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-top:1.5rem;">
                <button class="btn btn-secondary" onclick="showScreen('profileScreen')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProfileChanges()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- AVATAR SELECTOR MODAL -->
<div id="avatarSelectorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:16000;align-items:center;justify-content:center;overflow-y:auto;">
    <div style="background:#fff;border-radius:16px;max-width:520px;width:90%;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-family:'Inter',sans-serif;margin:2rem auto;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h3 style="margin:0;font-size:1.15rem;font-weight:600;">Elige tu avatar</h3>
            <button onclick="closeAvatarSelector()" style="background:none;border:none;font-size:1.5rem;color:#94a3b8;cursor:pointer;">‚úï</button>
        </div>
        <h4 style="font-size:0.875rem;color:var(--text-secondary);margin:0 0 0.75rem;font-weight:600;">üêº Pandas</h4>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1.5rem;">
            <div class="avatar-option" onclick="selectAvatar('panda_normal')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_normal" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Normal</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_eating')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_eating" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Comiendo</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_waiting')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_waiting" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Esperando</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('panda_head')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <img src="" id="avatar_panda_head" style="width:60px;height:60px;margin-bottom:0.35rem;">
                <p style="font-size:0.75rem;color:var(--text-secondary);margin:0;">Con Bamb√∫</p>
            </div>
        </div>
        <h4 style="font-size:0.875rem;color:var(--text-secondary);margin:0 0 0.75rem;font-weight:600;">üçï Comidas</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;">
            <div class="avatar-option" onclick="selectAvatar('pizza')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçï</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Pizza</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('burger')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçî</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Burger</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('taco')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üåÆ</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Taco</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('sushi')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç£</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Sushi</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('ramen')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üçú</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Ramen</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('hotdog')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üå≠</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Hotdog</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('icecream')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç¶</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Helado</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('donut')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç©</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Donut</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('cookie')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">üç™</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Cookie</p>
            </div>
            <div class="avatar-option" onclick="selectAvatar('coffee')" style="border:3px solid transparent;border-radius:12px;padding:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;">
                <div style="font-size:48px;margin-bottom:0.25rem;">‚òï</div>
                <p style="font-size:0.7rem;color:var(--text-secondary);margin:0;">Caf√©</p>
            </div>
        </div>
    </div>
</div>

<!-- MY TASTINGS -->
<div class="screen" id="myTastingsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:1rem;font-size:1.2rem;font-weight:600;">üìã Mis Catas</h2>
            <div id="userTastingsList"></div>
        </div>
    </div>
</div>

<!-- FAVOURITES -->
<div class="screen" id="favsScreen">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom:0.6rem;font-size:1.2rem;font-weight:600;">‚ù§Ô∏è Favoritos</h2>
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
                <select id="favListSelector" style="flex:1;padding:0.55rem 0.7rem;border:1px solid var(--border);border-radius:8px;font-size:0.85rem;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);outline:none;" onchange="renderFavs()"><option value="__default__">Mi lista principal</option></select>
                <button class="btn btn-small btn-secondary btn-icon" onclick="createNewFavList()" style="width:auto;flex-shrink:0;">+ Lista</button>
            </div>
            <div id="favsList"></div>
        </div>
    </div>
</div>

<!-- CREATE -->
<div class="screen" id="createScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Crear Nueva Cata</h2>
            <div class="input-group" id="fieldTastingName"><label>Nombre de la Cata *</label><input type="text" id="tastingName" placeholder="Ej: Cata de Quesos"><p class="field-error" id="errTastingName">Este campo es obligatorio</p></div>
            <div class="input-group" id="fieldHostName"><label>Tu Nombre *</label><input type="text" id="hostName" placeholder="Tu nombre"><p class="field-error" id="errHostName">Este campo es obligatorio</p></div>
            <div class="input-group"><label>Fecha de la Cata (opcional)</label><input type="date" id="tastingDate" style="color-scheme:light;"></div>
            <div class="input-group"><label>Descripci√≥n (opcional)</label><textarea id="tastingDescription" rows="3" placeholder="Detalles..."></textarea></div>
            <button class="btn btn-primary" onclick="createTasting()">Crear Cata</button>
        </div>
    </div>
</div>

<!-- JOIN -->
<div class="screen" id="joinScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;">
            <h2 style="margin-bottom:1.25rem;font-size:1.1rem;font-weight:600;">Unirse a Cata</h2>
            <div class="input-group"><label>C√≥digo de Cata</label><input type="text" id="joinCode" placeholder="Ej: ABC123" style="text-transform:uppercase;"></div>
            <div class="input-group"><label>Tu Nombre</label><input type="text" id="participantName" placeholder="Tu nombre"></div>
            <button class="btn btn-primary" onclick="joinTasting()">Unirse</button>
        </div>
    </div>
</div>

<!-- WAITING ROOM -->
<div class="screen" id="waitingScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="waitingTastingName" style="margin-bottom:0.25rem;font-size:1.1rem;font-weight:600;"></h2>
            <p id="waitingTastingDate" style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:0.75rem;display:none;">üìÖ <span id="waitingDateText"></span></p>
            <div class="code-display">
                <p>C√≥digo de invitaci√≥n</p>
                <div class="code" id="displayCode"></div>
                <p>Comparte este c√≥digo</p>
            </div>
            <h3 style="margin:1.25rem 0 0.75rem;font-size:0.95rem;font-weight:600;">Participantes</h3>
            <div id="participantsList"></div>
            <button class="btn btn-primary" onclick="startTasting()" id="startBtn">Comenzar Cata</button>
        </div>
    </div>
</div>

<!-- ADD PRODUCTS -->
<div class="screen" id="addProductsScreen">
    <div class="container">
        <div class="card">
            <h2 class="section-title">A√±adir Productos</h2>
            <!-- TABS -->
            <div class="tabs">
                <button class="tab active" onclick="switchProductTab('supermarket')">üõí Supermercado</button>
                <button class="tab" onclick="switchProductTab('restaurant')">üçî Restaurantes</button>
            </div>
            <!-- SUPERMERCADO TAB -->
            <div id="supermarketTab">
                <div class="input-group"><label>Buscar Producto</label><input type="text" id="productSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProducts()"></div>
                <div class="btn-group">
                    <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualForm()"><span>‚úçÔ∏è</span><span>Manual</span></button>
                </div>
                <div class="manual-product-form" id="manualProductForm" style="display:none;">
                    <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                    <div class="input-group"><label>Nombre</label><input type="text" id="manualProductName" placeholder="Ej: Queso Manchego"></div>
                    <div class="input-group"><label>Marca</label><input type="text" id="manualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                    <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="manualProductImage" placeholder="https://..."></div>
                    <button class="btn btn-primary" onclick="addManualProduct()">A√±adir</button>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
            <!-- RESTAURANTES TAB -->
            <div id="restaurantTab" style="display:none;">
                <div class="input-group"><label>Buscar Plato o Restaurante</label><input type="text" id="restaurantSearch" placeholder="Buscar en McDonald's, Burger King, KFC..." oninput="searchRestaurants()"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary btn-icon" onclick="toggleManualFormRestaurant()"><span>‚úçÔ∏è</span><span>Manual</span></button>
                </div>
                <div class="manual-product-form" id="manualRestaurantForm" style="display:none;">
                    <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                    <div class="input-group"><label>Nombre</label><input type="text" id="manualRestaurantName" placeholder="Ej: Big Mac"></div>
                    <div class="input-group"><label>Restaurante</label><input type="text" id="manualRestaurantBrand" placeholder="Ej: McDonald's"></div>
                    <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="manualRestaurantImage" placeholder="https://..."></div>
                    <button class="btn btn-primary" onclick="addManualRestaurant()">A√±adir</button>
                </div>
                <div class="search-results" id="restaurantResults"></div>
            </div>
            <div style="margin:1.5rem 0;">
                <h3 class="section-title">Productos A√±adidos (<span id="productCount">0</span>)</h3>
                <div class="product-grid" id="addedProducts"></div>
            </div>
            <button class="btn btn-primary" onclick="finishAddingProducts()">Comenzar Votaci√≥n</button>
        </div>
    </div>
</div>

<!-- PRODUCT SELECTION (during voting) -->
<div class="screen" id="productSelectionScreen">
    <div class="container">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h2 class="section-title" style="margin:0;">Selecciona Producto</h2>
                <button class="btn btn-secondary btn-small" onclick="showEditMode()" id="editBtn" style="display:none;">‚úèÔ∏è</button>
            </div>
            <div class="product-grid" id="productSelectionList"></div>
            <div class="stats-bar"><p><strong id="votedProductsCount">0</strong> de <strong id="totalProductsCount">0</strong> productos votados</p></div>
            <button class="btn btn-primary" onclick="showResults()" style="margin-top:1rem;">Ver Resultados</button>
        </div>
    </div>
</div>

<!-- MANAGE PARTICIPANTS (modal-like screen) -->
<div class="screen" id="manageParticipantsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;">Gestionar Participantes</h2>
            <div class="invite-mini">
                <span class="code-mini" id="manageMiniCode"></span>
                <p>C√≥digo para invitar</p>
            </div>
            <div id="manageParticipantsList"></div>
        </div>
    </div>
</div>

<!-- EDIT CATA -->
<div class="screen" id="editCataScreen">
    <div class="container">
        <div class="edit-mode-banner">Modo Edici√≥n ‚Äì A√±ade o elimina productos</div>
        <div class="card">
            <h2 class="section-title">A√±adir M√°s Productos</h2>
            <div class="input-group"><label>Buscar</label><input type="text" id="editProductSearch" placeholder="Buscar en Open Food Facts..." oninput="searchProductsEdit()"></div>
            <div class="btn-group">
                <button class="btn btn-icon" onclick="openScanner()"><span>üì∑</span><span>Escanear</span></button>
                <button class="btn btn-secondary btn-icon" onclick="toggleManualFormEdit()"><span>‚úçÔ∏è</span><span>Manual</span></button>
            </div>
            <div class="manual-product-form" id="manualProductFormEdit" style="display:none;">
                <h4 style="margin-bottom:0.75rem;font-size:0.9rem;font-weight:600;">Producto Manual</h4>
                <div class="input-group"><label>Nombre</label><input type="text" id="editManualProductName" placeholder="Ej: Queso Manchego"></div>
                <div class="input-group"><label>Marca</label><input type="text" id="editManualProductBrand" placeholder="Ej: Garc√≠a Baquero"></div>
                <div class="input-group"><label>URL Imagen (opcional)</label><input type="text" id="editManualProductImage" placeholder="https://..."></div>
                <button class="btn btn-primary" onclick="addManualProductEdit()">A√±adir</button>
            </div>
            <div class="search-results" id="editSearchResults"></div>
        </div>
        <div class="card">
            <h2 class="section-title">Productos Actuales (<span id="editProductCount">0</span>)</h2>
            <div class="product-grid" id="editProductsList"></div>
        </div>
        <button class="btn btn-primary" onclick="exitEditMode()">Volver a la Cata</button>
    </div>
</div>

<!-- VOTING -->
<div class="screen" id="votingScreen">
    <div class="container">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h3 style="font-weight:600;font-size:0.95rem;">Votando Producto</h3>
                <span class="status-badge status-active">En votaci√≥n</span>
            </div>
            <div class="product-item" style="background:var(--bg-secondary);border-color:var(--primary);margin-bottom:1.5rem;cursor:default;">
                <img id="votingProductImage" class="product-image" src="" alt="">
                <div class="product-info"><h4 id="votingProductName"></h4><p id="votingProductBrand"></p></div>
            </div>
            <div class="rating-container">
                <label style="font-weight:500;display:block;margin-bottom:0.5rem;font-size:0.875rem;">Tu Puntuaci√≥n</label>
                <div class="rating-value" id="ratingValue">5.0</div>
                <div class="rating-slider-container">
                    <input type="range" id="ratingSlider" class="rating-slider" min="0" max="10" step="0.1" value="5.0" oninput="updateRatingValue()">
                    <div class="rating-labels"><span>0</span><span>5</span><span>10</span></div>
                </div>
            </div>
            <div class="input-group"><label>Comentarios (opcional)</label><textarea id="voteComment" rows="2" placeholder="Tus impresiones..."></textarea></div>
            <button class="btn btn-primary" onclick="submitVote()">Enviar Voto</button>
            <div class="stats-bar"><p><strong id="votedCount" style="color:var(--primary);">0</strong> de <strong id="votedTotal">0</strong> han votado</p></div>
        </div>
    </div>
</div>

<!-- WAITING VOTES -->
<div class="screen" id="waitingVotesScreen">
    <div class="container">
        <div class="card" style="margin-top:1rem;text-align:center;">
            <h2 style="margin-bottom:0.75rem;font-size:1.1rem;font-weight:600;">Voto Enviado ‚úì</h2>
            <p style="color:var(--text-secondary);margin-bottom:1.5rem;">Esperando a que todos voten...</p>
            <div class="loading"><div style="font-size:2.5rem;">‚è≥</div><p style="margin-top:0.75rem;"><strong id="waitingVotedCount">0</strong> de <strong id="waitingVotedTotal">0</strong> votos</p></div>
        </div>
    </div>
</div>

<!-- RESULTS -->
<div class="screen" id="resultsScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 style="margin-bottom:1rem;font-size:1.1rem;font-weight:600;text-align:center;">Resultados</h2>
            <div id="resultsContainer"></div>
            <button class="btn btn-primary" onclick="finishTasting()" style="margin-top:1rem;">Finalizar Cata</button>
        </div>
    </div>
</div>

<!-- ARCHIVE DETAIL -->
<div class="screen" id="archiveScreen">
    <div class="container">
        <div class="card" style="margin-top:0.75rem;">
            <h2 id="archiveTastingName" style="margin-bottom:0.35rem;font-size:1.1rem;font-weight:600;"></h2>
            <p id="archiveDate" style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.8rem;"></p>
            <div id="archiveResults"></div>
        </div>
    </div>
</div>

<!-- INVITE FAB (shown during active tasting) -->
<button class="invite-fab" id="inviteFab" onclick="openShareModal()">+</button>

<!-- SHARE MODAL -->
<div class="share-overlay" id="shareOverlay">
    <div class="share-sheet">
        <h3>Invitar a la Cata</h3>
        <p>Comparte el c√≥digo o el enlace</p>
        <div class="share-code-big">
            <div class="code" id="shareCodeBig"></div>
            <p>C√≥digo de invitaci√≥n</p>
        </div>
        <div class="share-actions">
            <button onclick="copyCode()">üìã Copiar c√≥digo</button>
            <button onclick="shareNative()">üì§ Compartir</button>
        </div>
        <button class="share-close" onclick="closeShareModal()">Cerrar</button>
    </div>
</div>

<!-- PWA INSTALL BANNER -->
<div id="installBanner" style="display:none;position:fixed;bottom:64px;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;padding:0.875rem;z-index:9999;box-shadow:0 -2px 8px rgba(0,0,0,0.07);">
    <div style="max-width:640px;margin:0 auto;display:flex;align-items:center;gap:0.75rem;">
        <div style="width:40px;height:40px;border-radius:10px;background:#2563eb;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><img id="bannerMascot" src="" alt="" style="width:32px;height:32px;"></div>
        <div style="flex:1;min-width:0;"><p style="font-weight:600;font-size:0.85rem;margin:0;color:#1a1a1a;">A√±adir TasteScore a tu m√≥vil</p><p style="font-size:0.75rem;color:#64748b;margin:0.1rem 0 0;">Acceso r√°pido desde pantalla de inicio</p></div>
        <button id="installBtn" style="background:#2563eb;color:white;border:none;padding:0.5rem 0.9rem;border-radius:8px;font-weight:600;font-size:0.8rem;cursor:pointer;font-family:'Inter',sans-serif;">A√±adir</button>
        <button id="dismissBanner" style="background:none;border:none;color:#94a3b8;font-size:1.1rem;cursor:pointer;">‚úï</button>
    </div>
</div>
<div id="iosModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:flex-end;justify-content:center;">
    <div style="background:#fff;border-radius:16px 16px 0 0;padding:1.5rem;max-width:500px;width:100%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h3 style="margin:0;font-size:1.1rem;font-weight:600;">A√±adir a pantalla de inicio</h3><button id="closeIosModal" style="background:none;border:none;font-size:1.5rem;color:#64748b;cursor:pointer;">‚úï</button></div>
        <div style="text-align:center;padding:0.75rem 0;"><div style="font-size:2.25rem;margin-bottom:0.5rem;">üì§</div><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.4rem;">Pulsa el bot√≥n de compartir</p><p style="color:#64748b;font-size:0.825rem;margin:0 0 0.75rem;">En la barra inferior de Safari</p><div style="background:#f8fafc;border-radius:8px;padding:0.85rem;border:1px solid #e2e8f0;"><p style="color:#1a1a1a;font-weight:500;margin:0 0 0.2rem;font-size:0.9rem;">Selecciona "A√±adir a pantalla de inicio"</p></div></div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// ===== MASCOTS =====
let MASCOT_URL='', MASCOT_EATING_URL='', MASCOT_WAITING_URL='', PANDA_HEAD_URL='';
const PANDA_AVATARS = {
    panda_normal: '',
    panda_eating: '',
    panda_waiting: '',
    panda_head: '',
    pizza: 'üçï',
    burger: 'üçî',
    taco: 'üåÆ',
    sushi: 'üç£',
    ramen: 'üçú',
    hotdog: 'üå≠',
    icecream: 'üç¶',
    donut: 'üç©',
    cookie: 'üç™',
    coffee: '‚òï'
};

function initMascots(){
    MASCOT_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotSVG').outerHTML.replace(' style="display:none"',''));
    MASCOT_EATING_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotEatingSVG').outerHTML.replace(' style="display:none"',''));
    MASCOT_WAITING_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('mascotWaitingSVG').outerHTML.replace(' style="display:none"',''));
    PANDA_HEAD_URL='data:image/svg+xml,'+encodeURIComponent(document.getElementById('pandaHeadSVG').outerHTML.replace(' style="display:none"',''));
    
    PANDA_AVATARS.panda_normal = MASCOT_URL;
    PANDA_AVATARS.panda_eating = MASCOT_EATING_URL;
    PANDA_AVATARS.panda_waiting = MASCOT_WAITING_URL;
    PANDA_AVATARS.panda_head = PANDA_HEAD_URL;
    
    document.getElementById('headerPanda').src=PANDA_HEAD_URL;
    document.getElementById('authMascot').src=MASCOT_URL;
    document.getElementById('bannerMascot').src=MASCOT_URL;
}

// ===== STATE =====
let currentTasting=null, currentUser=null, selectedProductId=null;
let userVotes={}, searchTimeout=null, html5QrCode=null;
let globalRanking={}, isAuthMode='login', authenticatedUser=null;
let scannerTargetScreen='addProductsScreen';
let sortableInstances={};

// ===== INIT =====
async function initApp(){
    initMascots();
    // Supabase auth state listener
    const {data:{session}} = await supabaseClient.auth.getSession();
    if(session && session.user){
        const {data:profile} = await supabaseClient.from('profiles').select('*').eq('id',session.user.id).single();
        if(profile){
            authenticatedUser={id:session.user.id, name:profile.name||session.user.email.split('@')[0], email:session.user.email};
        } else {
            authenticatedUser={id:session.user.id, name:session.user.email.split('@')[0], email:session.user.email};
        }
    }
    supabaseClient.auth.onAuthStateChange(async (_event, session)=>{
        if(session && session.user){
            const {data:profile} = await supabaseClient.from('profiles').select('*').eq('id',session.user.id).single();
            if(profile){
                authenticatedUser={id:session.user.id, name:profile.name||session.user.email.split('@')[0], email:session.user.email};
            } else {
                authenticatedUser={id:session.user.id, name:session.user.email.split('@')[0], email:session.user.email};
            }
        } else {
            authenticatedUser=null;
        }
        updateNavBar();
        loadGlobalRanking();
        loadArchivedTastings();
    });
    updateNavBar();
    loadGlobalRanking();
    loadArchivedTastings();
}

// ===== NAV BAR =====
async function updateNavBar(){
    const favBtn=document.getElementById('nav-favs'), myBtn=document.getElementById('nav-mytastings');
    const headerProfile=document.getElementById('headerProfile');
    const headerProfileImg=document.getElementById('headerProfileImg');
    
    if(authenticatedUser){
        favBtn.style.display='flex'; myBtn.style.display='flex';
        headerProfile.style.display='block';
        
        // Load user avatar
        const {data:profile} = await supabaseClient.from('profiles').select('avatar').eq('id',authenticatedUser.id).single();
        const avatarKey = profile?.avatar || 'panda_normal';
        
        if(PANDA_AVATARS[avatarKey]){
            if(avatarKey.startsWith('panda')){
                headerProfileImg.src = PANDA_AVATARS[avatarKey];
            }else{
                // Food emoji avatar
                headerProfileImg.style.display='none';
                headerProfile.innerHTML='<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:white;">'+PANDA_AVATARS[avatarKey]+'</div>';
                headerProfile.onclick=function(){navigateTo('profile');};
            }
        }
    } else {
        favBtn.style.display='none'; myBtn.style.display='none';
        headerProfile.style.display='none';
    }
}

// ===== AUTH ‚Äì localStorage-based =====
async function loginWithGoogle(){
    showAuthSpinner(true);
    const {error} = await supabaseClient.auth.signInWithOAuth({
        provider:'google',
        options: {
            redirectTo: 'https://sanchezcolmenero.github.io/tastescoreapp/'
        }
    });
    if(error){showAuthSpinner(false);alert('Error con Google: '+error.message);}
}

async function loginWithEmail(){
    const email=document.getElementById('authEmail').value.trim();
    const password=document.getElementById('authPassword').value.trim();
    
    // Clear previous errors
    document.querySelectorAll('.field-error').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('input').forEach(i=>i.classList.remove('input-error'));
    
    let hasError=false;
    
    if(isAuthMode==='register'){
        const name=document.getElementById('authName').value.trim();
        
        // Validate name
        if(!name){
            document.getElementById('errAuthName').classList.add('show');
            document.getElementById('authName').classList.add('input-error');
            hasError=true;
        }
        
        // Validate email
        if(!email || !email.includes('@') || !email.includes('.')){
            document.getElementById('errAuthEmail').classList.add('show');
            document.getElementById('authEmail').classList.add('input-error');
            hasError=true;
        }
        
        // Validate password
        if(password.length<6){
            document.getElementById('errAuthPassword').classList.add('show');
            document.getElementById('authPassword').classList.add('input-error');
            hasError=true;
        }
        
        if(hasError) return;
        
        showAuthSpinner(true);
        const {data,error} = await supabaseClient.auth.signUp({email:email,password:password});
        showAuthSpinner(false);
        if(error){alert('Error: '+error.message);return;}
        if(data.user){
            await supabaseClient.from('profiles').upsert({id:data.user.id,name:name,email:email,avatar:'panda_normal'});
            document.getElementById('confirmEmailAddress').textContent=email;
            document.getElementById('emailConfirmModal').style.display='flex';
        }
    } else {
        // Login validation
        if(!email){
            document.getElementById('errAuthEmail').classList.add('show');
            document.getElementById('authEmail').classList.add('input-error');
            hasError=true;
        }
        if(!password){
            document.getElementById('errAuthPassword').classList.add('show');
            document.getElementById('authPassword').classList.add('input-error');
            hasError=true;
        }
        
        if(hasError) return;
        
        showAuthSpinner(true);
        const {error} = await supabaseClient.auth.signInWithPassword({email:email,password:password});
        showAuthSpinner(false);
        if(error){
            if(error.message.includes('Invalid login')){
                alert('Email o contrase√±a incorrectos');
                document.getElementById('authEmail').classList.add('input-error');
                document.getElementById('authPassword').classList.add('input-error');
            }
            else if(error.message.includes('Email not confirmed')) alert('Confirma tu email antes de iniciar sesi√≥n. Revisa tu bandeja de entrada.');
            else alert('Error: '+error.message);
        } else {
            showScreen('homeScreen');
        }
    }
}

function clearAuthError(fieldId){
    const errId='err'+fieldId.charAt(0).toUpperCase()+fieldId.slice(1);
    document.getElementById(errId).classList.remove('show');
    document.getElementById(fieldId).classList.remove('input-error');
}

function checkPasswordStrength(){
    const pass=document.getElementById('authPassword').value;
    const strength=document.getElementById('passwordStrength');
    const bar=document.getElementById('passwordStrengthBar');
    const text=document.getElementById('passwordStrengthText');
    
    if(!pass || isAuthMode==='login'){
        strength.classList.remove('show');
        text.classList.remove('show');
        return;
    }
    
    strength.classList.add('show');
    let score=0;
    if(pass.length>=8) score++;
    if(pass.length>=12) score++;
    if(/[a-z]/.test(pass) && /[A-Z]/.test(pass)) score++;
    if(/[0-9]/.test(pass)) score++;
    if(/[^A-Za-z0-9]/.test(pass)) score++;
    
    bar.className='password-strength-bar';
    if(score<=2){
        bar.classList.add('password-strength-weak');
        text.textContent='‚ö†Ô∏è Contrase√±a d√©bil';
        text.style.color='#ef4444';
    }else if(score<=4){
        bar.classList.add('password-strength-medium');
        text.textContent='üëç Contrase√±a media';
        text.style.color='#f59e0b';
    }else{
        bar.classList.add('password-strength-strong');
        text.textContent='‚úÖ ¬°Contrase√±a fuerte!';
        text.style.color='#10b981';
    }
    text.classList.add('show');
}

function openEmailApp(){
    const email=document.getElementById('confirmEmailAddress').textContent;
    if(email.includes('@gmail.')) window.open('https://mail.google.com','_blank');
    else if(email.includes('@outlook.') || email.includes('@hotmail.')) window.open('https://outlook.live.com','_blank');
    else if(email.includes('@yahoo.')) window.open('https://mail.yahoo.com','_blank');
    else window.location.href='mailto:';
}

function closeEmailModal(){
    document.getElementById('emailConfirmModal').style.display='none';
    showScreen('authScreen');
}

function showAuthSpinner(show){
    document.getElementById('authSpinner').className='auth-spinner'+(show?' show':'');
    document.getElementById('authBtn').style.display=show?'none':'block';
}

function toggleAuthMode(){
    isAuthMode=isAuthMode==='login'?'register':'login';
    document.getElementById('authTitle').textContent=isAuthMode==='register'?'Crear Cuenta':'Inicia Sesi√≥n';
    document.getElementById('authBtn').textContent=isAuthMode==='register'?'Registrarse':'Iniciar Sesi√≥n';
    document.getElementById('authToggleLink').textContent=isAuthMode==='register'?'Inicia sesi√≥n':'Reg√≠strate';
    document.getElementById('nameGroup').style.display=isAuthMode==='register'?'block':'none';
    document.getElementById('emailSentMsg').style.display='none';
    // Clear errors and password strength
    document.querySelectorAll('.field-error').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('input').forEach(i=>i.classList.remove('input-error'));
    document.getElementById('passwordStrength').classList.remove('show');
    document.getElementById('passwordStrengthText').classList.remove('show');
    checkPasswordStrength();
}

async function logout(){
    await supabaseClient.auth.signOut();
    showScreen('homeScreen');
}

// ===== NAVIGATION =====
function navigateTo(dest){
    switch(dest){
        case 'home': showScreen('homeScreen'); break;
        case 'ranking': loadGlobalRanking(); showScreen('rankingScreen'); break;
        case 'myTastings': if(!authenticatedUser){showScreen('authScreen');break;} loadUserTastings(); showScreen('myTastingsScreen'); break;
        case 'favs': if(!authenticatedUser){showScreen('authScreen');break;} loadFavLists(); renderFavs(); showScreen('favsScreen'); break;
        case 'auth': showScreen('authScreen'); break;
        case 'profile': if(!authenticatedUser){showScreen('authScreen');break;} loadProfileData(); showScreen('profileScreen'); break;
    }
}
function setActiveNav(sid){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const map={homeScreen:'nav-home',rankingScreen:'nav-ranking',favsScreen:'nav-favs',myTastingsScreen:'nav-mytastings',profileScreen:'nav-profile',authScreen:'nav-profile',editProfileScreen:'nav-profile'};
    const el=document.getElementById(map[sid]); if(el) el.classList.add('active');
}
function showScreen(sid){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(sid).classList.add('active');
    setActiveNav(sid);
    const bb=document.getElementById('backBtn');
    if(sid==='homeScreen'){
        bb.style.display='none';
        document.getElementById('headerSubtitle').textContent='Catas de productos en grupo';
        loadArchivedTastings();
        // Show auth prompt if not logged in
        document.getElementById('homeAuthPrompt').style.display = authenticatedUser ? 'none' : 'block';
    }
    else if(['rankingScreen','favsScreen','myTastingsScreen','profileScreen','authScreen'].includes(sid)){
        bb.style.display='none';
        const titles={rankingScreen:'Ranking Global',favsScreen:'Favoritos',myTastingsScreen:'Mis Catas',profileScreen:'Mi Perfil',authScreen:'Cuenta'};
        document.getElementById('headerSubtitle').textContent=titles[sid]||'';
    } else {
        bb.style.display='block';
        bb.onclick=function(){
            if(sid==='manageParticipantsScreen') showProductSelectionScreen();
            else if(currentTasting&&currentTasting.status==='voting') showProductSelectionScreen();
            else showScreen('homeScreen');
        };
        const subtitles={waitingScreen:'Sala de espera',addProductsScreen:'A√±adir productos',productSelectionScreen:'Cata en curso',editCataScreen:'Editar cata',votingScreen:'Votar producto',resultsScreen:'Resultados',archiveScreen:'Cata archivada',manageParticipantsScreen:'Participantes',editProfileScreen:'Editar perfil'};
        document.getElementById('headerSubtitle').textContent=subtitles[sid]||'';
    }
    if(sid==='profileScreen'&&authenticatedUser){
        document.getElementById('profileName').textContent=authenticatedUser.name;
        document.getElementById('profileEmail').textContent=authenticatedUser.email;
        document.getElementById('profileAvatarBig').innerHTML='<span style="font-size:2.5rem;font-weight:700;color:white;">'+authenticatedUser.name[0].toUpperCase()+'</span>';
    }
    // FAB: show on all active-tasting screens (not finished, not archive-only)
    const fab=document.getElementById('inviteFab');
    const fabScreens=['waitingScreen','addProductsScreen','productSelectionScreen','editCataScreen','votingScreen','resultsScreen','manageParticipantsScreen'];
    if(currentTasting && currentTasting.status!=='finished' && fabScreens.includes(sid)){fab.classList.add('show');}
    else{fab.classList.remove('show');}
}

// ===== INVITE / SHARE =====
function openShareModal(){
    if(!currentTasting)return;
    document.getElementById('inviteModalCode').textContent=currentTasting.code;
    document.getElementById('inviteModal').style.display='flex';
}
function copyInviteCode(){
    navigator.clipboard.writeText(currentTasting.code).then(function(){
        const btn=document.getElementById('copyCodeBtn');
        btn.innerHTML='üìã ¬°Copiado!';
        setTimeout(function(){btn.innerHTML='üìã Copiar c√≥digo';},1400);
    }).catch(function(){
        // fallback
        const t=document.createElement('textarea');t.value=currentTasting.code;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);
        const btn=document.getElementById('copyCodeBtn');btn.innerHTML='üìã ¬°Copiado!';setTimeout(function(){btn.innerHTML='üìã Copiar c√≥digo';},1400);
    });
}
function shareInvite(){
    const text='√önete a la cata "'+currentTasting.name+'" con el c√≥digo: '+currentTasting.code;
    if(navigator.share){navigator.share({title:'TasteScore ‚Äì '+currentTasting.name,text:text}).catch(function(){});}
    else{copyInviteCode();}
}

// ===== RANKING =====
function loadGlobalRanking(){globalRanking=JSON.parse(localStorage.getItem('globalRanking')||'{}');displayGlobalRanking();}
function updateGlobalRanking(name,brand,image,score){
    const key=(name+'|'+brand).toLowerCase();
    if(!globalRanking[key]) globalRanking[key]={name,brand,image,totalScore:0,voteCount:0,avgScore:0};
    globalRanking[key].totalScore+=score; globalRanking[key].voteCount++;
    globalRanking[key].avgScore=globalRanking[key].totalScore/globalRanking[key].voteCount;
    if(image) globalRanking[key].image=image;
    localStorage.setItem('globalRanking',JSON.stringify(globalRanking));
}
function displayGlobalRanking(){
    const c=document.getElementById('rankingList');
    const sorted=Object.values(globalRanking).sort((a,b)=>b.avgScore-a.avgScore).slice(0,50);
    if(!sorted.length){c.innerHTML='<div class="empty-state"><div class="icon">üèÜ</div><p>A√∫n no hay productos.<br>¬°S√© el primero en votar!</p></div>';return;}
    c.innerHTML=sorted.map((p,i)=>{
        const cls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        return `<div class="ranking-item"><div class="ranking-position ${cls}">${i+1}</div><img src="${p.image||''}" class="product-image" onerror="this.style.display='none'"><div class="product-info"><h4>${p.name}</h4><p>${p.brand} ‚Ä¢ ${p.voteCount} voto${p.voteCount===1?'':'s'}</p></div><div class="product-score">${p.avgScore.toFixed(1)}</div>${authenticatedUser?'<button onclick="toggleFav(\''+p.name.replace(/'/g,"\\'")+'\',' + "'"+p.brand.replace(/'/g,"\\'")+"'" + ',\''+((p.image||'')).replace(/'/g,"\\'")+'\')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;padding:0.2rem;flex-shrink:0;">'+(isFav(p.name,p.brand)?'‚ù§Ô∏è':'ü§ç')+'</button>':''}</div>`;
    }).join('');
}

// ===== MY TASTINGS =====
function loadUserTastings(){
    if(!authenticatedUser)return;
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    const list=archived.filter(t=>t.host===authenticatedUser.name||(t.participants||[]).some(p=>p.name===authenticatedUser.name));
    const c=document.getElementById('userTastingsList');
    if(!list.length){c.innerHTML='<div class="empty-state"><div class="icon">üìã</div><p>No has participado en ninguna cata</p></div>';return;}
    c.innerHTML=list.map((t)=>{
        const idx=archived.indexOf(t);
        return `<div class="archive-item" onclick="viewArchiveFromIndex(${idx})"><div class="archive-icon"><img src="${MASCOT_WAITING_URL}" alt=""></div><div class="archive-content"><h3>${t.name}</h3><div class="archive-meta"><span>üìÖ ${new Date(t.archivedAt).toLocaleDateString('es-ES')}</span><span>üë• ${t.participants.length}</span><span>üçΩÔ∏è ${t.products.length} prod.</span></div></div></div>`;
    }).join('');
}

// ===== FAVOURITES =====
function getFavData(){return JSON.parse(localStorage.getItem('favourites')||'{"__default__":[]}');}
function saveFavData(d){localStorage.setItem('favourites',JSON.stringify(d));}
function loadFavLists(){const data=getFavData();const sel=document.getElementById('favListSelector');sel.innerHTML='';Object.keys(data).forEach(k=>{sel.innerHTML+='<option value="'+k+'">'+(k==='__default__'?'Mi lista principal':k)+'</option>';});}
function isFav(name,brand){const data=getFavData();return Object.values(data).some(list=>list.some(p=>p.name===name&&p.brand===brand));}
function toggleFav(name,brand,image){
    const data=getFavData();
    for(const key of Object.keys(data)){const idx=data[key].findIndex(p=>p.name===name&&p.brand===brand);if(idx!==-1){data[key].splice(idx,1);saveFavData(data);if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();return;}}
    const sel=document.getElementById('favListSelector');const listKey=sel?sel.value:'__default__';
    if(!data[listKey])data[listKey]=[];data[listKey].push({name,brand,image:image||''});saveFavData(data);
    if(document.getElementById('rankingScreen').classList.contains('active'))displayGlobalRanking();
    if(document.getElementById('favsScreen').classList.contains('active'))renderFavs();
}
function renderFavs(){
    const data=getFavData();const sel=document.getElementById('favListSelector');const items=data[sel.value]||[];const c=document.getElementById('favsList');
    if(!items.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">ü§ç</div><p>Lista vac√≠a.<br>A√±ade productos desde el Ranking.</p></div>';return;}
    c.innerHTML=items.map((p,i)=>`<div class="fav-item"><img src="${p.image||''}" onerror="this.style.display='none'" style="width:48px;height:48px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"><div class="fav-info"><h4>${p.name}</h4><p>${p.brand}</p></div><button class="fav-remove" onclick="removeFavFromList('${sel.value}',${i})">üóëÔ∏è</button></div>`).join('');
}
function removeFavFromList(k,i){const data=getFavData();data[k].splice(i,1);saveFavData(data);renderFavs();}
function createNewFavList(){const name=prompt('Nombre de la nueva lista:');if(!name||!name.trim())return;const key=name.trim();const data=getFavData();if(data[key]){alert('Ya existe esa lista');return;}data[key]=[];saveFavData(data);loadFavLists();document.getElementById('favListSelector').value=key;renderFavs();}

// ===== DEDUP =====
function normalizeProductName(n){return(n||'').toLowerCase().replace(/\s+/g,' ').replace(/[√°√†√§]/g,'a').replace(/[√©√®√´]/g,'e').replace(/[√≠√¨√Ø]/g,'i').replace(/[√≥√≤√∂]/g,'o').replace(/[√∫√π√º]/g,'u').trim();}
function deduplicateProducts(products){const seen=new Map();products.forEach(p=>{const key=normalizeProductName(p.product_name)+'|'+normalizeProductName(p.brands);if(!seen.has(key))seen.set(key,p);else{const ex=seen.get(key);if(p.image_url&&!ex.image_url)ex.image_url=p.image_url;}});return Array.from(seen.values());}

// ===== TASTING FLOW =====
function generateCode(){return Math.random().toString(36).substring(2,8).toUpperCase();}

function createTasting(){
    const name=document.getElementById('tastingName').value.trim();
    let hostName=document.getElementById('hostName').value.trim();
    const desc=document.getElementById('tastingDescription').value.trim();
    const date=document.getElementById('tastingDate').value;
    // Pre-fill from authenticated user if empty
    if(!hostName && authenticatedUser) hostName=authenticatedUser.name;
    // Inline validation
    let hasError=false;
    const errN=document.getElementById('errTastingName'), errH=document.getElementById('errHostName');
    const fieldN=document.getElementById('fieldTastingName'), fieldH=document.getElementById('fieldHostName');
    if(!name){errN.classList.add('show');fieldN.querySelector('input').style.borderColor='var(--error)';hasError=true;}
    else{errN.classList.remove('show');fieldN.querySelector('input').style.borderColor='';}
    if(!hostName){errH.classList.add('show');fieldH.querySelector('input').style.borderColor='var(--error)';hasError=true;}
    else{errH.classList.remove('show');fieldH.querySelector('input').style.borderColor='';}
    if(hasError)return;
    // Update field with auto-filled value
    document.getElementById('hostName').value=hostName;
    currentTasting={id:Date.now().toString(),code:generateCode(),name,description:desc,date:date||null,host:hostName,participants:[{name:hostName,isHost:true}],products:[],votes:{},status:'waiting',createdAt:new Date().toISOString(),userId:authenticatedUser?authenticatedUser.id:null};
    currentUser={name:hostName,isHost:true};
    saveTasting(); showWaitingRoom();
}

function joinTasting(){
    const code=document.getElementById('joinCode').value.trim().toUpperCase();
    let name=document.getElementById('participantName').value.trim();
    // Pre-fill from authenticated user if empty
    if(!name && authenticatedUser) name=authenticatedUser.name;
    if(!code||!name){alert('Completa c√≥digo y nombre');return;}
    const t=loadTastingByCode(code);
    if(!t){alert('C√≥digo no encontrado');return;}
    if(t.status==='finished'){alert('Esta cata ya finaliz√≥');return;}
    currentTasting=t; currentUser={name,isHost:false};
    if(!currentTasting.participants.find(p=>p.name===name)){currentTasting.participants.push(currentUser);saveTasting();}
    if(currentTasting.status==='waiting') showWaitingRoom();
    else if(currentTasting.status==='voting') showProductSelectionScreen();
    else showWaitingRoom();
}

function showWaitingRoom(){
    document.getElementById('waitingTastingName').textContent=currentTasting.name;
    document.getElementById('displayCode').textContent=currentTasting.code;
    if(currentTasting.date){
        document.getElementById('waitingTastingDate').style.display='block';
        document.getElementById('waitingDateText').textContent=new Date(currentTasting.date+'T12:00:00').toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else { document.getElementById('waitingTastingDate').style.display='none'; }
    updateParticipantsList();
    document.getElementById('startBtn').style.display=currentUser.isHost?'block':'none';
    showScreen('waitingScreen');
}

function updateParticipantsList(){
    document.getElementById('participantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost && !p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë Anfitri√≥n</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï Eliminar</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

function promoteToHost(idx){
    // remove current host flag
    currentTasting.participants.forEach(p=>p.isHost=false);
    currentTasting.participants[idx].isHost=true;
    currentTasting.host=currentTasting.participants[idx].name;
    // update currentUser
    if(currentUser.name===currentTasting.participants[idx].name) currentUser.isHost=true;
    else currentUser.isHost=false;
    saveTasting(); updateParticipantsList();
    // refresh manage screen if open
    if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
}

function kickParticipant(idx){
    const name=currentTasting.participants[idx].name;
    if(confirm('¬øEliminar a '+name+' de la cata?')){
        currentTasting.participants.splice(idx,1);
        saveTasting(); updateParticipantsList();
        if(document.getElementById('manageParticipantsScreen').classList.contains('active')) renderManageParticipants();
    }
}

function startTasting(){
    if(!currentUser.isHost)return;
    currentTasting.status='adding_products'; saveTasting();
    showScreen('addProductsScreen'); updateAddedProducts();
}

// ===== MANAGE PARTICIPANTS (during voting) =====
function showManageParticipants(){
    renderManageParticipants();
    showScreen('manageParticipantsScreen');
}
function renderManageParticipants(){
    document.getElementById('manageMiniCode').textContent=currentTasting.code;
    document.getElementById('manageParticipantsList').innerHTML=currentTasting.participants.map((p,i)=>{
        let actions='';
        if(currentUser.isHost&&!p.isHost){
            actions=`<div class="participant-actions"><button onclick="promoteToHost(${i})">üëë</button><button class="btn-kick" onclick="kickParticipant(${i})">‚úï</button></div>`;
        }
        return `<div class="participant"><div class="participant-avatar">${p.name[0].toUpperCase()}</div><div class="participant-info"><strong style="font-size:0.9rem;">${p.name}</strong>${p.isHost?'<span style="color:var(--primary);margin-left:0.5rem;font-weight:500;font-size:0.75rem;">‚Ä¢ Anfitri√≥n</span>':''}</div>${actions}</div>`;
    }).join('');
}

// ===== SCANNER =====
function openScanner(){
    scannerTargetScreen=document.getElementById('editCataScreen').classList.contains('active')?'editCataScreen':'addProductsScreen';
    const modal=document.getElementById('scannerModal');modal.classList.add('active');
    document.getElementById('scannerStatus').textContent='Iniciando c√°mara...';
    if(html5QrCode){try{html5QrCode.stop();}catch(e){} html5QrCode=null;}
    document.getElementById('reader').innerHTML='';
    html5QrCode=new Html5Qrcode("reader",{verbose:false});
    Html5Qrcode.getCameras().then(function(cameras){
        if(!cameras||!cameras.length){document.getElementById('scannerStatus').textContent='No se encontr√≥ c√°mara';return;}
        let cameraId=cameras.length>1?cameras[cameras.length-1].id:cameras[0].id;
        document.getElementById('scannerStatus').textContent='Enfoca el c√≥digo de barras...';
        html5QrCode.start(cameraId,{fps:10,qrbox:{width:220,height:220}},
            function onDecode(text){
                document.getElementById('scannerStatus').textContent='C√≥digo detectado';
                html5QrCode.stop().then(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);}).catch(function(){html5QrCode=null;modal.classList.remove('active');searchProductByBarcode(text);});
            },
            function onError(){}
        ).catch(function(err){document.getElementById('scannerStatus').textContent='Error al abrir c√°mara.';});
    }).catch(function(){document.getElementById('scannerStatus').textContent='Error al detectar c√°maras.';});
}
function closeScanner(){if(html5QrCode){html5QrCode.stop().catch(function(){});html5QrCode=null;}document.getElementById('reader').innerHTML='';document.getElementById('scannerModal').classList.remove('active');}
async function searchProductByBarcode(barcode){
    try{
        const res=await fetch('https://world.openfoodfacts.org/api/v0/product/'+barcode+'.json');
        const data=await res.json();
        if(data.status===1&&data.product){
            const p=data.product;const product={name:p.product_name||'Producto sin nombre',brand:p.brands||'Marca desconocida',image:p.image_url||''};
            if(scannerTargetScreen==='editCataScreen')addProductFromEdit(product);else addProduct(product);
        } else alert('Producto no encontrado. A√±√°delo manualmente.');
    }catch(e){alert('Error al buscar. Comprueba tu conexi√≥n.');}
}

// ===== PRODUCT SEARCH =====
async function searchProducts(){
    const q=document.getElementById('productSearch').value.trim();
    if(q.length<3){document.getElementById('searchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('searchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProduct('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('searchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}
async function searchProductsEdit(){
    const q=document.getElementById('editProductSearch').value.trim();
    if(q.length<3){document.getElementById('editSearchResults').innerHTML='';return;}
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(async function(){
        try{
            const res=await fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms='+encodeURIComponent(q)+'&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url');
            const data=await res.json();const div=document.getElementById('editSearchResults');
            if(data.products&&data.products.length){
                const unique=deduplicateProducts(data.products);
                div.innerHTML=unique.slice(0,10).map(function(p){
                    const obj=JSON.stringify({name:p.product_name||'Sin nombre',brand:p.brands||'Sin marca',image:p.image_url||''}).replace(/'/g,"&apos;");
                    return '<div class="search-result-item" onclick=\'addProductFromEdit('+obj+')\'>  <img src="'+(p.image_url||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+(p.product_name||'Sin nombre')+'</strong><p>'+(p.brands||'Sin marca')+'</p></div></div>';
                }).join('');
            } else div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }catch(e){document.getElementById('editSearchResults').innerHTML='<p style="text-align:center;color:var(--error);padding:1.5rem;">Error al buscar</p>';}
    },300);
}

function toggleManualForm(){const f=document.getElementById('manualProductForm');f.style.display=f.style.display==='none'?'block':'none';}
function toggleManualFormEdit(){const f=document.getElementById('manualProductFormEdit');f.style.display=f.style.display==='none'?'block':'none';}
function addManualProduct(){const n=document.getElementById('manualProductName').value.trim(),b=document.getElementById('manualProductBrand').value.trim(),img=document.getElementById('manualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProduct({name:n,brand:b,image:img});document.getElementById('manualProductName').value='';document.getElementById('manualProductBrand').value='';document.getElementById('manualProductImage').value='';toggleManualForm();}
function addManualProductEdit(){const n=document.getElementById('editManualProductName').value.trim(),b=document.getElementById('editManualProductBrand').value.trim(),img=document.getElementById('editManualProductImage').value.trim();if(!n||!b){alert('Completa nombre y marca');return;}addProductFromEdit({name:n,brand:b,image:img});document.getElementById('editManualProductName').value='';document.getElementById('editManualProductBrand').value='';document.getElementById('editManualProductImage').value='';toggleManualFormEdit();}

// ===== TABS =====
function switchProductTab(tab){
    const tabs=document.querySelectorAll('.tab');
    tabs.forEach(t=>t.classList.remove('active'));
    if(tab==='supermarket'){
        tabs[0].classList.add('active');
        document.getElementById('supermarketTab').style.display='block';
        document.getElementById('restaurantTab').style.display='none';
    } else {
        tabs[1].classList.add('active');
        document.getElementById('supermarketTab').style.display='none';
        document.getElementById('restaurantTab').style.display='block';
    }
}

// ===== RESTAURANTES =====
const RESTAURANT_DATA={
    "McDonald's":[
        {name:"Big Mac",brand:"McDonald's",image:"https://images.unsplash.com/photo-1550547660-d9450f859349?w=400"},
        {name:"Quarter Pounder",brand:"McDonald's",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"McChicken",brand:"McDonald's",image:"https://images.unsplash.com/photo-1606755962773-d324e0a13086?w=400"},
        {name:"Filet-O-Fish",brand:"McDonald's",image:"https://images.unsplash.com/photo-1580217593608-61931cefc821?w=400"},
        {name:"McNuggets 6 pcs",brand:"McDonald's",image:"https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
        {name:"McNuggets 9 pcs",brand:"McDonald's",image:"https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
        {name:"Patatas Medianas",brand:"McDonald's",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Patatas Grandes",brand:"McDonald's",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"McFlurry Oreo",brand:"McDonald's",image:"https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400"},
        {name:"McFlurry KitKat",brand:"McDonald's",image:"https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400"},
        {name:"Sundae Caramelo",brand:"McDonald's",image:"https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400"},
        {name:"Big Tasty",brand:"McDonald's",image:"https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=400"},
        {name:"McPollo",brand:"McDonald's",image:"https://images.unsplash.com/photo-1606755962773-d324e0a13086?w=400"},
        {name:"Happy Meal",brand:"McDonald's",image:"https://images.unsplash.com/photo-1619221882005-6801e8e4d1ff?w=400"},
        {name:"Coca Cola",brand:"McDonald's",image:"https://images.unsplash.com/photo-1554866585-cd94860890b7?w=400"}
    ],
    "Burger King":[
        {name:"Whopper",brand:"Burger King",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Whopper Cheese",brand:"Burger King",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Double Whopper",brand:"Burger King",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Bacon King",brand:"Burger King",image:"https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=400"},
        {name:"Long Chicken",brand:"Burger King",image:"https://images.unsplash.com/photo-1513639776629-7b61b0ac49cb?w=400"},
        {name:"Chicken Royale",brand:"Burger King",image:"https://images.unsplash.com/photo-1513639776629-7b61b0ac49cb?w=400"},
        {name:"Nuggets 6 uds",brand:"Burger King",image:"https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
        {name:"Nuggets 9 uds",brand:"Burger King",image:"https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
        {name:"Onion Rings",brand:"Burger King",image:"https://images.unsplash.com/photo-1639024471283-03518883512d?w=400"},
        {name:"Patatas Medianas",brand:"Burger King",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Patatas Grandes",brand:"Burger King",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Sundae Chocolate",brand:"Burger King",image:"https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400"},
        {name:"King Fusion Oreo",brand:"Burger King",image:"https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=400"},
        {name:"Steakhouse",brand:"Burger King",image:"https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=400"}
    ],
    "KFC":[
        {name:"Bucket 6 Piezas",brand:"KFC",image:"https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?w=400"},
        {name:"Bucket 9 Piezas",brand:"KFC",image:"https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?w=400"},
        {name:"Bucket 14 Piezas",brand:"KFC",image:"https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?w=400"},
        {name:"Tiras de Pollo 3 uds",brand:"KFC",image:"https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400"},
        {name:"Hot Wings 6 uds",brand:"KFC",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"},
        {name:"Hot Wings 9 uds",brand:"KFC",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"},
        {name:"Twister",brand:"KFC",image:"https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400"},
        {name:"Zinger",brand:"KFC",image:"https://images.unsplash.com/photo-1606755962773-d324e0a13086?w=400"},
        {name:"Tower Burger",brand:"KFC",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Ensalada Coleslaw",brand:"KFC",image:"https://images.unsplash.com/photo-1505253716362-afaea1d3d1af?w=400"},
        {name:"Patatas Caj√∫n",brand:"KFC",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Pur√© de Patata",brand:"KFC",image:"https://images.unsplash.com/photo-1542128962-5d1b5f1b3021?w=400"},
        {name:"Mazorca de Ma√≠z",brand:"KFC",image:"https://images.unsplash.com/photo-1551462147-37efe4be5eda?w=400"}
    ],
    "Domino's Pizza":[
        {name:"Pizza Barbacoa",brand:"Domino's",image:"https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400"},
        {name:"Pizza Carbonara",brand:"Domino's",image:"https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400"},
        {name:"Pizza 4 Quesos",brand:"Domino's",image:"https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?w=400"},
        {name:"Pizza Margarita",brand:"Domino's",image:"https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400"},
        {name:"Pizza Pepperoni",brand:"Domino's",image:"https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400"},
        {name:"Pizza Hawaiana",brand:"Domino's",image:"https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400"},
        {name:"Pizza Vegetal",brand:"Domino's",image:"https://images.unsplash.com/photo-1571407970349-bc81e7e96a47?w=400"},
        {name:"Alitas Picantes 8 uds",brand:"Domino's",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"},
        {name:"Alitas BBQ 8 uds",brand:"Domino's",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"},
        {name:"Palitos de Pan",brand:"Domino's",image:"https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=400"},
        {name:"Nuggets de Pollo",brand:"Domino's",image:"https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
        {name:"Patatas Deluxe",brand:"Domino's",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Lava Cake Chocolate",brand:"Domino's",image:"https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400"}
    ],
    "Telepizza":[
        {name:"Pizza Barbacoa",brand:"Telepizza",image:"https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400"},
        {name:"Pizza Carbonara",brand:"Telepizza",image:"https://images.unsplash.com/photo-1571407970349-bc81e7e96a47?w=400"},
        {name:"Pizza 4 Estaciones",brand:"Telepizza",image:"https://images.unsplash.com/photo-1595708684082-a173bb3a06c5?w=400"},
        {name:"Pizza Prosciutto",brand:"Telepizza",image:"https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400"},
        {name:"Pizza Pepperoni",brand:"Telepizza",image:"https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400"},
        {name:"Pizza Margarita",brand:"Telepizza",image:"https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400"},
        {name:"Pizza Vegetal",brand:"Telepizza",image:"https://images.unsplash.com/photo-1571407970349-bc81e7e96a47?w=400"},
        {name:"Alitas de Pollo",brand:"Telepizza",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"},
        {name:"Fingers de Pollo",brand:"Telepizza",image:"https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400"},
        {name:"Pan de Ajo",brand:"Telepizza",image:"https://images.unsplash.com/photo-1573166953836-06864dc70a21?w=400"},
        {name:"Patatas Gajo",brand:"Telepizza",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Teque√±os",brand:"Telepizza",image:"https://images.unsplash.com/photo-1530910082036-25ff0992a0c5?w=400"}
    ],
    "Subway":[
        {name:"Sub Italiano B.M.T.",brand:"Subway",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Sub Pollo Teriyaki",brand:"Subway",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Sub At√∫n",brand:"Subway",image:"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400"},
        {name:"Sub Pavo",brand:"Subway",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Sub Vegetal",brand:"Subway",image:"https://images.unsplash.com/photo-1587487518314-9fca9e8f4f8d?w=400"},
        {name:"Sub Steak & Cheese",brand:"Subway",image:"https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400"},
        {name:"Sub Pulled Pork",brand:"Subway",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Cookie Chocolate Chip",brand:"Subway",image:"https://images.unsplash.com/photo-1499636136210-6f4ee915583e?w=400"},
        {name:"Cookie Double Chocolate",brand:"Subway",image:"https://images.unsplash.com/photo-1499636136210-6f4ee915583e?w=400"},
        {name:"Wrap Pollo Caesar",brand:"Subway",image:"https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400"},
        {name:"Patatas Fritas",brand:"Subway",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"}
    ],
    "Taco Bell":[
        {name:"Crunchy Taco",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400"},
        {name:"Soft Taco",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400"},
        {name:"Burrito Supreme",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400"},
        {name:"Burrito 7 Capas",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400"},
        {name:"Quesadilla Pollo",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1571804258955-7b32160d5b25?w=400"},
        {name:"Quesadilla Carne",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1571804258955-7b32160d5b25?w=400"},
        {name:"Nachos Supreme",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1513456852971-30c0b8199d4d?w=400"},
        {name:"Nachos BellGrande",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1513456852971-30c0b8199d4d?w=400"},
        {name:"Crunchwrap Supreme",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400"},
        {name:"Chalupa Supreme",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400"},
        {name:"Gordita Crunch",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400"},
        {name:"Fries Supreme",brand:"Taco Bell",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"}
    ],
    "Starbucks":[
        {name:"Cappuccino",brand:"Starbucks",image:"https://images.unsplash.com/photo-1572442388796-11668a67e53d?w=400"},
        {name:"Latte",brand:"Starbucks",image:"https://images.unsplash.com/photo-1461023058943-07fcbe16d735?w=400"},
        {name:"Americano",brand:"Starbucks",image:"https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?w=400"},
        {name:"Caramel Macchiato",brand:"Starbucks",image:"https://images.unsplash.com/photo-1572442388796-11668a67e53d?w=400"},
        {name:"Frappuccino Caramelo",brand:"Starbucks",image:"https://images.unsplash.com/photo-1572490122747-3968b75cc699?w=400"},
        {name:"Frappuccino Mocha",brand:"Starbucks",image:"https://images.unsplash.com/photo-1572490122747-3968b75cc699?w=400"},
        {name:"Croissant Mantequilla",brand:"Starbucks",image:"https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400"},
        {name:"Muffin Chocolate",brand:"Starbucks",image:"https://images.unsplash.com/photo-1607958996333-41aef7caefaa?w=400"},
        {name:"Sandwich Pollo",brand:"Starbucks",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Brownie",brand:"Starbucks",image:"https://images.unsplash.com/photo-1606313564200-e75d5e30476c?w=400"}
    ],
    "100 Montaditos":[
        {name:"Montadito Lomo",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Montadito Tortilla",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Montadito Jam√≥n",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Montadito Bacon Cheese",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Patatas Bravas",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400"},
        {name:"Cerveza Estrella",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1535958636474-b021ee887b13?w=400"},
        {name:"Nachos con Queso",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1513456852971-30c0b8199d4d?w=400"},
        {name:"Alitas de Pollo",brand:"100 Montaditos",image:"https://images.unsplash.com/photo-1608039829572-78524f79c4c7?w=400"}
    ],
    "Rodilla":[
        {name:"Bocadillo Jam√≥n Serrano",brand:"Rodilla",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Bocadillo Pavo",brand:"Rodilla",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Bocadillo Tortilla",brand:"Rodilla",image:"https://images.unsplash.com/photo-1509722747041-616f39b57569?w=400"},
        {name:"Croissant Mixto",brand:"Rodilla",image:"https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400"},
        {name:"Ensalada C√©sar",brand:"Rodilla",image:"https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400"},
        {name:"Caf√© con Leche",brand:"Rodilla",image:"https://images.unsplash.com/photo-1461023058943-07fcbe16d735?w=400"},
        {name:"Zumo Natural Naranja",brand:"Rodilla",image:"https://images.unsplash.com/photo-1600271886742-f049cd451bba?w=400"}
    ]
};

let restaurantTimeout=null;
function searchRestaurants(){
    const q=document.getElementById('restaurantSearch').value.trim().toLowerCase();
    if(q.length<2){document.getElementById('restaurantResults').innerHTML='';return;}
    clearTimeout(restaurantTimeout);
    restaurantTimeout=setTimeout(function(){
        const results=[];
        Object.keys(RESTAURANT_DATA).forEach(function(brand){
            RESTAURANT_DATA[brand].forEach(function(item){
                if(item.name.toLowerCase().includes(q) || brand.toLowerCase().includes(q)){
                    results.push(item);
                }
            });
        });
        const div=document.getElementById('restaurantResults');
        if(results.length){
            div.innerHTML=results.slice(0,10).map(function(p){
                const obj=JSON.stringify(p).replace(/'/g,"&apos;");
                return '<div class="search-result-item" onclick=\'addProduct('+obj+')\'><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><strong>'+p.name+'</strong><p>'+p.brand+'</p></div></div>';
            }).join('');
        } else {
            div.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:1.5rem;">No se encontraron productos</p>';
        }
    },300);
}

function toggleManualFormRestaurant(){
    const f=document.getElementById('manualRestaurantForm');
    f.style.display=f.style.display==='none'?'block':'none';
}

function addManualRestaurant(){
    const n=document.getElementById('manualRestaurantName').value.trim();
    const b=document.getElementById('manualRestaurantBrand').value.trim();
    const img=document.getElementById('manualRestaurantImage').value.trim();
    if(!n||!b){alert('Completa nombre y restaurante');return;}
    addProduct({name:n,brand:b,image:img});
    document.getElementById('manualRestaurantName').value='';
    document.getElementById('manualRestaurantBrand').value='';
    document.getElementById('manualRestaurantImage').value='';
    toggleManualFormRestaurant();
}

function addProduct(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});saveTasting();updateAddedProducts();document.getElementById('productSearch').value='';document.getElementById('searchResults').innerHTML='';}
function addProductFromEdit(product){if(currentTasting.products.find(p=>p.name===product.name&&p.brand===product.brand))return;currentTasting.products.push({id:Date.now().toString(),...product});saveTasting();updateEditProductsList();document.getElementById('editProductSearch').value='';document.getElementById('editSearchResults').innerHTML='';}

function updateAddedProducts(){
    const c=document.getElementById('addedProducts');document.getElementById('productCount').textContent=currentTasting.products.length;
    if(!currentTasting.products.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üì¶</div><p>A√∫n no hay productos</p></div>';return;}
    c.innerHTML=currentTasting.products.map(function(p,i){return '<div class="product-item" data-id="'+p.id+'"><div class="drag-handle">‚ãÆ‚ãÆ</div><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p></div><button onclick="removeProduct('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;">‚úï</button></div>';}).join('');
    // Init Sortable for drag & drop
    if(sortableInstances.addedProducts) sortableInstances.addedProducts.destroy();
    sortableInstances.addedProducts = new Sortable(c, {
        handle: '.drag-handle',
        animation: 200,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
        ghostClass: 'ghost',
        dragClass: 'dragging',
        forceFallback: true,
        fallbackTolerance: 3,
        onEnd: function(evt) {
            const item = currentTasting.products.splice(evt.oldIndex, 1)[0];
            currentTasting.products.splice(evt.newIndex, 0, item);
            saveTasting();
        }
    });
}
function removeProduct(i){currentTasting.products.splice(i,1);saveTasting();updateAddedProducts();}
function finishAddingProducts(){if(!currentTasting.products.length){alert('A√±ade al menos un producto');return;}currentTasting.status='voting';saveTasting();showProductSelectionScreen();}

// ===== VOTING =====
function showProductSelectionScreen(){
    updateProductSelectionList();
    document.getElementById('editBtn').style.display=currentUser.isHost?'inline-flex':'none';
    showScreen('productSelectionScreen');
}
function updateProductSelectionList(){
    const c=document.getElementById('productSelectionList');
    document.getElementById('votedProductsCount').textContent=Object.keys(userVotes).length;
    document.getElementById('totalProductsCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p){
        const voted=userVotes[p.id];
        return '<div class="product-item '+(voted?'selected':'')+'" onclick="'+(voted?'':'selectProduct(\''+p.id+'\')')+'" style="'+(voted?'cursor:default;opacity:0.6;':'')+'" ><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p></div>'+(voted?'<span style="color:var(--success);font-weight:600;font-size:0.9rem;flex-shrink:0;">‚úì</span>':'')+' </div>';
    }).join('');
}
function selectProduct(id){selectedProductId=id;showVotingScreen();}
function updateRatingValue(){document.getElementById('ratingValue').textContent=parseFloat(document.getElementById('ratingSlider').value).toFixed(1);}
function showVotingScreen(){
    const p=currentTasting.products.find(function(x){return x.id===selectedProductId;});if(!p)return;
    document.getElementById('votingProductName').textContent=p.name;
    document.getElementById('votingProductBrand').textContent=p.brand;
    document.getElementById('votingProductImage').src=p.image||'';
    document.getElementById('ratingSlider').value=5.0;updateRatingValue();document.getElementById('voteComment').value='';
    updateVoteCount(); showScreen('votingScreen');
}
function submitVote(){
    const score=parseFloat(document.getElementById('ratingSlider').value);
    const comment=document.getElementById('voteComment').value.trim();
    const product=currentTasting.products.find(function(p){return p.id===selectedProductId;});
    if(!currentTasting.votes[selectedProductId])currentTasting.votes[selectedProductId]=[];
    currentTasting.votes[selectedProductId]=currentTasting.votes[selectedProductId].filter(function(v){return v.user!==currentUser.name;});
    currentTasting.votes[selectedProductId].push({user:currentUser.name,score:score,comment:comment});
    userVotes[selectedProductId]=true;
    updateGlobalRanking(product.name,product.brand,product.image,score);
    saveTasting(); showProductSelectionScreen();
}
function updateVoteCount(){const votes=currentTasting.votes[selectedProductId]||[];document.getElementById('votedCount').textContent=votes.length;document.getElementById('votedTotal').textContent=currentTasting.participants.length;}

// ===== EDIT MODE =====
function showEditMode(){if(!currentUser.isHost){alert('Solo el anfitri√≥n puede editar');return;}updateEditProductsList();showScreen('editCataScreen');}
function updateEditProductsList(){
    const c=document.getElementById('editProductsList');document.getElementById('editProductCount').textContent=currentTasting.products.length;
    c.innerHTML=currentTasting.products.map(function(p,i){
        const hasVotes=currentTasting.votes[p.id]&&currentTasting.votes[p.id].length>0;
        return '<div class="product-item" data-id="'+p.id+'"><div class="drag-handle">‚ãÆ‚ãÆ</div><img src="'+(p.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div class="product-info"><h4>'+p.name+'</h4><p>'+p.brand+'</p>'+(hasVotes?'<p style="color:var(--success);font-size:0.72rem;margin-top:0.15rem;">‚úì '+currentTasting.votes[p.id].length+' votos</p>':'')+' </div><button onclick="removeProductFromEdit('+i+')" class="btn btn-small" style="background:var(--error);color:white;border-color:var(--error);width:auto;flex-shrink:0;" '+(hasVotes?'disabled style="opacity:0.4;cursor:not-allowed;"':'')+'>‚úï</button></div>';
    }).join('');
    // Init Sortable for drag & drop
    if(sortableInstances.editProductsList) sortableInstances.editProductsList.destroy();
    sortableInstances.editProductsList = new Sortable(c, {
        handle: '.drag-handle',
        animation: 200,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
        ghostClass: 'ghost',
        dragClass: 'dragging',
        forceFallback: true,
        fallbackTolerance: 3,
        onEnd: function(evt) {
            const item = currentTasting.products.splice(evt.oldIndex, 1)[0];
            currentTasting.products.splice(evt.newIndex, 0, item);
            saveTasting();
        }
    });
}
function removeProductFromEdit(i){const p=currentTasting.products[i];if(currentTasting.votes[p.id]&&currentTasting.votes[p.id].length){alert('No puedes eliminar un producto con votos');return;}currentTasting.products.splice(i,1);saveTasting();updateEditProductsList();}
function exitEditMode(){showProductSelectionScreen();}

// ===== RESULTS =====
function showResults(){
    currentTasting.status='finished';saveTasting();
    const c=document.getElementById('resultsContainer');
    c.innerHTML=currentTasting.products.map(function(product){
        const votes=currentTasting.votes[product.id]||[];const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        return '<div class="result-card"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="'+(product.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">'+product.name+'</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">'+product.brand+'</p></div></div><div class="avg-score">'+avg.toFixed(1)+'</div>'+(votes.length?'<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>'+votes.map(function(v){return '<div class="rating-result"><div><strong style="font-size:0.875rem;">'+v.user+'</strong>'+(v.comment?'<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">'+v.comment+'</p>':'')+' </div><div class="rating-score">'+v.score.toFixed(1)+'</div></div>';}).join(''):'<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>')+'</div>';
    }).join('');
    showScreen('resultsScreen');
}
function finishTasting(){archiveTasting();currentTasting=null;currentUser=null;userVotes={};showScreen('homeScreen');}

// ===== PERSISTENCE =====
function saveTasting(){const t=JSON.parse(localStorage.getItem('tastings')||'{}');t[currentTasting.code]=currentTasting;localStorage.setItem('tastings',JSON.stringify(t));}
function loadTastingByCode(code){return JSON.parse(localStorage.getItem('tastings')||'{}')[code];}
function archiveTasting(){const a=JSON.parse(localStorage.getItem('archivedTastings')||'[]');a.unshift({...currentTasting,archivedAt:new Date().toISOString()});localStorage.setItem('archivedTastings',JSON.stringify(a));}

function loadArchivedTastings(){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    const c=document.getElementById('archivedList');
    if(!archived.length){c.innerHTML='<div class="empty-state" style="padding:1.5rem 0;"><div class="icon">üìã</div><p>No tienes catas archivadas</p></div>';return;}
    c.innerHTML=archived.map(function(t,i){
        return '<div class="archive-item"><div class="archive-icon" onclick="viewArchive('+i+')"><img src="'+MASCOT_WAITING_URL+'" alt=""></div><div class="archive-content" onclick="viewArchive('+i+')"><h3>'+t.name+'</h3><div class="archive-meta"><span>üìÖ '+new Date(t.archivedAt).toLocaleDateString('es-ES')+'</span><span>üë• '+t.participants.length+' part.</span><span>üçΩÔ∏è '+t.products.length+' prod.</span></div></div><button class="archive-delete" onclick="deleteArchive('+i+',event)" title="Eliminar">üóëÔ∏è</button></div>';
    }).join('');
}
function deleteArchive(i,event){
    event.stopPropagation();
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');
    if(confirm('¬øEliminar la cata "'+archived[i].name+'"? No se puede recuperar.')){
        archived.splice(i,1);
        localStorage.setItem('archivedTastings',JSON.stringify(archived));
        loadArchivedTastings();
    }
}
function viewArchive(i){viewArchiveFromIndex(i);}
function viewArchiveFromIndex(i){
    const archived=JSON.parse(localStorage.getItem('archivedTastings')||'[]');const t=archived[i];
    document.getElementById('archiveTastingName').textContent=t.name;
    document.getElementById('archiveDate').textContent='Finalizada el '+new Date(t.archivedAt).toLocaleDateString('es-ES');
    const c=document.getElementById('archiveResults');
    c.innerHTML=t.products.map(function(product){
        const votes=t.votes[product.id]||[];const avg=votes.length?votes.reduce(function(s,v){return s+v.score;},0)/votes.length:0;
        return '<div class="result-card"><div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;"><img src="'+(product.image||'')+'" class="product-image" onerror="this.style.display=\'none\'"><div><h3 style="margin:0 0 0.15rem;">'+product.name+'</h3><p style="color:var(--text-secondary);margin:0;font-size:0.825rem;">'+product.brand+'</p></div></div><div class="avg-score">'+avg.toFixed(1)+'</div>'+(votes.length?'<h4 style="margin:0.75rem 0 0.5rem;font-size:0.825rem;font-weight:600;">Puntuaciones</h4>'+votes.map(function(v){return '<div class="rating-result"><div><strong style="font-size:0.875rem;">'+v.user+'</strong>'+(v.comment?'<p style="font-size:0.775rem;color:var(--text-secondary);margin-top:0.15rem;">'+v.comment+'</p>':'')+' </div><div class="rating-score">'+v.score.toFixed(1)+'</div></div>';}).join(''):'<p style="text-align:center;color:var(--text-secondary);padding:0.75rem;">Sin votos</p>')+'</div>';
    }).join('');
    showScreen('archiveScreen');
}

// ===== PROFILE MANAGEMENT =====
async function loadProfileData(){
    if(!authenticatedUser)return;
    document.getElementById('profileName').textContent=authenticatedUser.name;
    document.getElementById('profileEmail').textContent=authenticatedUser.email;
    const {data:profile} = await supabaseClient.from('profiles').select('avatar').eq('id',authenticatedUser.id).single();
    const avatarKey = profile?.avatar || 'panda_normal';
    const avatarImg = PANDA_AVATARS[avatarKey] || PANDA_AVATARS.panda_normal;
    document.getElementById('profileAvatarBig').innerHTML='<img src="'+avatarImg+'" style="width:100%;height:100%;object-fit:cover;">';
    document.getElementById('avatar_panda_normal').src=PANDA_AVATARS.panda_normal;
    document.getElementById('avatar_panda_eating').src=PANDA_AVATARS.panda_eating;
    document.getElementById('avatar_panda_waiting').src=PANDA_AVATARS.panda_waiting;
    document.getElementById('avatar_panda_head').src=PANDA_AVATARS.panda_head;
}

function showEditProfile(){
    document.getElementById('editProfileName').value=authenticatedUser.name;
    document.getElementById('editProfileEmail').value=authenticatedUser.email;
    document.getElementById('editProfilePassword').value='';
    showScreen('editProfileScreen');
}

async function saveProfileChanges(){
    const newName=document.getElementById('editProfileName').value.trim();
    const newEmail=document.getElementById('editProfileEmail').value.trim();
    const newPassword=document.getElementById('editProfilePassword').value.trim();
    if(!newName||!newEmail){alert('Nombre y email son obligatorios');return;}
    
    try{
        await supabaseClient.from('profiles').update({name:newName,email:newEmail}).eq('id',authenticatedUser.id);
        authenticatedUser.name=newName;
        
        if(newEmail!==authenticatedUser.email){
            const {error:emailError} = await supabaseClient.auth.updateUser({email:newEmail});
            if(emailError) alert('Error al cambiar email: '+emailError.message);
            else alert('Se ha enviado un email de confirmaci√≥n a la nueva direcci√≥n');
        }
        
        if(newPassword){
            if(newPassword.length<6){alert('La contrase√±a debe tener al menos 6 caracteres');return;}
            const {error:pwError} = await supabaseClient.auth.updateUser({password:newPassword});
            if(pwError){alert('Error al cambiar contrase√±a: '+pwError.message);return;}
        }
        
        alert('‚úì Perfil actualizado');
        showScreen('profileScreen');
        loadProfileData();
    }catch(e){
        alert('Error al guardar cambios: '+e.message);
    }
}

function showAvatarSelector(){
    document.getElementById('avatarSelectorModal').style.display='flex';
}

function closeAvatarSelector(){
    document.getElementById('avatarSelectorModal').style.display='none';
}

async function selectAvatar(avatarKey){
    await supabaseClient.from('profiles').update({avatar:avatarKey}).eq('id',authenticatedUser.id);
    closeAvatarSelector();
    loadProfileData();
}

async function deleteAccount(){
    if(!confirm('¬øEst√°s seguro de que quieres eliminar tu cuenta?\\n\\nEsta acci√≥n NO se puede deshacer.'))return;
    if(!confirm('√öltima confirmaci√≥n: ¬øEliminar cuenta permanentemente?'))return;
    
    try{
        await supabaseClient.from('profiles').delete().eq('id',authenticatedUser.id);
        await supabaseClient.rpc('delete_user');
        await logout();
        alert('Tu cuenta ha sido eliminada');
    }catch(e){
        alert('Cuenta eliminada de la app. Para eliminarla completamente, contacta con soporte.');
        await logout();
    }
}

// ===== INIT =====
initApp();

// ===== PWA =====
if('serviceWorker' in navigator){window.addEventListener('load',function(){navigator.serviceWorker.register('sw.js').catch(function(){});});}
let deferredPrompt=null;
const installBanner=document.getElementById('installBanner');
window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredPrompt=e;if(!sessionStorage.getItem('pwa-banner-dismissed'))installBanner.style.display='block';});
document.getElementById('installBtn').addEventListener('click',async function(){if(deferredPrompt){installBanner.style.display='none';deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}});
document.getElementById('dismissBanner').addEventListener('click',function(){installBanner.style.display='none';sessionStorage.setItem('pwa-banner-dismissed','true');});
document.getElementById('closeIosModal').addEventListener('click',function(){document.getElementById('iosModal').style.display='none';});
window.addEventListener('load',function(){if(/iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.matchMedia('(display-mode: standalone)').matches&&!sessionStorage.getItem('pwa-banner-dismissed'))setTimeout(function(){document.getElementById('iosModal').style.display='flex';},2000);});
</script>
</body>
</html>
